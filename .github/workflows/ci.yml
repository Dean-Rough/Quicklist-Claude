name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Run Prettier check
        run: npm run format:check
        continue-on-error: false

      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: false

      - name: Check for known vulnerabilities
        run: |
          echo "Checking npm packages for known vulnerabilities..."
          npm audit --audit-level=high --json > audit-results.json || true

          # Check if there are critical or high vulnerabilities
          CRITICAL=$(cat audit-results.json | grep -o '"severity":"critical"' | wc -l)
          HIGH=$(cat audit-results.json | grep -o '"severity":"high"' | wc -l)

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            cat audit-results.json
            exit 1
          else
            echo "No critical or high severity vulnerabilities found"
          fi

      - name: Verify build script exists
        run: |
          if [ -f "vercel-build.sh" ]; then
            echo "Build script found"
            bash vercel-build.sh
          else
            echo "No build script found, skipping build verification"
          fi

  dependency-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Verify package-lock.json is up to date
        run: |
          npm ci
          git diff --exit-code package-lock.json || (echo "package-lock.json is out of date. Run 'npm install' locally and commit the changes." && exit 1)

  code-quality-report:
    runs-on: ubuntu-latest
    needs: [quality-checks, dependency-check]
    if: always()

    steps:
      - name: Check job status
        run: |
          echo "Quality Checks Status: ${{ needs.quality-checks.result }}"
          echo "Dependency Check Status: ${{ needs.dependency-check.result }}"

          if [ "${{ needs.quality-checks.result }}" != "success" ] || [ "${{ needs.dependency-check.result }}" != "success" ]; then
            echo "One or more checks failed. Please review the logs above."
            exit 1
          fi
