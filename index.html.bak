<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary SEO Meta Tags -->
    <title>QuickList AI - AI-Powered Product Listing Generator for Vinted, eBay & Gumtree</title>
    <meta name="title" content="QuickList AI - AI-Powered Product Listing Generator for Vinted, eBay & Gumtree">
    <meta name="description" content="Turn your clutter into cash with AI-powered listing generation. Upload photos, get professional descriptions, pricing, and keywords. Works with Vinted, eBay, and Gumtree. Free to start.">
    <meta name="keywords" content="AI listing generator, Vinted listing tool, eBay listing generator, Gumtree listing, product description AI, marketplace listing tool, resale listing generator, UK marketplace tools">
    <meta name="author" content="QuickList AI">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://quicklist.ai/">
    <meta property="og:title" content="QuickList AI - Turn Clutter into Cash with AI">
    <meta property="og:description" content="AI-powered product listing generator for Vinted, eBay, and Gumtree. Upload photos, get professional listings in seconds. Free to start.">
    <meta property="og:image" content="https://quicklist.ai/hero-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="QuickList AI">
    <meta property="og:locale" content="en_GB">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://quicklist.ai/">
    <meta property="twitter:title" content="QuickList AI - AI-Powered Listing Generator">
    <meta property="twitter:description" content="Turn your clutter into cash. AI generates professional listings for Vinted, eBay, and Gumtree from photos. Free to start.">
    <meta property="twitter:image" content="https://quicklist.ai/hero-image.jpg">
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QuickList">
    <link rel="canonical" href="https://quicklist.ai/">

    <!-- PWA Configuration -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-152.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-TileImage" content="/icons/icon-144.png">
    
    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "QuickList AI",
        "applicationCategory": "BusinessApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "GBP"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "127"
        },
        "description": "AI-powered product listing generator that creates professional marketplace listings from photos. Supports Vinted, eBay, and Gumtree.",
        "featureList": [
            "AI-Powered Descriptions",
            "Optimized Titles & Categories",
            "Data-Driven Pricing",
            "Professional Image Enhancement",
            "Stock Image Finder",
            "Multi-Platform Support"
        ]
    }
    </script>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "QuickList AI",
        "url": "https://quicklist.ai/",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://quicklist.ai/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --accent-indigo: #6366f1;
            --accent-indigo-hover: #4f46e5;
            --accent-indigo-light: rgba(99, 102, 241, 0.1);
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-indigo);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-indigo), #818cf8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--accent-indigo);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--accent-indigo);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-indigo-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Hero Section */
        .hero {
            padding: 0;
            position: relative;
            min-height: 90vh;
            display: flex;
            align-items: center;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml,<svg width="1920" height="1080" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23f1f5f9;stop-opacity:0.05" /><stop offset="100%" style="stop-color:%236366f1;stop-opacity:0.1" /></linearGradient></defs><rect width="100%" height="100%" fill="url(%23grad)"/></svg>');
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: 0;
        }

        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 4rem 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            align-items: center;
        }

        .hero-text {
            text-align: left;
        }

        .hero-image-container {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            aspect-ratio: 4/3;
        }

        .hero-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-indigo) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.35rem;
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            line-height: 1.7;
            max-width: 600px;
        }

        .hero-cta-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 968px) {
            .hero-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .hero-text {
                text-align: center;
            }
            
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero p {
                font-size: 1.15rem;
            }
            
            .hero-cta-group {
                justify-content: center;
            }
        }

        /* Section */
        .section {
            padding: 4rem 0;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 3rem;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 2rem;
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        /* Card */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-indigo-light);
            color: var(--accent-indigo);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .card h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .card p {
            color: var(--text-secondary);
        }

        /* Steps */
        .steps {
            display: flex;
            justify-content: space-around;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .step {
            text-align: center;
            max-width: 300px;
        }

        .step-image {
            width: 100%;
            max-width: 280px;
            height: 200px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .step-number {
            width: 60px;
            height: 60px;
            background: var(--accent-indigo);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 auto 1rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-hover);
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: 2px solid var(--accent-indigo);
            outline-offset: 2px;
            border-color: var(--accent-indigo);
        }

        /* Focus indicators for all interactive elements */
        button:focus,
        a:focus,
        input:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid var(--accent-indigo);
            outline-offset: 2px;
        }

        button:focus:not(:focus-visible),
        a:focus:not(:focus-visible) {
            outline: none;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--accent-indigo);
            outline-offset: 2px;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        select.form-input {
            cursor: pointer;
            background: var(--bg-primary) !important;
            background-image: none !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        select.form-input::-ms-expand {
            display: none;
        }

        /* Form Validation Styles */
        .form-input:invalid,
        .form-input.error {
            border-color: var(--error);
        }

        .form-input:valid:not(:placeholder-shown) {
            border-color: var(--success);
        }

        .field-error {
            display: block;
            color: var(--error);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .form-input[aria-invalid="true"] {
            border-color: var(--error);
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1);
        }

        /* Footer */
        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 3rem 0;
            margin-top: 4rem;
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        /* App Layout */
        .app-layout {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
            padding: 2rem 0;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        @media (max-width: 968px) {
            .app-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Image Uploader */
        .image-uploader {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-secondary);
        }

        .image-uploader:hover {
            border-color: var(--accent-indigo);
            background: var(--accent-indigo-light);
        }

        .image-uploader-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-thumbnail {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-thumbnail-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 28px;
            height: 28px;
            background: var(--error);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
        }

        .image-thumbnail-delete:hover {
            opacity: 1;
        }

        .image-thumbnail-status {
            position: absolute;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.75rem;
            text-align: center;
        }

        .image-thumbnail-status.warning {
            background: var(--warning);
        }

        /* Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-indigo);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Output Area */
        .output-area {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            min-height: 600px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .output-actions {
            display: flex;
            gap: 0.5rem;
        }

        .field-group {
            margin-bottom: 1.5rem;
        }

        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag {
            background: var(--accent-indigo-light);
            color: var(--accent-indigo);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Sources */
        .sources-list {
            list-style: none;
        }

        .sources-list li {
            margin-bottom: 0.5rem;
        }

        .sources-list a {
            color: var(--accent-indigo);
            text-decoration: none;
        }

        .sources-list a:hover {
            text-decoration: underline;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .toggle-group:last-child {
            border-bottom: none;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-tertiary);
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--accent-indigo);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Saved Items Grid */
        .saved-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .saved-item-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .saved-item-card:hover {
            transform: translateY(-4px);
        }

        .saved-item-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .saved-item-content {
            padding: 1rem;
        }

        .saved-item-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .saved-item-brand {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .saved-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--bg-tertiary) 25%,
                var(--bg-hover) 50%,
                var(--bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 20px;
            margin-bottom: 1rem;
        }

        .skeleton-text-large {
            height: 100px;
        }

        /* Pricing Cards */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .pricing-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .pricing-card.featured {
            border-color: var(--accent-indigo);
            transform: scale(1.05);
        }

        .pricing-tier {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .pricing-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-indigo);
            margin-bottom: 0.5rem;
        }

        .pricing-period {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .pricing-features {
            list-style: none;
            text-align: left;
            margin-bottom: 1.5rem;
        }

        .pricing-features li {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .pricing-features li:last-child {
            border-bottom: none;
        }

        /* Confirmation Modal Grid */
        .confirmation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .confirmation-item {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .confirmation-item:hover {
            border-color: var(--accent-indigo);
        }

        .confirmation-item.selected {
            border-color: var(--accent-indigo);
            background: var(--accent-indigo-light);
        }

        .confirmation-item img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .confirmation-item-title {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .confirmation-item-price {
            font-size: 0.875rem;
            color: var(--accent-indigo);
        }

        /* User Profile Button */
        .user-profile-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-indigo);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-profile-btn:hover {
            background: var(--accent-indigo-hover);
        }

        /* Pricing Intelligence */
        .pricing-intelligence-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 0.5rem;
        }

        .pricing-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .pricing-stat:last-child {
            border-bottom: none;
        }

        .pricing-stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .pricing-stat-value {
            color: var(--accent-indigo);
            font-weight: 600;
        }

        .pricing-recommendation {
            background: var(--accent-indigo-light);
            border-left: 3px solid var(--accent-indigo);
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .pricing-recommendation:hover {
            background: var(--bg-hover);
        }

        .pricing-recommendation-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .pricing-recommendation-desc {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .section-title {
                font-size: 1.75rem;
            }

            .nav-links {
                gap: 1rem;
                font-size: 0.875rem;
            }

            .header-content {
                padding: 1rem;
            }

            .container {
                padding: 0 1rem;
            }

            .steps {
                flex-direction: column;
                align-items: center;
            }

            /* Mobile: Stack app layout */
            .app-layout {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            /* Mobile: Larger touch targets */
            .btn {
                min-height: 44px;
                min-width: 44px;
                padding: 0.875rem 1.25rem;
            }

            /* Mobile: Fix image grid */
            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            /* Mobile: Fix modals */
            .modal-content {
                max-width: 95vw;
                margin: 1rem;
                padding: 1.5rem;
            }

            /* Mobile: Stack grid-2 */
            .grid-2 {
                grid-template-columns: 1fr;
            }

            /* Mobile: Stack grid-3 */
            .grid-3 {
                grid-template-columns: 1fr;
            }

            /* Mobile: Fix hero CTA group */
            .hero-cta-group {
                flex-direction: column;
            }

            .hero-cta-group .btn {
                width: 100%;
            }
        }

        /* Flat Icon Styles */
        .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .icon-camera, .icon-document, .icon-clock, .icon-check, .icon-alert, .icon-refresh {
            position: relative;
        }

        .icon-camera svg, .icon-document svg, .icon-clock svg, .icon-check svg, .icon-alert svg, .icon-refresh svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        /* ============================================
           MOBILE-FIRST REDESIGN - PHASE 1
           ============================================ */

        /* Bottom Tab Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            display: none;
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-nav-tabs {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 64px;
            max-width: 768px;
            margin: 0 auto;
        }

        .bottom-nav-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            color: var(--text-muted);
            text-decoration: none;
            min-width: 44px;
            min-height: 44px;
            padding: 8px;
            transition: all 0.2s;
            border: none;
            background: transparent;
            font-family: 'Outfit', sans-serif;
            position: relative;
        }

        .bottom-nav-tab:active {
            transform: scale(0.95);
        }

        .bottom-nav-tab.active {
            color: var(--accent-indigo);
        }

        .bottom-nav-icon {
            font-size: 24px;
            line-height: 1;
        }

        .bottom-nav-label {
            font-size: 11px;
            font-weight: 500;
            line-height: 1;
        }

        .bottom-nav-badge {
            position: absolute;
            top: 4px;
            right: 8px;
            background: var(--error);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .app-with-bottom-nav {
            padding-bottom: 80px;
        }

        /* Swipeable Cards */
        .swipeable-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .swipeable-card {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: visible;
            touch-action: pan-y;
            user-select: none;
        }

        .swipeable-card-content {
            position: relative;
            z-index: 2;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            transition: transform 0.3s ease-out;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .swipeable-card-actions {
            position: absolute;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1;
        }

        .swipeable-card-action-left {
            left: 0;
            background: var(--accent-indigo);
            color: white;
            border-radius: 12px 0 0 12px;
        }

        .swipeable-card-action-right {
            right: 0;
            background: var(--success);
            color: white;
            border-radius: 0 12px 12px 0;
        }

        .swipeable-card-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .swipeable-card-info {
            flex: 1;
            min-width: 0;
        }

        .swipeable-card-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .swipeable-card-meta {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            user-select: none;
            min-height: 44px;
        }

        .collapsible-header:active {
            background: var(--bg-tertiary);
        }

        .collapsible-title {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }

        .collapsible-section.expanded .collapsible-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-section.expanded .collapsible-content {
            max-height: 2000px;
        }

        .collapsible-inner {
            padding: 0 16px 16px 16px;
        }

        /* Listing Wizard */
        .mobile-wizard {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .wizard-headline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .wizard-progress {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .wizard-step {
            flex: 1;
            min-width: 64px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            text-align: left;
            border: none;
            color: var(--text-secondary);
        }

        .wizard-step strong {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .wizard-step span {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .wizard-step.active {
            background: var(--accent-indigo);
            color: white;
        }

        .wizard-step.completed {
            background: var(--success);
            color: white;
        }

        .wizard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .wizard-stat {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1rem;
        }

        .wizard-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .wizard-action {
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            cursor: pointer;
            min-height: 56px;
            font-weight: 600;
        }

        .wizard-action.primary {
            background: var(--accent-indigo);
            color: white;
            border-color: transparent;
        }

        .wizard-drafts {
            margin-top: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1rem;
        }

        .wizard-drafts-list {
            list-style: none;
            margin: 0.5rem 0 0 0;
            padding: 0;
        }

        .wizard-drafts-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .wizard-drafts-list li:last-child {
            border-bottom: none;
        }

        .review-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 0.5rem;
        }

        .review-image {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .review-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .review-image span {
            position: absolute;
            bottom: 6px;
            left: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            text-align: center;
        }

        /* Mobile Camera Interface */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 2000;
            display: none;
        }

        .camera-container.active {
            display: flex;
            flex-direction: column;
        }

        .camera-controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }

        .camera-viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            aspect-ratio: 1;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            pointer-events: none;
        }

        .camera-hint {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.5);
            margin: 0 20px;
            border-radius: 8px;
        }

        .camera-quality-indicator {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 20px;
        }

        .quality-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: background 0.3s;
        }

        .quality-dot.active {
            background: var(--success);
        }

        .camera-controls-bottom {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 24px;
            background: rgba(0, 0, 0, 0.8);
            min-height: 100px;
        }

        .camera-capture-btn {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 4px solid white;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .camera-capture-btn:active {
            transform: scale(0.9);
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 0%, var(--bg-tertiary) 50%, var(--bg-secondary) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 24px;
            width: 70%;
            margin-bottom: 12px;
        }

        .skeleton-card {
            height: 200px;
            border-radius: 12px;
        }

        /* Responsive Grid */
        .responsive-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
            .responsive-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .responsive-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1440px) {
            .responsive-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* PWA Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #dc2626, #ef4444);
            color: white;
            padding: 12px;
            text-align: center;
            z-index: 9999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
        }

        .offline-indicator.show {
            transform: translateY(0);
        }

        .offline-indicator svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        /* Install PWA Button */
        .install-pwa-button {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: var(--accent-indigo);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            z-index: 900;
            transform: translateX(calc(100% + 40px));
            transition: transform 0.3s ease;
        }

        .install-pwa-button.show {
            transform: translateX(0);
        }

        .install-pwa-button:hover {
            transform: translateX(0) scale(1.05);
        }

        /* Pull to Refresh */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .pull-to-refresh.pulling {
            transform: translateY(0);
        }

        .pull-to-refresh.refreshing {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* Barcode scanner animation */
        @keyframes scan {
            0% {
                transform: translateY(-50px);
            }
            50% {
                transform: translateY(50px);
            }
            100% {
                transform: translateY(-50px);
            }
        }

        .pull-to-refresh-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-top-color: var(--accent-indigo);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Voice Input Button */
        .input-with-icon {
            position: relative;
        }

        .input-with-icon .form-input {
            padding-right: 48px;
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .input-row .form-input {
            flex: 1;
            min-width: 180px;
        }

        .voice-input-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--accent-indigo);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .voice-input-button:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .voice-input-button.listening {
            color: #dc2626;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Share Button */
        .share-button {
            background: var(--bg-tertiary);
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .share-button:hover {
            background: var(--bg-hover);
        }

        /* Dashboard & Messages */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .stat-trend {
            font-size: 0.85rem;
            color: var(--success);
        }

        .message-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .message-card.unread {
            border-color: var(--accent-indigo);
        }

        .message-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-indigo);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .message-actions button {
            flex: 1;
            min-width: 120px;
        }

        .message-meta {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Onboarding Overlay */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
        }

        .onboarding-overlay.active {
            display: block;
        }

        .onboarding-tooltip {
            position: absolute;
            background: var(--bg-primary);
            border: 2px solid var(--accent-indigo);
            border-radius: 12px;
            padding: 20px;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .onboarding-tooltip h4 {
            color: var(--accent-indigo);
            margin-bottom: 10px;
        }

        .onboarding-tooltip p {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .onboarding-tooltip button {
            background: var(--accent-indigo);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
        }

        .onboarding-highlight {
            position: relative;
            z-index: 10001;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
        }

        /* Mobile Styles */
        @media (max-width: 767px) {
            .bottom-nav {
                display: block;
            }

            .header .nav-links {
                display: none;
            }

            input, select, textarea {
                font-size: 16px !important;
            }

            .btn:not(.btn-secondary):not(.btn-small) {
                width: 100%;
            }

            button, a, input[type="checkbox"], input[type="radio"] {
                min-height: 44px;
                min-width: 44px;
            }

            .hero-content {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 2rem 1rem;
            }

            .hero h1 {
                font-size: 2rem !important;
            }

            .section-title {
                font-size: 1.75rem !important;
            }
        }

        @media (min-width: 768px) and (max-width: 1023px) {
            .bottom-nav {
                display: none;
            }
        }

        @media (min-width: 1024px) {
            .bottom-nav {
                display: none;
            }

            .app-with-bottom-nav {
                padding-bottom: 0;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            transform: translateY(200%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .toast.show {
            transform: translateY(0);
        }

        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--error);
        }

        .toast.warning {
            border-color: var(--warning);
        }

        @media (min-width: 768px) {
            .toast {
                bottom: 24px;
                left: auto;
                right: 24px;
                max-width: 400px;
            }
        }

        /* Damage Detection Styles */
        .damage-modal {
            z-index: 10000;
        }

        .damage-report {
            padding: 1.5rem;
        }

        .damage-summary {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .damage-condition-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        .condition-excellent { background: var(--success-color); color: white; }
        .condition-good { background: #10b981; color: white; }
        .condition-fair { background: var(--warning-color); color: white; }
        .condition-poor { background: var(--error-color); color: white; }

        .damage-items {
            margin: 1.5rem 0;
        }

        .damage-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-indigo);
        }

        .damage-item.severity-critical {
            border-left-color: var(--error-color);
        }

        .damage-item.severity-major {
            border-left-color: var(--warning-color);
        }

        .damage-item.severity-minor {
            border-left-color: #fbbf24;
        }

        .damage-item.severity-normal_wear {
            border-left-color: var(--text-muted);
        }

        .damage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .damage-type {
            font-weight: 600;
            font-size: 1rem;
        }

        .damage-severity {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-critical { background: var(--error-color); color: white; }
        .severity-major { background: var(--warning-color); color: white; }
        .severity-minor { background: #fbbf24; color: #78350f; }
        .severity-normal_wear { background: var(--text-muted); color: white; }

        .damage-details {
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .damage-disclosure {
            background: var(--accent-indigo-light);
            border-radius: 12px;
            padding: 1rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--accent-indigo);
        }

        .damage-disclosure h4 {
            color: var(--accent-indigo);
            margin-bottom: 0.5rem;
        }

        .damage-disclosure-text {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .damage-recommendations {
            background: #fef3c7;
            border-radius: 12px;
            padding: 1rem;
            margin: 1.5rem 0;
            border-left: 4px solid #f59e0b;
        }

        .damage-recommendations h4 {
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .damage-recommendations ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
            color: #78350f;
        }

        .damage-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .honesty-score {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .honesty-score-bar {
            width: 100%;
            height: 20px;
            background: var(--bg-primary);
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .honesty-score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-indigo), var(--accent-purple));
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14H8v-2h2v2zm0-4H8V7h2v5z"/>
        </svg>
        <span>Offline - Changes will sync when online</span>
    </div>

    <!-- Pull to Refresh -->
    <div id="pullToRefresh" class="pull-to-refresh">
        <div class="pull-to-refresh-spinner"></div>
    </div>

    <!-- Install PWA Button -->
    <button id="installPWA" class="install-pwa-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM10 15h2V8H5v2h3.59L3 15.59 4.41 17 10 11.41z"/>
        </svg>
        <span>Install App</span>
    </button>

    <!-- Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay"></div>

    <!-- Marketing Header -->
    <header id="marketingHeader" class="header">
        <div class="header-content">
            <div class="logo" onclick="app.navigateTo('home')">
                <div class="logo-icon">Q</div>
                <span>QuickList AI</span>
            </div>
            <nav class="nav-links">
                <a class="nav-link" onclick="app.navigateTo('photoTips')">Photo Tips</a>
                <a class="nav-link" onclick="app.navigateTo('checklist')">Seller Checklist</a>
                <a class="nav-link" onclick="app.navigateTo('pricing')">Pricing</a>
                <button class="btn btn-primary" onclick="app.showAuthModal()" aria-label="Sign in or sign up">Sign In / Sign Up</button>
            </nav>
        </div>
    </header>

    <!-- App Header -->
    <header id="appHeader" class="header hidden">
        <div class="header-content">
            <div class="logo" onclick="app.navigateToApp('newItem')">
                <div class="logo-icon">Q</div>
                <span>QuickList AI</span>
            </div>
            <nav class="nav-links">
                <a class="nav-link" onclick="app.navigateToApp('newItem')" aria-label="Create new listing">New Item</a>
                <a class="nav-link" onclick="app.navigateToApp('savedItems')" aria-label="View saved listings">Saved Items</a>
                <a class="nav-link" onclick="app.navigateToApp('settings')" aria-label="Open settings">Settings</a>
                <button class="user-profile-btn" onclick="app.signOut()" aria-label="Sign out">U</button>
            </nav>
        </div>
    </header>

    <!-- Marketing Views -->
    <main id="marketingView">
        <!-- Home / Landing Page -->
        <div id="homeView">
            <!-- Hero Section -->
            <section class="hero" aria-label="Hero section">
                <div class="hero-content">
                    <div class="hero-text">
                        <h1>Turn Your Clutter Into Cash with AI</h1>
                        <p>Stop staring at that overflowing drawer. QuickList AI transforms your photos into professional marketplace listings in seconds. Perfect for Vinted, eBay, and Gumtree.</p>
                        <div class="hero-cta-group">
                            <button class="btn btn-primary" style="font-size: 1.25rem; padding: 1rem 2rem;" onclick="app.showAuthModal()" aria-label="Get started with QuickList AI">
                                Get Started Free
                            </button>
                            <button class="btn btn-secondary" style="font-size: 1.25rem; padding: 1rem 2rem;" onclick="document.getElementById('homeView').querySelector('.section').scrollIntoView({ behavior: 'smooth' })" aria-label="Learn how QuickList AI works">
                                See How It Works
                            </button>
                        </div>
                        <div style="margin-top: 2rem; display: flex; gap: 2rem; flex-wrap: wrap; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--success); font-weight: 600;"></span>
                                <span style="color: var(--text-secondary);">No credit card required</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--success); font-weight: 600;"></span>
                                <span style="color: var(--text-secondary);">5 free listings per month</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--success); font-weight: 600;"></span>
                                <span style="color: var(--text-secondary);">Setup in 60 seconds</span>
                            </div>
                        </div>
                    </div>
                    <div class="hero-image-container">
                        <img src="/stock%20images/pexels-ketut-subiyanto-4545965.jpg" 
                             alt="Person organizing clothes from overflowing drawer - representing decluttering and selling items online" 
                             loading="eager"
                             fetchpriority="high">
                    </div>
                </div>
            </section>

            <!-- How It Works -->
            <section class="section" aria-labelledby="how-it-works-title">
                <div class="container">
                    <h2 id="how-it-works-title" class="section-title">How QuickList AI Works</h2>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; max-width: 800px; margin: 0 auto 3rem;">
                        Three simple steps from photo to professional listing. No writing, no research, no hassle.
                    </p>
                    <div class="steps">
                        <div class="step">
                            <img src="/stock%20images/pexels-anastasia-shuraeva-8084487.jpg" alt="Person taking photos of items for online listing" class="step-image">
                            <div class="step-number">1</div>
                            <h3>Upload Your Photos</h3>
                            <p>Take photos of your item from different angles. Our AI reads labels, tags, and codes automatically. No need for perfect lighting or backgrounds.</p>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <h3>AI Generates Everything</h3>
                            <p>Our advanced AI identifies your product, writes compelling descriptions, suggests competitive prices, and finds the perfect keywords. All in seconds.</p>
                        </div>
                        <div class="step">
                            <img src="/stock%20images/pexels-ron-lach-8453415.jpg" alt="Professional product listing ready to publish" class="step-image">
                            <div class="step-number">3</div>
                            <h3>Download & List</h3>
                            <p>Review your professional listing, make any edits, then download everything in a ZIP file. Copy and paste to Vinted, eBay, or Gumtree.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Features -->
            <section class="section" aria-labelledby="features-title" style="background: var(--bg-secondary);">
                <div class="container">
                    <h2 id="features-title" class="section-title">Everything You Need to Sell Successfully</h2>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; max-width: 800px; margin: 0 auto 3rem;">
                        Professional-grade tools that make selling effortless. Used by thousands of sellers across the UK.
                    </p>
                    <div class="grid grid-3">
                        <div class="card">
                            <h3>AI-Powered Descriptions</h3>
                            <p>Get compelling, marketplace-ready descriptions that actually sell.</p>
                        </div>
                        <div class="card">
                            <h3>Optimized Titles & Categories</h3>
                            <p>Perfect titles and categories for maximum visibility.</p>
                        </div>
                        <div class="card">
                            <h3>Data-Driven Pricing</h3>
                            <p>Smart price suggestions based on real market data.</p>
                        </div>
                        <div class="card">
                            <h3>Professional Images</h3>
                            <p>Generate hero images, enhance photos, and fix blur.</p>
                        </div>
                        <div class="card">
                            <h3>Keywords & Hashtags</h3>
                            <p>Boost your listing's reach with optimized keywords.</p>
                        </div>
                        <div class="card">
                            <h3>Honest Flaw Detection</h3>
                            <p>Automatically identify and list any imperfections.</p>
                        </div>
                        <div class="card">
                            <h3>Stock Image Finder</h3>
                            <p>Automatically find official manufacturer product images.</p>
                        </div>
                        <div class="card">
                            <h3>Multi-Platform Support</h3>
                            <p>Generate listings optimized for Vinted, eBay, and Gumtree.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Target Audience -->
            <section class="section" aria-labelledby="target-audience-title">
                <div class="container">
                    <h2 id="target-audience-title" class="section-title">Perfect For Every Type of Seller</h2>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; max-width: 800px; margin: 0 auto 3rem;">
                        Whether you're decluttering your wardrobe or running a resale business, QuickList AI saves you time and helps you sell more.
                    </p>
                    <div class="grid grid-2">
                        <div class="card">
                            <img src="/stock%20images/pexels-anastasia-shuraeva-8084487.jpg" alt="Casual seller organizing items to sell" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h3>Casual Declutterers</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li>Got stuff to sell but hate writing descriptions</li>
                                <li>Want to make money without the hassle</li>
                                <li>Need quick, professional listings</li>
                                <li>Selling on Vinted, eBay, or Gumtree</li>
                            </ul>
                        </div>
                        <div class="card">
                            <img src="/stock%20images/pexels-ron-lach-8453415.jpg" alt="Professional seller managing multiple listings" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h3>Power Sellers & eBay Businesses</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li>Process hundreds of items efficiently</li>
                                <li>Maintain consistent quality across listings</li>
                                <li>Save hours of manual work</li>
                                <li>Scale your business faster</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- FAQ -->
            <section class="section" aria-labelledby="faq-title" style="background: var(--bg-secondary);">
                <div class="container">
                    <h2 id="faq-title" class="section-title">Frequently Asked Questions</h2>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 1.1rem; max-width: 800px; margin: 0 auto 3rem;">
                        Everything you need to know about QuickList AI
                    </p>
                    <div class="grid grid-2">
                        <div class="card">
                            <h3>Is it free?</h3>
                            <p>Yes! We offer a free tier with generous limits. Upgrade for unlimited listings and premium features.</p>
                        </div>
                        <div class="card">
                            <h3>Which marketplaces are supported?</h3>
                            <p>Currently Vinted, eBay, and Gumtree. More coming soon!</p>
                        </div>
                        <div class="card">
                            <h3>How accurate is the AI?</h3>
                            <p>Very! But you can always edit any field before posting your listing.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Final CTA -->
            <section class="section" aria-label="Call to action">
                <div class="container">
                    <div class="card" style="text-align: center; padding: 4rem 2rem; background: linear-gradient(135deg, var(--accent-indigo) 0%, var(--accent-indigo-hover) 100%); border: none;">
                        <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: white;">Ready to Turn Clutter into Cash?</h2>
                        <p style="font-size: 1.25rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
                            Join thousands of sellers using QuickList AI to create professional listings in seconds. Start your first listing in under 60 seconds.
                        </p>
                        <button class="btn" style="font-size: 1.25rem; padding: 1rem 2rem; background: white; color: var(--accent-indigo); font-weight: 600;" onclick="app.showAuthModal()" aria-label="Start creating listings with QuickList AI">
                            Get Started Now - It's Free
                        </button>
                        <p style="margin-top: 1.5rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;">
                            No credit card required  5 free listings per month  Cancel anytime
                        </p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Photo Tips Page -->
        <div id="photoTipsView" class="hidden">
            <section class="section">
                <div class="container">
                    <h1 class="section-title">Photography Tips for Better Listings</h1>
                    <div class="grid grid-2">
                        <div class="card">
                            <h3>Use Natural Light</h3>
                            <p>Shoot near a window during daytime. Natural light makes colors accurate and reduces harsh shadows. Avoid using flashit creates unflattering reflections.</p>
                        </div>
                        <div class="card">
                            <h3>Clean, Simple Background</h3>
                            <p>Place items against a plain white or neutral background. This helps buyers focus on the product and makes your listing look professional.</p>
                        </div>
                        <div class="card">
                            <h3>Capture Tags & Labels</h3>
                            <p>Include close-up shots of brand tags, size labels, and care instructions. This builds trust and provides essential information.</p>
                        </div>
                        <div class="card">
                            <h3>Show All Angles</h3>
                            <p>Take multiple photos from different angles. Front, back, sides, and details. More photos = more buyer confidence.</p>
                        </div>
                        <div class="card">
                            <h3>Highlight Flaws Honestly</h3>
                            <p>Photograph any damage, stains, or wear. Honesty prevents returns and builds your reputation as a trustworthy seller.</p>
                        </div>
                        <div class="card">
                            <h3>Keep It Steady</h3>
                            <p>Use both hands or prop your phone against something stable. Blurry photos kill sales faster than anything else.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Seller Checklist Page -->
        <div id="checklistView" class="hidden">
            <section class="section">
                <div class="container">
                    <h1 class="section-title">Seller Checklist: Get Ready to List</h1>
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <h3>Before You Start</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                                <strong>Clean Everything</strong><br>
                                <span style="color: var(--text-secondary);">Wash, wipe, or dust your items. Clean items sell faster and for more money.</span>
                            </li>
                            <li style="padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                                <strong>Sort Into Batches</strong><br>
                                <span style="color: var(--text-secondary);">Group similar items together (e.g., all clothing, all electronics) for efficient photographing.</span>
                            </li>
                            <li style="padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                                <strong>Set Up Your 'Studio'</strong><br>
                                <span style="color: var(--text-secondary);">Find a well-lit spot with a clean background. Keep it simple.</span>
                            </li>
                            <li style="padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                                <strong>Gather Supplies</strong><br>
                                <span style="color: var(--text-secondary);">Phone, charging cable, measuring tape (for dimensions), and packaging materials.</span>
                            </li>
                            <li style="padding: 1rem 0; border-bottom: 1px solid var(--border-color);">
                                <strong>Research Competitors</strong><br>
                                <span style="color: var(--text-secondary);">Quick browse of similar items on your marketplace. Get a sense of pricing and descriptions.</span>
                            </li>
                            <li style="padding: 1rem 0;">
                                <strong>Plan Your Shipping</strong><br>
                                <span style="color: var(--text-secondary);">Know your packaging options and shipping costs before listing.</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
        </div>

        <!-- Pricing Page -->
        <div id="pricingView" class="hidden">
            <section class="section">
                <div class="container">
                    <h1 class="section-title">Simple, Transparent Pricing</h1>
                    <div class="pricing-grid">
                        <div class="pricing-card">
                            <div class="pricing-tier">Starter</div>
                            <div class="pricing-price">Free</div>
                            <div class="pricing-period">Forever</div>
                            <ul class="pricing-features">
                                <li>5 listings per month</li>
                                <li>AI descriptions</li>
                                <li>Basic price suggestions</li>
                                <li>Standard image tools</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="app.showAuthModal()">Get Started</button>
                        </div>
                        <div class="pricing-card">
                            <div class="pricing-tier">Casual</div>
                            <div class="pricing-price">4.99</div>
                            <div class="pricing-period">per month</div>
                            <ul class="pricing-features">
                                <li>50 listings per month</li>
                                <li>Advanced AI descriptions</li>
                                <li>Market data pricing</li>
                                <li>Image enhancement</li>
                                <li>Keywords & hashtags</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="app.showAuthModal()">Choose Casual</button>
                        </div>
                        <div class="pricing-card featured">
                            <div class="pricing-tier">Pro</div>
                            <div class="pricing-price">9.99</div>
                            <div class="pricing-period">per month</div>
                            <ul class="pricing-features">
                                <li>200 listings per month</li>
                                <li>Premium AI descriptions</li>
                                <li>Real-time market data</li>
                                <li>Hero image generation</li>
                                <li>Blur detection & fixing</li>
                                <li>Batch processing</li>
                            </ul>
                            <button class="btn btn-primary" onclick="app.showAuthModal()">Choose Pro</button>
                        </div>
                        <div class="pricing-card">
                            <div class="pricing-tier">Max</div>
                            <div class="pricing-price">19.99</div>
                            <div class="pricing-period">per month</div>
                            <ul class="pricing-features">
                                <li>Unlimited listings</li>
                                <li>Everything in Pro</li>
                                <li>Priority processing</li>
                                <li>API access</li>
                                <li>Custom integrations</li>
                                <li>Priority support</li>
                            </ul>
                            <button class="btn btn-secondary" onclick="app.showAuthModal()">Choose Max</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- App Views -->
    <main id="appView" class="hidden">
        <!-- New Item View -->
        <div id="newItemView">
            <div class="mobile-wizard" id="listingWizard" aria-label="Listing creation wizard">
                <div class="wizard-headline">
                    <div>
                        <p style="color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.85rem;">Create New Listing</p>
                        <h2 style="margin-top: 0.25rem;" id="wizardStepTitle">Step 1  Add Photos</h2>
                    </div>
                    <button class="btn btn-secondary btn-small" type="button" onclick="app.showPrepChecklist()">Prep Checklist</button>
                </div>
                <div class="wizard-progress" role="tablist">
                    <button class="wizard-step active" data-step="1" aria-selected="true" aria-label="Photos step">
                        <strong>Step 1</strong>
                        <span>Photos</span>
                    </button>
                    <button class="wizard-step" data-step="2" aria-selected="false" aria-label="AI processing step">
                        <strong>Step 2</strong>
                        <span>AI</span>
                    </button>
                    <button class="wizard-step" data-step="3" aria-selected="false" aria-label="Review step">
                        <strong>Step 3</strong>
                        <span>Review</span>
                    </button>
                    <button class="wizard-step" data-step="4" aria-selected="false" aria-label="Publish step">
                        <strong>Step 4</strong>
                        <span>Publish</span>
                    </button>
                </div>
                <div class="wizard-actions">
                    <button class="wizard-action primary" type="button" onclick="app.openCamera()">
                         Take Photos
                    </button>
                    <button class="wizard-action" type="button" onclick="document.getElementById('imageInput').click()">
                         Upload from Gallery
                    </button>
                    <button class="wizard-action" type="button" onclick="app.showBarcodeScanner()">
                         Scan Barcode
                    </button>
                </div>
                <div class="wizard-drafts" id="wizardDrafts" aria-live="polite">
                    <div style="font-weight: 600;">Recent drafts</div>
                    <ul class="wizard-drafts-list" id="recentDraftsList">
                        <li style="color: var(--text-muted);">No drafts yet</li>
                    </ul>
                </div>
            </div>
            <div class="app-layout">
                <!-- Left Column: Input -->
                <div>
                    <div class="card">
                        <h2 class="mb-3">Upload Photos</h2>
                        <div class="image-uploader" id="imageUploader">
                            <div class="image-uploader-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M23 19C23 19.5304 22.7893 20.0391 22.4142 20.4142C22.0391 20.7893 21.5304 21 21 21H3C2.46957 21 1.96086 20.7893 1.58579 20.4142C1.21071 20.0391 1 19.5304 1 19V8C1 7.46957 1.21071 6.96086 1.58579 6.58579C1.96086 6.21071 2.46957 6 3 6H7L9 3H15L17 6H21C21.5304 6 22.0391 6.21071 22.4142 6.58579C22.7893 6.96086 23 7.46957 23 8V19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <circle cx="12" cy="13" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <p><strong>Click to upload or use camera</strong></p>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">Supports multiple images</p>
                        </div>
                        <input type="file" id="imageInput" accept="image/*" multiple capture="environment" style="display: none;">
                        <div class="image-grid" id="imageGrid"></div>
                    </div>

                    <div class="card mt-3">
                        <h3 class="mb-3">Listing Details</h3>
                        <div class="form-group">
                            <label class="form-label">Platform</label>
                            <select class="form-input" id="platformSelect">
                                <option value="vinted">Vinted</option>
                                <option value="ebay">eBay</option>
                                <option value="gumtree">Gumtree</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Item Info (Optional Hint)</label>
                            <div class="input-with-icon">
                                <input type="text" class="form-input" id="itemHint" placeholder="e.g., 'Has original box', 'Minor scuff on heel', 'Bought in 2023'">
                                <button class="voice-input-button" type="button" aria-pressed="false" onclick="app.toggleVoiceInput('itemHint', this)"></button>
                            </div>
                            <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.25rem;">
                                Add context about packaging, flaws, or specific details not visible in images
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pickup Location</label>
                            <div class="input-row">
                                <input type="text" class="form-input" id="itemLocation" placeholder="e.g., Manchester, UK">
                                <button class="btn btn-secondary btn-small" type="button" id="locationBtn" onclick="app.useCurrentLocation()">Use my location</button>
                            </div>
                            <small style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.25rem;">
                                Used for local listings, shipping estimates, and marketplace filters
                            </small>
                        </div>
                        <button class="btn btn-primary" id="generateBtn" style="width: 100%;" disabled>
                            Generate Listing
                        </button>
                        <button class="btn btn-secondary" id="analyzeDamageBtn" style="width: 100%; margin-top: 10px; display: none;" onclick="app.analyzeDamage()">
                             Analyze for Damage
                        </button>
                    </div>
                </div>

                <!-- Right Column: Output -->
                <div>
                    <div class="output-area" id="outputArea">
                        <div id="initialState" class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 13H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M16 17H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h3>Your generated listing will appear here</h3>
                            <p>Upload an image and click "Generate" to get started</p>
                        </div>

                        <div id="loadingState" class="hidden">
                            <h2 class="mb-3">Generating your listing...</h2>
                            <div id="progressSteps" style="margin: 2rem 0; display: flex; flex-direction: column; gap: 1rem;">
                                <div class="progress-step" data-step="1" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                                    <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                                    <span class="progress-text" style="color: var(--text-primary);">Analyzing images...</span>
                                </div>
                                <div class="progress-step" data-step="2" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                                    <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                                    <span class="progress-text" style="color: var(--text-primary);">Identifying product...</span>
                                </div>
                                <div class="progress-step" data-step="3" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                                    <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                                    <span class="progress-text" style="color: var(--text-primary);">Researching prices...</span>
                                </div>
                                <div class="progress-step" data-step="4" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                                    <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                                    <span class="progress-text" style="color: var(--text-primary);">Generating description...</span>
                                </div>
                                <div class="progress-step" data-step="5" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                                    <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                                    <span class="progress-text" style="color: var(--text-primary);">Finalizing listing...</span>
                                </div>
                            </div>
                            <div style="margin-top: 2rem; display: flex; justify-content: center;">
                                <button id="cancelGenerationBtn" class="btn btn-secondary" onclick="app.cancelGeneration()" style="display: none;">
                                    Cancel Generation
                                </button>
                            </div>
                            <div class="skeleton skeleton-text" style="width: 60%; margin-top: 1rem;"></div>
                            <div class="skeleton skeleton-text" style="width: 80%;"></div>
                            <div class="skeleton skeleton-text" style="width: 70%;"></div>
                        </div>

                        <div id="resultState" class="hidden">
            <div class="output-header">
                <h2>Generated Listing</h2>
                <div class="output-actions" style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <span id="autoSaveIndicator" style="color: var(--text-muted); font-size: 0.875rem; opacity: 0; transition: opacity 0.3s;" aria-live="polite">Saved</span>
                    <button class="btn btn-secondary btn-small" type="button" onclick="app.saveListing()">Save</button>
                    <button class="btn btn-secondary btn-small" type="button" onclick="app.shareListing()">Share</button>
                    <button class="btn btn-primary btn-small" type="button" onclick="app.copyAll()">Copy All</button>
                </div>
            </div>

            <div class="collapsible-section expanded" data-section="media">
                <div class="collapsible-header" role="button" tabindex="0">
                    <div class="collapsible-title">
                         Images & Media
                        <span id="reviewImageCount" style="font-size: 0.8rem; color: var(--text-muted);">0 photos</span>
                    </div>
                    <div class="collapsible-icon"></div>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div class="review-images" id="reviewImages"></div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                            <button class="btn btn-secondary btn-small" type="button" onclick="app.openCamera()">Add photo</button>
                            <button class="btn btn-secondary btn-small" type="button" onclick="document.getElementById('imageInput').click()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section expanded" data-section="details">
                <div class="collapsible-header" role="button" tabindex="0">
                    <div class="collapsible-title"> Title & Details</div>
                    <div class="collapsible-icon"></div>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label" for="outputTitle">Item Title</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.copyField('title')" aria-label="Copy title">Copy</button>
                            </div>
                            <input type="text" class="form-input" id="outputTitle" maxlength="80" aria-describedby="titleCharCount titleError" aria-invalid="false">
                            <small id="titleCharCount" style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.25rem;">0/80 characters</small>
                            <small id="titleError" class="field-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 0.25rem;"></small>
                        </div>
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label" for="outputBrand">Brand</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.copyField('brand')" aria-label="Copy brand">Copy</button>
                            </div>
                            <input type="text" class="form-input" id="outputBrand" aria-describedby="brandError" aria-invalid="false">
                            <small id="brandError" class="field-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 0.25rem;"></small>
                        </div>
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label" for="outputCategory">Category</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.copyField('category')" aria-label="Copy category">Copy</button>
                            </div>
                            <input type="text" class="form-input" id="outputCategory" aria-describedby="categoryError" aria-invalid="false">
                            <small id="categoryError" class="field-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 0.25rem;"></small>
                        </div>
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label" for="outputCondition">Condition</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.copyField('condition')">Copy</button>
                            </div>
                            <input type="text" class="form-input" id="outputCondition">
                        </div>
                        <div id="damageSummary" style="background: var(--accent-indigo-light); border-radius: 12px; padding: 1rem; display: none; margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section expanded" data-section="description">
                <div class="collapsible-header" role="button" tabindex="0">
                    <div class="collapsible-title"> Description & SEO</div>
                    <div class="collapsible-icon"></div>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label" for="outputDescription">Description</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.copyField('description')" aria-label="Copy description">Copy</button>
                            </div>
                            <textarea class="form-input" id="outputDescription" rows="6" maxlength="1000" aria-describedby="descCharCount descError" aria-invalid="false"></textarea>
                            <small id="descCharCount" style="color: var(--text-muted); font-size: 0.875rem; display: block; margin-top: 0.25rem;">0/1000 characters</small>
                            <small id="descError" class="field-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 0.25rem;"></small>
                        </div>
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label">Keywords & Hashtags</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.regenerateKeywords()">Regenerate</button>
                            </div>
                            <div class="tags-container" id="keywordsTags"></div>
                        </div>
                        <div class="field-group">
                            <label class="form-label">Sources</label>
                            <ul class="sources-list" id="sourcesList"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section expanded" data-section="pricing">
                <div class="collapsible-header" role="button" tabindex="0">
                    <div class="collapsible-title"> Pricing & Value</div>
                    <div class="collapsible-icon"></div>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label">RRP (Retail Price)</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.copyField('rrp')">Copy</button>
                            </div>
                            <input type="text" class="form-input" id="outputRRP">
                        </div>
                        <div class="field-group">
                            <div class="field-header">
                                <label class="form-label">Recommended Price</label>
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.copyField('price')">Copy</button>
                            </div>
                            <input type="text" class="form-input" id="outputPrice">
                        </div>
                        <div class="field-group" id="pricingIntelligenceSection" style="display: none;">
                            <div class="pricing-intelligence-card" id="pricingIntelligenceCard"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-section expanded" data-section="publish">
                <div class="collapsible-header" role="button" tabindex="0">
                    <div class="collapsible-title"> Publish & Export</div>
                    <div class="collapsible-icon"></div>
                </div>
                <div class="collapsible-content">
                    <div class="collapsible-inner">
                        <div class="field-group">
                            <label class="form-label">Download Options</label>
                            <div class="toggle-group">
                                <span>Generate Hero Image</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleHero" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-group" style="opacity: 0.5;" title="Coming soon">
                                <span>Get Stock Image <small style="color: var(--text-muted);">(Coming Soon)</small></span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleStock" disabled>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-group">
                                <span>Auto-Enhance Photos</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleEnhance" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-group">
                                <span>Fix Blurred Images</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleBlur" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="field-group" style="display: grid; gap: 0.5rem;">
                            <button class="btn btn-primary" id="downloadBtn" type="button" onclick="app.downloadZip()">Download ZIP</button>
                            <button class="btn btn-primary" id="postToEbayBtn" type="button" style="width: 100%; display: none;" onclick="app.postToEbay()">Post to eBay</button>
                            <button class="btn btn-primary" id="vintedAutofillBtn" type="button" style="width: 100%; display: none;" onclick="app.openVintedAutofill()">Open Vinted & Autofill</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Items View -->
        <div id="savedItemsView" class="hidden">
            <div class="container section">
                <h1 class="section-title">Saved Items</h1>
                
                <!-- Search and Filter Bar -->
                <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
                        <!-- Search Input -->
                        <div style="flex: 1; min-width: 200px;">
                            <label for="savedItemsSearch" class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Search</label>
                            <input 
                                type="text" 
                                id="savedItemsSearch" 
                                class="form-input" 
                                placeholder="Search by title, brand, or category..."
                                aria-label="Search saved items"
                                oninput="app.filterSavedItems()"
                            >
                        </div>
                        
                        <!-- Platform Filter -->
                        <div style="min-width: 150px;">
                            <label for="savedItemsPlatformFilter" class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Platform</label>
                            <select 
                                id="savedItemsPlatformFilter" 
                                class="form-input"
                                aria-label="Filter by platform"
                                onchange="app.filterSavedItems()"
                            >
                                <option value="">All Platforms</option>
                                <option value="vinted">Vinted</option>
                                <option value="ebay">eBay</option>
                                <option value="gumtree">Gumtree</option>
                            </select>
                        </div>
                        
                        <!-- Sort Filter -->
                        <div style="min-width: 150px;">
                            <label for="savedItemsSort" class="form-label" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Sort By</label>
                            <select 
                                id="savedItemsSort" 
                                class="form-input"
                                aria-label="Sort saved items"
                                onchange="app.filterSavedItems()"
                            >
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="title">Title A-Z</option>
                                <option value="brand">Brand A-Z</option>
                            </select>
                        </div>
                        
                        <!-- Clear Filters Button -->
                        <div style="align-self: flex-end;">
                            <button 
                                class="btn btn-secondary" 
                                onclick="app.clearSavedItemsFilters()"
                                aria-label="Clear all filters"
                            >
                                Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Results Count -->
                    <div id="savedItemsCount" style="margin-top: 1rem; color: var(--text-muted); font-size: 0.875rem;"></div>
                </div>
                
                <div class="saved-items-grid" id="savedItemsGrid">
                    <!-- Saved items will be populated here -->
                </div>
                <div id="savedItemsEmpty" class="empty-state hidden">
                    <div class="empty-state-icon"></div>
                    <h3>No saved items yet</h3>
                    <p>Generate and save listings to see them here</p>
                </div>
                <div id="savedItemsNoResults" class="empty-state hidden">
                    <div class="empty-state-icon"></div>
                    <h3>No items match your search</h3>
                    <p>Try adjusting your filters or search terms</p>
                </div>
            </div>
        </div>

        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
            <div class="container section">
                <h1 class="section-title">Mobile Dashboard</h1>
                <div class="stat-grid">
                    <div class="stat-card">
                        <h3>Revenue (7d)</h3>
                        <div class="stat-value" id="statRevenue">0</div>
                        <div class="stat-trend" id="statRevenueTrend">+0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Listings</h3>
                        <div class="stat-value" id="statListings">0</div>
                        <div class="stat-trend" id="statListingsTrend">+0 today</div>
                    </div>
                    <div class="stat-card">
                        <h3>Messages</h3>
                        <div class="stat-value" id="statMessages">0</div>
                        <div class="stat-trend" id="statMessagesTrend">Inbox clear</div>
                    </div>
                </div>
                <div class="card" style="margin-bottom: 2rem;">
                    <h2 style="margin-bottom: 1rem;">Activity Overview</h2>
                    <div id="dashboardActivity" style="display: grid; gap: 1rem;"></div>
                </div>
                <div class="card">
                    <h2 style="margin-bottom: 1rem;">Workflow Tips</h2>
                    <ul id="dashboardTips" style="list-style: none; padding: 0; display: grid; gap: 0.75rem;"></ul>
                </div>
            </div>
        </div>

        <!-- Messages View -->
        <div id="messagesView" class="hidden">
            <div class="container section">
                <h1 class="section-title">Unified Inbox</h1>
                <div id="messagesList"></div>
                <div id="messagesEmpty" class="empty-state hidden">
                    <div class="empty-state-icon"></div>
                    <h3>No messages right now</h3>
                    <p>Relax  well notify you when buyers reach out.</p>
                </div>
            </div>
        </div>

        <!-- Settings / Dashboard View -->
        <div id="settingsView" class="hidden">
            <div class="container section">
                <h1 class="section-title">Dashboard & Settings</h1>
                
                <!-- User Profile Section -->
                <div class="card" style="max-width: 800px; margin: 0 auto 2rem;">
                    <h2 style="margin-bottom: 1.5rem; font-size: 1.25rem;">Profile</h2>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div id="userAvatar" style="width: 64px; height: 64px; border-radius: 50%; background: var(--accent-indigo); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 600; color: white;">
                            U
                        </div>
                        <div>
                            <div id="userName" style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem;">Loading...</div>
                            <div id="userEmail" style="color: var(--text-muted); font-size: 0.875rem;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Subscription Section -->
                <div class="card" style="max-width: 800px; margin: 0 auto 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.25rem; margin: 0;">Subscription</h2>
                        <span id="subscriptionStatus" class="badge" style="background: var(--success);">Active</span>
                    </div>
                    
                    <div id="subscriptionInfo" style="margin-bottom: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">Current Plan</div>
                                <div id="currentPlan" style="font-size: 1.25rem; font-weight: 600;">Free</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">Status</div>
                                <div id="planStatus" style="font-size: 1.125rem;">Active</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">Renews</div>
                                <div id="renewalDate" style="font-size: 1.125rem;">Never</div>
                            </div>
                        </div>

                        <!-- Usage Tracking -->
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600;">Listings This Month</span>
                                <span id="usageCount" style="font-weight: 600; color: var(--accent-indigo);">0</span>
                            </div>
                            <div style="background: var(--bg-tertiary); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="usageBar" style="background: var(--accent-indigo); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <div id="usageLimit" style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">of 5 listings used</div>
                        </div>

                        <!-- Plan Actions -->
                        <div id="planActions" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button id="upgradeBtn" class="btn btn-primary" onclick="app.showUpgradeModal()">Upgrade Plan</button>
                            <button id="manageBillingBtn" class="btn btn-secondary" onclick="app.openBillingPortal()" style="display: none;">Manage Billing</button>
                        </div>
                    </div>
                </div>

                <!-- Account Settings -->
                <div class="card" style="max-width: 800px; margin: 0 auto 2rem;">
                    <h2 style="margin-bottom: 1.5rem; font-size: 1.25rem;">Preferences</h2>
                    <div class="toggle-group">
                        <div>
                            <strong>Auto-Download ZIP</strong>
                            <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem;">
                                Automatically download ZIP after generation
                            </p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="settingAutoDownload">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upgrade Modal -->
        <div id="upgradeModal" class="modal hidden">
            <div class="modal-content" style="max-width: 600px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">Upgrade Your Plan</h2>
                    <button class="modal-close" onclick="app.closeUpgradeModal()" aria-label="Close modal">&times;</button>
                </div>
                <div id="pricingPlans" style="display: grid; gap: 1rem;">
                    <!-- Plans will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="marketingFooter" class="footer">
        <div class="container">
            <div class="footer-links">
                <a class="nav-link" onclick="app.navigateTo('home')">Home</a>
                <a class="nav-link" onclick="app.navigateTo('photoTips')">Photo Tips</a>
                <a class="nav-link" onclick="app.navigateTo('checklist')">Seller Checklist</a>
                <a class="nav-link" onclick="app.navigateTo('pricing')">Pricing</a>
            </div>
            <p style="color: var(--text-muted);">&copy; 2025 QuickList AI. All rights reserved.</p>
        </div>
    </footer>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sign In / Sign Up</h2>
                <button class="modal-close" onclick="app.closeAuthModal()"></button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Sign in with Clerk to access your QuickList workspace.
            </p>
            <button class="btn btn-primary" style="width: 100%;" onclick="app.signInWithClerk()">
                Continue with Email (Clerk)
            </button>
            
            <!-- Divider -->
            <div style="display: flex; align-items: center; margin: 1.5rem 0;">
                <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
                <span style="padding: 0 1rem; color: var(--text-muted); font-size: 0.875rem;">or</span>
                <div style="flex: 1; height: 1px; background: var(--border-color);"></div>
            </div>
            
            <!-- Clerk OAuth Buttons -->
            <div id="clerkAuthButtons" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Google OAuth via Clerk -->
                <button 
                    class="btn btn-secondary clerk-oauth-btn" 
                    data-provider="google"
                    style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem; background: white; color: #333; border: 1px solid #dadce0;" 
                    onclick="app.signInWithClerk('google')"
                    aria-label="Sign in with Google"
                >
                    <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                        <g fill="#000" fill-rule="evenodd">
                            <path d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z" fill="#EA4335"/>
                            <path d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.21 1.18-.84 2.18-1.79 2.91l2.78 2.15c1.9-1.75 2.69-4.33 2.69-6.56z" fill="#4285F4"/>
                            <path d="M3.88 10.78A5.54 5.54 0 0 1 3.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 0 0 0 9c0 1.45.35 2.82.96 4.04l2.92-2.26z" fill="#FBBC05"/>
                            <path d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.78-2.15c-.76.53-1.78.9-3.18.9-2.42 0-4.4-1.49-5.12-3.74L.96 13.04C2.45 15.98 5.48 18 9 18z" fill="#34A853"/>
                        </g>
                    </svg>
                    Sign in with Google
                </button>
            </div>
            
            <p style="color: var(--text-muted); text-align: center; margin-top: 1rem; font-size: 0.875rem;">
                New users will be automatically registered.
            </p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Multiple Items Detected</h2>
                <button class="modal-close" onclick="app.closeConfirmationModal()"></button>
            </div>
            <p class="mb-3" style="color: var(--text-secondary);">We found multiple potential items. Please select the one you want to list:</p>
            <div class="confirmation-grid" id="confirmationGrid"></div>
            <button class="btn btn-primary mt-3" style="width: 100%;" onclick="app.confirmSelection()">
                Continue with Selected Item
            </button>
        </div>
    </div>

    <!-- Product Selection Modal (for uncertain matches) -->
    <div id="productSelectionModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Select Product Match</h2>
                <button class="modal-close" onclick="app.closeProductSelectionModal()"></button>
            </div>
            <p class="mb-3" style="color: var(--text-secondary);">
                We found multiple possible matches. Please select the one that best matches your item:
            </p>
            <div id="productAlternativesGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;"></div>
            <button class="btn btn-primary mt-3" style="width: 100%;" onclick="app.confirmProductSelection()">
                Use Selected Product
            </button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Delete Item?</h2>
                <button class="modal-close" onclick="app.closeDeleteModal()"></button>
            </div>
            <p style="color: var(--text-secondary);">Are you sure you want to delete this saved item? This action cannot be undone.</p>
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="app.closeDeleteModal()">Cancel</button>
                <button class="btn btn-primary" style="flex: 1; background: var(--error);" onclick="app.confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- QuaggaJS for Barcode Scanning -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

    <!-- PWA Features -->
    <script src="/pwa-features.js" defer></script>

    <!-- Clerk SDK -->
    <script>
        const loadClerkScript = (publishableKey) => {
            if (window.Clerk) {
                return Promise.resolve();
            }
            if (window.__clerkScriptPromise) {
                return window.__clerkScriptPromise;
            }
            window.__clerkScriptPromise = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js';
                script.crossOrigin = 'anonymous';
                script.async = true;
                script.setAttribute('data-clerk-publishable-key', publishableKey);
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Clerk JS'));
                document.head.appendChild(script);
            });
            return window.__clerkScriptPromise;
        };

        // Load auth config from server and initialize Clerk
        (async function initAuth() {
            try {
                const response = await fetch('/api/config/auth');
                const config = await response.json();
                
                // Initialize Clerk if enabled
                if (config.clerk && config.clerk.enabled && config.clerk.publishableKey) {
                    // Remove trailing $ if present (might be a typo)
                    const publishableKey = config.clerk.publishableKey.replace(/\$$/, '');

                    await loadClerkScript(publishableKey);

                    // Wait for Clerk to be available
                    if (!window.Clerk) {
                        throw new Error('Clerk SDK failed to load');
                    }

                    // Load and initialize Clerk
                    await window.Clerk.load({
                        publishableKey: publishableKey,
                        appearance: {
                            elements: {
                                rootBox: 'clerk-root',
                                card: 'clerk-card'
                            }
                        }
                    });

                    // Store reference to Clerk instance
                    window.clerk = window.Clerk;

                    // Listen for auth state changes
                    if (window.clerk && typeof window.clerk.addListener === 'function') {
                        window.clerk.addListener(({ user, session }) => {
                            if (user && session) {
                                window.dispatchEvent(new CustomEvent('clerkSignedIn', { detail: { user, session } }));
                            } else {
                                window.dispatchEvent(new CustomEvent('clerkSignedOut'));
                            }
                        });
                    }

                    console.log('Clerk initialized successfully');
                    window.dispatchEvent(new CustomEvent('authReady'));
                } else {
                    console.log('Clerk not configured, using legacy auth');
                    window.dispatchEvent(new CustomEvent('authReady'));
                }
            } catch (error) {
                console.error('Failed to initialize auth:', error);
                window.dispatchEvent(new CustomEvent('authReady'));
            }
        })();
    </script>
    <script>
        // QuickList AI Application
        const app = {
            // Auto-detect API URL based on current host
            apiUrl: (() => {
                const host = window.location.hostname;
                const protocol = window.location.protocol;
                const port = window.location.port;
                if (host === 'localhost' || host === '127.0.0.1') {
                    return port === '4577' ? `${protocol}//${host}:4577/api` : `${protocol}//${host}:3000/api`;
                }
                // Production: use same origin or configured API URL
                const hasProcessEnv = typeof process !== 'undefined' && process.env && process.env.NEXT_PUBLIC_API_URL;
                return hasProcessEnv ? process.env.NEXT_PUBLIC_API_URL : '/api';
            })(),

            state: {
                isAuthenticated: false,
                currentView: 'home',
                currentAppView: 'newItem',
                wizardPhase: 'photos',
                uploadedImages: [],
                currentListing: null,
                savedListings: [],
                filteredSavedListings: [],
                loadingSavedItems: false,
                selectedItemForDelete: null,
                selectedConfirmationItem: null,
                multipleItemsDetected: [],
                user: null,
                token: null,
                settings: {
                    autoDownloadZip: false
                },
                generationCancelled: false,
                generationAbortController: null,
                messages: [
                    {
                        id: 1,
                        buyer: 'Emily T.',
                        platform: 'Vinted',
                        snippet: 'Is this still available? I can pick up tomorrow.',
                        time: '2m ago',
                        unread: true,
                        quickReplies: ['Yes, still available!', 'Can ship for 4 extra.']
                    },
                    {
                        id: 2,
                        buyer: 'Jamie',
                        platform: 'eBay',
                        snippet: 'Would you accept 28 if I buy today?',
                        time: '15m ago',
                        unread: false,
                        quickReplies: ['Happy to accept 28!', 'Best I can do is 30.']
                    },
                    {
                        id: 3,
                        buyer: 'Priya',
                        platform: 'Gumtree',
                        snippet: 'Thanks for the quick reply! Sending payment now.',
                        time: '1h ago',
                        unread: false,
                        quickReplies: ['Great, thank you!', 'Let me know if you need anything else.']
                    }
                ],
                dashboardTips: [
                    'Batch similar items to speed through photos',
                    'Use voice input to capture condition notes hands-free',
                    'Turn on auto-download to keep listings organized offline'
                ],
                progressTimeouts: []
            },

            setWizardPhase(phase = 'photos') {
                this.state.wizardPhase = phase;
                const steps = document.querySelectorAll('.wizard-step');
                const title = document.getElementById('wizardStepTitle');
                const phaseMap = {
                    photos: { step: 1, title: 'Step 1  Add Photos' },
                    processing: { step: 2, title: 'Step 2  Let AI work' },
                    review: { step: 3, title: 'Step 3  Review & edit' },
                    publish: { step: 4, title: 'Step 4  Publish everywhere' }
                };
                const current = phaseMap[phase] || phaseMap.photos;

                steps.forEach(step => {
                    step.classList.remove('active', 'completed');
                    step.setAttribute('aria-selected', 'false');
                    const stepNumber = parseInt(step.dataset.step, 10);
                    if (stepNumber < current.step) {
                        step.classList.add('completed');
                    }
                    if (stepNumber === current.step) {
                        step.classList.add('active');
                        step.setAttribute('aria-selected', 'true');
                    }
                });

                if (title) {
                    title.textContent = current.title;
                }
            },

            // Initialize app
            // Register service worker for PWA functionality
            async registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('/service-worker.js');
                        console.log('Service Worker registered with scope:', registration.scope);
                    } catch (error) {
                        console.log('Service Worker registration failed:', error);
                    }
                }
            },

            // Setup PWA install prompt
            setupPWAInstall() {
                let deferredPrompt;

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    // Show install button or banner
                    const installButton = document.getElementById('pwaInstallButton');
                    if (installButton) {
                        installButton.style.display = 'block';
                        installButton.addEventListener('click', async () => {
                            if (deferredPrompt) {
                                deferredPrompt.prompt();
                                const { outcome } = await deferredPrompt.userChoice;
                                console.log(`User response to install prompt: ${outcome}`);
                                deferredPrompt = null;
                            }
                        });
                    }
                });
            },

            // Setup offline detection
            setupOfflineDetection() {
                window.addEventListener('online', () => {
                    const offlineBanner = document.getElementById('offlineBanner');
                    if (offlineBanner) offlineBanner.style.display = 'none';
                    console.log('Back online');
                });

                window.addEventListener('offline', () => {
                    const offlineBanner = document.getElementById('offlineBanner');
                    if (offlineBanner) {
                        offlineBanner.style.display = 'block';
                    } else {
                        // Create offline banner if it doesn't exist
                        const banner = document.createElement('div');
                        banner.id = 'offlineBanner';
                        banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff9800; color: white; padding: 10px; text-align: center; z-index: 10000;';
                        banner.textContent = 'You are currently offline. Some features may be limited.';
                        document.body.appendChild(banner);
                    }
                    console.log('Offline detected');
                });
            },

            // Setup pull-to-refresh
            setupPullToRefresh() {
                let startY = 0;
                let pulling = false;

                document.addEventListener('touchstart', (e) => {
                    if (window.scrollY === 0) {
                        startY = e.touches[0].pageY;
                        pulling = true;
                    }
                });

                document.addEventListener('touchmove', (e) => {
                    if (!pulling) return;

                    const y = e.touches[0].pageY;
                    const diff = y - startY;

                    if (diff > 100 && window.scrollY === 0) {
                        // Show refresh indicator
                        const refreshIndicator = document.getElementById('refreshIndicator');
                        if (refreshIndicator) {
                            refreshIndicator.style.display = 'block';
                        }
                    }
                });

                document.addEventListener('touchend', () => {
                    if (!pulling) return;
                    pulling = false;

                    const refreshIndicator = document.getElementById('refreshIndicator');
                    if (refreshIndicator && refreshIndicator.style.display === 'block') {
                        refreshIndicator.style.display = 'none';
                        // Refresh the current view
                        if (this.state.currentAppView === 'savedItems') {
                            this.loadSavedListings();
                        }
                    }
                });
            },

            // Check for first-time users
            checkOnboarding() {
                const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
                if (!hasSeenOnboarding && !this.state.isAuthenticated) {
                    // Could show onboarding tour here
                    localStorage.setItem('hasSeenOnboarding', 'true');
                }
            },

            async init() {
                // Ensure app view is hidden on initial load (before any async operations)
                const appView = document.getElementById('appView');
                const appHeader = document.getElementById('appHeader');
                if (appView) appView.classList.add('hidden');
                if (appHeader) appHeader.classList.add('hidden');

                // Ensure marketing view is visible
                const marketingView = document.getElementById('marketingView');
                const marketingHeader = document.getElementById('marketingHeader');
                const marketingFooter = document.getElementById('marketingFooter');
                if (marketingView) marketingView.classList.remove('hidden');
                if (marketingHeader) marketingHeader.classList.remove('hidden');
                if (marketingFooter) marketingFooter.classList.remove('hidden');

                this.loadSettings();
                this.loadToken();

                // Register Service Worker for PWA
                this.registerServiceWorker();

                // Setup PWA Install
                this.setupPWAInstall();

                // Setup offline detection
                this.setupOfflineDetection();

                // Setup pull-to-refresh
                this.setupPullToRefresh();

                // Check for onboarding
                this.checkOnboarding();
                
                // Wait for auth to be ready (Clerk or legacy)
                await new Promise((resolve) => {
                    if (document.readyState === 'complete') {
                        window.addEventListener('authReady', resolve, { once: true });
                        // Timeout after 2 seconds if auth doesn't initialize
                        setTimeout(resolve, 2000);
                    } else {
                        window.addEventListener('load', () => {
                            window.addEventListener('authReady', resolve, { once: true });
                            setTimeout(resolve, 2000);
                        });
                    }
                });
                
                // Check Clerk auth first
                await this.checkClerkAuth();
                
                // Fallback to legacy JWT auth if not authenticated
                if (!this.state.isAuthenticated) {
                    await this.checkAuth();
                }
                
                this.attachEventListeners();
                this.setupFormValidation();
                this.updateUI();

                // Initialize mobile features
                this.initMobileFeatures();
                this.setWizardPhase('photos');
                this.renderRecentDrafts();

                // Load draft if available (only if authenticated)
                if (this.state.isAuthenticated) {
                    this.loadDraft();
                }
            },

            // Load token from localStorage
            loadToken() {
                const token = localStorage.getItem('quicklist-token');
                if (token) {
                    this.state.token = token;
                }
            },

            // Check if user is authenticated
            async checkAuth() {
                if (!this.state.token) return;

                try {
                    const response = await fetch(`${this.apiUrl}/auth/verify`, {
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.state.user = data.user;
                        this.state.isAuthenticated = true;
                        await this.loadListingsFromDB();
                    } else {
                        // Token invalid, clear it
                        localStorage.removeItem('quicklist-token');
                        this.state.token = null;
                    }
                } catch (error) {
                    console.error('Auth check error:', error);
                }
            },

            // Load listings from database
            async loadListingsFromDB() {
                this.state.loadingSavedItems = true;
                this.renderSavedItems(); // Show loading state

                try {
                    const response = await fetch(`${this.apiUrl}/listings`, {
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.state.savedListings = data.listings.map(listing => ({
                            ...listing,
                            keywords: listing.keywords || [],
                            sources: typeof listing.sources === 'string' ? JSON.parse(listing.sources) : listing.sources,
                            images: (listing.images || []).map(img => ({
                                id: img.id,
                                data: img.data,
                                url: img.data,
                                isBlurry: img.isBlurry,
                                status: 'ready'
                            }))
                        }));
                        // Initialize filtered list with all listings
                        this.state.filteredSavedListings = [];
                    }
                } catch (error) {
                    console.error('Error loading listings:', error);
                } finally {
                    this.state.loadingSavedItems = false;
                    this.filterSavedItems(); // Use filterSavedItems to render (which calls renderSavedItems)
                    this.renderDashboard();
                }
            },

            // Event listeners
            attachEventListeners() {
                // Image uploader
                const uploader = document.getElementById('imageUploader');
                const input = document.getElementById('imageInput');

                uploader.addEventListener('click', () => input.click());
                input.addEventListener('change', (e) => this.handleImageUpload(e));

                // Drag and drop
                uploader.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploader.style.borderColor = 'var(--accent-indigo)';
                });

                uploader.addEventListener('dragleave', () => {
                    uploader.style.borderColor = 'var(--border-color)';
                });

                uploader.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploader.style.borderColor = 'var(--border-color)';
                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    this.processFiles(files);
                });

                // Generate button
                document.getElementById('generateBtn').addEventListener('click', () => this.generateListing());

                // Settings
                document.getElementById('settingAutoDownload').addEventListener('change', (e) => {
                    this.state.settings.autoDownloadZip = e.target.checked;
                    this.saveSettings();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Don't trigger shortcuts when typing in inputs/textareas
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        // Allow Ctrl+S for save even in inputs
                        if (e.ctrlKey || e.metaKey) {
                            if (e.key === 's' || e.key === 'S') {
                                e.preventDefault();
                                if (this.state.currentListing) {
                                    this.saveListing();
                                    this.showToast('Saving...', 'info');
                                }
                            }
                        }
                        return;
                    }

                    // Global shortcuts (only when not in input fields)
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'g':
                            case 'G':
                                e.preventDefault();
                                const generateBtn = document.getElementById('generateBtn');
                                if (generateBtn && !generateBtn.disabled) {
                                    this.generateListing();
                                }
                                break;
                            case 's':
                            case 'S':
                                e.preventDefault();
                                if (this.state.currentListing) {
                                    this.saveListing();
                                }
                                break;
                            case 'n':
                            case 'N':
                                e.preventDefault();
                                if (this.state.isAuthenticated) {
                                    this.navigateToApp('newItem');
                                    this.showInitialState();
                                }
                                break;
                        }
                    }

                    // Escape key to close modals
                    if (e.key === 'Escape') {
                        const modals = document.querySelectorAll('.modal.active');
                        modals.forEach(modal => {
                            const closeBtn = modal.querySelector('.modal-close');
                            if (closeBtn) closeBtn.click();
                        });
                    }
                });
            },

            // Setup form validation
            setupFormValidation() {
                // Email validation for auth forms
                const authEmail = document.getElementById('authEmail');
                if (authEmail) {
                    authEmail.addEventListener('blur', () => {
                        const email = authEmail.value.trim();
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (email && !emailRegex.test(email)) {
                            authEmail.style.borderColor = 'var(--error)';
                        } else {
                            authEmail.style.borderColor = '';
                        }
                    });
                    authEmail.addEventListener('input', () => {
                        if (authEmail.style.borderColor === 'var(--error)') {
                            const email = authEmail.value.trim();
                            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                            if (!email || emailRegex.test(email)) {
                                authEmail.style.borderColor = '';
                            }
                        }
                    });
                }

                // Password validation for auth forms
                const authPassword = document.getElementById('authPassword');
                if (authPassword) {
                    authPassword.addEventListener('blur', () => {
                        const password = authPassword.value;
                        if (password && password.length < 6) {
                            authPassword.style.borderColor = 'var(--error)';
                        } else {
                            authPassword.style.borderColor = '';
                        }
                    });
                    authPassword.addEventListener('input', () => {
                        if (authPassword.style.borderColor === 'var(--error)') {
                            const password = authPassword.value;
                            if (!password || password.length >= 6) {
                                authPassword.style.borderColor = '';
                            }
                        }
                    });
                }

                // Title validation (maxlength is already set, just add visual feedback)
                const outputTitle = document.getElementById('outputTitle');
                if (outputTitle) {
                    outputTitle.addEventListener('input', () => {
                        const maxLength = parseInt(outputTitle.getAttribute('maxlength') || '80');
                        if (outputTitle.value.length >= maxLength) {
                            outputTitle.style.borderColor = 'var(--warning)';
                        } else {
                            outputTitle.style.borderColor = '';
                        }
                    });
                }

                // Description validation
                const outputDescription = document.getElementById('outputDescription');
                if (outputDescription) {
                    outputDescription.addEventListener('input', () => {
                        const maxLength = parseInt(outputDescription.getAttribute('maxlength') || '5000');
                        if (outputDescription.value.length >= maxLength) {
                            outputDescription.style.borderColor = 'var(--warning)';
                        } else {
                            outputDescription.style.borderColor = '';
                        }
                    });
                }
            },

            // Handle image upload
            async handleImageUpload(event) {
                const files = Array.from(event.target.files);
                await this.processFiles(files);
            },

            // Real blur detection using Laplacian variance
            async detectBlur(imageFile) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            ctx.drawImage(img, 0, 0);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            
                            // Calculate Laplacian variance
                            let variance = 0;
                            let mean = 0;
                            const data = imageData.data;
                            const width = imageData.width;
                            const height = imageData.height;
                            
                            // Convert to grayscale and calculate Laplacian
                            const laplacian = [];
                            for (let y = 1; y < height - 1; y++) {
                                for (let x = 1; x < width - 1; x++) {
                                    const idx = (y * width + x) * 4;
                                    const gray = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                                    const grayUp = (data[((y - 1) * width + x) * 4] + data[((y - 1) * width + x) * 4 + 1] + data[((y - 1) * width + x) * 4 + 2]) / 3;
                                    const grayDown = (data[((y + 1) * width + x) * 4] + data[((y + 1) * width + x) * 4 + 1] + data[((y + 1) * width + x) * 4 + 2]) / 3;
                                    const grayLeft = (data[(y * width + (x - 1)) * 4] + data[(y * width + (x - 1)) * 4 + 1] + data[(y * width + (x - 1)) * 4 + 2]) / 3;
                                    const grayRight = (data[(y * width + (x + 1)) * 4] + data[(y * width + (x + 1)) * 4 + 1] + data[(y * width + (x + 1)) * 4 + 2]) / 3;
                                    
                                    const laplacianValue = Math.abs(4 * gray - grayUp - grayDown - grayLeft - grayRight);
                                    laplacian.push(laplacianValue);
                                    mean += laplacianValue;
                                }
                            }
                            
                            mean /= laplacian.length;
                            
                            // Calculate variance
                            for (let i = 0; i < laplacian.length; i++) {
                                variance += Math.pow(laplacian[i] - mean, 2);
                            }
                            variance /= laplacian.length;
                            
                            // Threshold: values below 100 typically indicate blur
                            resolve(variance < 100);
                        } catch (error) {
                            // If detection fails, assume not blurry
                            resolve(false);
                        }
                    };
                    img.onerror = () => resolve(false);
                    img.src = URL.createObjectURL(imageFile);
                });
            },

            // Resize image to optimize for Gemini API (2400px max dimension)
            async resizeImage(file, maxDimension = 2400) {
                return new Promise((resolve) => {
                    const img = new Image();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    img.onload = () => {
                        // Calculate new dimensions
                        let width = img.width;
                        let height = img.height;

                        // Only resize if image exceeds maxDimension
                        if (width <= maxDimension && height <= maxDimension) {
                            // Image is already small enough, return original
                            resolve(file);
                            return;
                        }

                        if (width > height) {
                            if (width > maxDimension) {
                                height = Math.round((height * maxDimension) / width);
                                width = maxDimension;
                            }
                        } else {
                            if (height > maxDimension) {
                                width = Math.round((width * maxDimension) / height);
                                height = maxDimension;
                            }
                        }

                        // Set canvas dimensions and draw
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to blob
                        canvas.toBlob(
                            (blob) => {
                                resolve(new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                }));
                            },
                            'image/jpeg',
                            0.92 // Quality setting
                        );
                    };

                    img.onerror = () => resolve(file); // Return original on error
                    img.src = URL.createObjectURL(file);
                });
            },

            // Process uploaded files
            async processFiles(files) {
                const totalFiles = files.length;
                let processedCount = 0;

                // Show batch progress if multiple files
                if (totalFiles > 1) {
                    this.showToast(`Processing ${totalFiles} images...`, 'info');
                }

                for (const file of files) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        this.showToast(`${file.name} is not an image file`);
                        processedCount++;
                        continue;
                    }

                    // Validate file size (max 10MB)
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    if (file.size > maxSize) {
                        this.showToast(`${file.name} is too large. Max 10MB.`);
                        processedCount++;
                        continue;
                    }

                    try {
                        // Track original size
                        const originalSize = file.size;

                        // Resize image BEFORE processing
                        const resizedFile = await this.resizeImage(file, 2400);
                        const resizedSize = resizedFile.size;
                        const sizeSaved = originalSize - resizedSize;
                        const percentSaved = Math.round((sizeSaved / originalSize) * 100);

                        const imageData = {
                            id: Date.now() + Math.random(),
                            file: resizedFile, // Use resized file
                            url: URL.createObjectURL(resizedFile),
                            status: 'checking',
                            isBlurry: false,
                            originalSize: originalSize,
                            resizedSize: resizedSize,
                            sizeSaved: sizeSaved
                        };

                        this.state.uploadedImages.push(imageData);
                        this.renderImageGrid();

                        // Show resize feedback for significant reductions
                        if (percentSaved > 20) {
                            console.log(`Resized ${file.name}: ${Math.round(originalSize / 1024)}KB -> ${Math.round(resizedSize / 1024)}KB (${percentSaved}% saved)`);
                        }

                        // Real blur detection using Laplacian variance
                        this.detectBlur(imageData.file).then(isBlurry => {
                            imageData.status = isBlurry ? 'blurry' : 'ready';
                            imageData.isBlurry = isBlurry;
                            this.renderImageGrid();
                            this.updateGenerateButton();

                            // Check image quality with AI (Feature 3)
                            this.checkImageQuality(imageData).catch(err => {
                                console.error('Quality check failed:', err);
                            });
                        }).catch(() => {
                            // If detection fails, assume not blurry
                            imageData.status = 'ready';
                            imageData.isBlurry = false;
                            this.renderImageGrid();
                            this.updateGenerateButton();
                        });

                        processedCount++;
                    } catch (error) {
                        console.error('Error processing image:', error);
                        this.showToast(`Failed to process ${file.name}`);
                        processedCount++;
                    }
                }

                // Show completion message for batch uploads
                if (totalFiles > 1) {
                    this.showToast(`Added ${processedCount} of ${totalFiles} images`, 'success');
                }

                this.updateGenerateButton();
            },

            // Render image grid
            renderImageGrid() {
                const grid = document.getElementById('imageGrid');

                grid.innerHTML = this.state.uploadedImages.map(img => `
                    <div class="image-thumbnail" style="position: relative;">
                        <img src="${img.url}" alt="Uploaded">
                        <button class="image-thumbnail-delete" onclick="app.deleteImage('${img.id}')" aria-label="Delete image"></button>
                        ${img.status === 'checking' ?
                            '<div class="image-thumbnail-status">Checking...</div>' :
                            img.isBlurry ?
                            '<div class="image-thumbnail-status warning"><span style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9v4M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span> Blur Detected</div>' :
                            ''
                        }
                        ${img.qualityScore !== undefined ? `
                            <div style="position: absolute; bottom: 5px; right: 5px; background: ${
                                img.qualityScore >= 80 ? 'var(--success-color)' :
                                img.qualityScore >= 60 ? 'var(--warning-color)' :
                                'var(--error-color)'
                            }; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ${img.qualityScore}
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                this.renderReviewImages();
            },

            // Delete image
            deleteImage(id) {
                this.state.uploadedImages = this.state.uploadedImages.filter(img => img.id !== id);
                this.renderImageGrid();
                this.updateGenerateButton();
            },

            renderReviewImages(images = null) {
                const container = document.getElementById('reviewImages');
                const countEl = document.getElementById('reviewImageCount');
                if (!container) return;

                const sourceImages = Array.isArray(images) && images.length
                    ? images
                    : this.state.uploadedImages;

                if (!sourceImages || sourceImages.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">No photos yet. Add a few shots to help AI understand your item.</p>';
                    if (countEl) countEl.textContent = '0 photos';
                    return;
                }

                container.innerHTML = sourceImages.map((img, index) => {
                    const url = img.url || img.data || '';
                    return `
                        <div class="review-image">
                            <img src="${url}" alt="Listing photo ${index + 1}">
                            <span>${index + 1}</span>
                        </div>
                    `;
                }).join('');

                if (countEl) {
                    const total = sourceImages.length;
                    countEl.textContent = `${total} photo${total === 1 ? '' : 's'}`;
                }
            },

            renderRecentDrafts() {
                const list = document.getElementById('recentDraftsList');
                if (!list) return;

                const draftJson = localStorage.getItem('quicklist-draft');
                if (!draftJson) {
                    list.innerHTML = '<li style="color: var(--text-muted);">No drafts yet</li>';
                    return;
                }

                try {
                    const draft = JSON.parse(draftJson);
                    const updated = draft.timestamp ? new Date(draft.timestamp) : null;
                    const formattedDate = updated
                        ? updated.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
                        : 'Recently';
                    list.innerHTML = `
                        <li>
                            <div>
                                <strong>${draft.platform ? draft.platform.toUpperCase() : 'Draft'}</strong>
                                <p style="color: var(--text-muted); font-size: 0.85rem;">${draft.imageCount || 0} photo${draft.imageCount === 1 ? '' : 's'}  ${formattedDate}</p>
                            </div>
                            <button class="btn btn-secondary btn-small" type="button" onclick="app.resumeDraftFromWizard()">Resume</button>
                        </li>
                    `;
                } catch (error) {
                    console.warn('Failed to render drafts:', error);
                    list.innerHTML = '<li style="color: var(--text-muted);">No drafts yet</li>';
                }
            },

            resumeDraftFromWizard() {
                this.navigateToApp('newItem');
                const draft = this.loadDraft();
                if (draft) {
                    this.showToast('Draft settings restored. Upload saved photos to continue.', 'info');
                } else {
                    this.showToast('No draft available yet.', 'warning');
                }
                this.setWizardPhase('photos');
                this.renderRecentDrafts();
            },

            toggleVoiceInput(fieldId, button) {
                if (!button) return;

                const stop = () => {
                    button.classList.remove('listening');
                    button.setAttribute('aria-pressed', 'false');
                    if (typeof this.stopVoiceInput === 'function') {
                        this.stopVoiceInput();
                    }
                };

                if (button.classList.contains('listening')) {
                    stop();
                    return;
                }

                document.querySelectorAll('.voice-input-button.listening').forEach(btn => {
                    btn.classList.remove('listening');
                    btn.setAttribute('aria-pressed', 'false');
                });

                button.classList.add('listening');
                button.setAttribute('aria-pressed', 'true');

                if (typeof this.startVoiceInput === 'function') {
                    this.startVoiceInput(fieldId);
                } else {
                    this.showToast('Voice input not supported on this device', 'error');
                    stop();
                }
            },

            async useCurrentLocation() {
                const input = document.getElementById('itemLocation');
                const btn = document.getElementById('locationBtn');

                if (!input) return;
                if (!navigator.geolocation || typeof this.getLocationForListing !== 'function') {
                    this.showToast('Location not supported', 'error');
                    return;
                }

                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Locating...';
                }

                try {
                    const location = await this.getLocationForListing();
                    if (location) {
                        input.value = location.formatted || [location.city, location.country].filter(Boolean).join(', ');
                        this.showToast('Location added', 'success');
                    } else {
                        this.showToast('Unable to fetch location', 'error');
                    }
                } catch (error) {
                    this.showToast('Location permission denied', 'error');
                } finally {
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Use my location';
                    }
                }
            },

            updateDamageSummary() {
                const summary = document.getElementById('damageSummary');
                if (!summary) return;

                const analysis = this.state.damageAnalysis;
                if (!analysis) {
                    summary.style.display = 'none';
                    summary.textContent = '';
                    return;
                }

                const condition = analysis.overallCondition ? `<strong>${analysis.overallCondition}</strong>` : '';
                if (analysis.damageFound && analysis.damages?.length) {
                    summary.innerHTML = `
                        ${condition ? condition + '  ' : ''} ${analysis.damages.length} issue${analysis.damages.length === 1 ? '' : 's'} detected.
                        <br>
                        <small style="color: var(--text-muted);">Tap Analyze again after re-taking close-ups.</small>
                    `;
                } else {
                    summary.innerHTML = `${condition ? condition + '  ' : ''} No visible damage detected`;
                }
                summary.style.display = 'block';
            },

            // Feature 3: Check image quality with AI
            async checkImageQuality(imageData) {
                try {
                    // Convert file to base64
                    const base64 = await this.fileToBase64(imageData.file);

                    const response = await fetch(`${this.apiUrl}/api/analyze-image-quality`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ image: base64 })
                    });

                    if (!response.ok) {
                        throw new Error('Quality analysis failed');
                    }

                    const quality = await response.json();

                    // Store quality data with image
                    imageData.qualityScore = quality.overallScore;
                    imageData.qualityData = quality;

                    // Show warning if quality is poor
                    if (quality.overallScore < 60 && !imageData.qualityWarningShown) {
                        imageData.qualityWarningShown = true;
                        this.showQualityWarning(imageData, quality);
                    }

                    // Update the image grid to show quality score
                    this.renderImageGrid();

                    return quality;
                } catch (error) {
                    console.error('Quality check error:', error);
                    // Don't block the upload process if quality check fails
                    return null;
                }
            },

            // Show quality warning modal
            showQualityWarning(imageData, quality) {
                const modal = document.createElement('div');
                modal.className = 'modal quality-warning-modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3> Image Quality Issues Detected</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="quality-score-display" style="text-align: center; margin: 20px 0;">
                                <h2 style="color: ${quality.overallScore >= 80 ? 'var(--success-color)' : quality.overallScore >= 60 ? 'var(--warning-color)' : 'var(--error-color)'}">
                                    Score: ${quality.overallScore}/100
                                </h2>
                            </div>

                            <img src="${imageData.url}" style="max-width: 100%; max-height: 300px; display: block; margin: 0 auto 20px;">

                            <div class="quality-breakdown" style="margin: 20px 0;">
                                <h4>Quality Breakdown:</h4>
                                ${this.renderQualityBar('Sharpness', quality.sharpness)}
                                ${this.renderQualityBar('Lighting', quality.lighting)}
                                ${this.renderQualityBar('Background', quality.background)}
                                ${this.renderQualityBar('Composition', quality.composition)}
                                ${this.renderQualityBar('Angle/View', quality.angle)}
                            </div>

                            ${quality.criticalIssues && quality.criticalIssues.length > 0 ? `
                                <div class="critical-issues" style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin: 20px 0;">
                                    <h4 style="color: var(--error-color);">Critical Issues:</h4>
                                    <ul style="margin: 10px 0;">
                                        ${quality.criticalIssues.map(issue => `<li>${issue}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            ${quality.recommendations && quality.recommendations.length > 0 ? `
                                <div class="recommendations" style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px;">
                                    <h4>Recommendations to Improve:</h4>
                                    <ul style="margin: 10px 0;">
                                        ${quality.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="app.retakePhoto('${imageData.id}')">
                                Retake Photo
                            </button>
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">
                                Use Anyway
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            },

            // Render quality score bar
            renderQualityBar(label, score) {
                const percentage = (score || 0) * 10;
                const color = percentage >= 80 ? 'var(--success-color)' : percentage >= 60 ? 'var(--warning-color)' : 'var(--error-color)';
                return `
                    <div style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${label}</span>
                            <span>${score || 0}/10</span>
                        </div>
                        <div style="background: var(--bg-secondary); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${color}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            },

            // Retake photo (removes current and prompts for new)
            retakePhoto(imageId) {
                // Remove the current image
                this.deleteImage(imageId);

                // Close the modal
                const modal = document.querySelector('.quality-warning-modal');
                if (modal) modal.remove();

                // Trigger file input
                const fileInput = document.querySelector('input[type="file"]');
                if (fileInput) fileInput.click();
            },

            // Feature 6: AI Damage Detection
            async analyzeDamage() {
                // Check authentication first
                if (!this.state.isAuthenticated || !this.state.token) {
                    this.showToast('Please sign in to use damage detection', 'warning');
                    this.showAuthModal();
                    return;
                }

                if (this.state.uploadedImages.length === 0) {
                    this.showToast('Please upload images first');
                    return;
                }

                const btn = document.getElementById('analyzeDamageBtn');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'Analyzing...';

                try {
                    // Convert all images to base64
                    const images = await Promise.all(
                        this.state.uploadedImages.map(img => this.fileToBase64(img.file))
                    );

                    const response = await fetch(`${this.apiUrl}/api/analyze-damage`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ images })
                    });

                    if (!response.ok) {
                        throw new Error('Damage analysis failed');
                    }

                    const damageData = await response.json();

                    // Store damage analysis
                    this.state.damageAnalysis = damageData;
                    this.updateDamageSummary();

                    // Show damage report modal
                    this.showDamageReport(damageData);

                } catch (error) {
                    console.error('Damage detection error:', error);
                    this.showToast('Failed to analyze damage. Please try again.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            },

            // Show damage detection report modal
            showDamageReport(damageData) {
                const modal = document.createElement('div');
                modal.className = 'modal damage-modal';
                modal.style.display = 'block';

                const conditionClass = damageData.overallCondition.toLowerCase().replace(/ /g, '-');

                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2> Damage Detection Report</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="damage-report">
                            <div class="damage-summary">
                                <h3>Overall Condition Assessment</h3>
                                <div class="damage-condition-badge condition-${conditionClass}">
                                    ${damageData.overallCondition}
                                </div>
                                ${damageData.conditionJustification ? `
                                    <p style="margin-top: 1rem; color: var(--text-secondary);">
                                        ${damageData.conditionJustification}
                                    </p>
                                ` : ''}
                            </div>

                            ${damageData.damageFound ? `
                                <div class="damage-items">
                                    <h3>${damageData.damages.length} Issue${damageData.damages.length !== 1 ? 's' : ''} Detected</h3>
                                    ${damageData.damages.map((damage, i) => `
                                        <div class="damage-item severity-${damage.severity}">
                                            <div class="damage-header">
                                                <span class="damage-type">${this.formatDamageType(damage.type)}</span>
                                                <span class="damage-severity severity-${damage.severity}">
                                                    ${damage.severity.replace('_', ' ')}
                                                </span>
                                            </div>
                                            <div class="damage-details">
                                                <p><strong>Location:</strong> ${damage.location}</p>
                                                <p><strong>Description:</strong> ${damage.description}</p>
                                                ${damage.estimatedSize ? `
                                                    <p><strong>Size:</strong> ${damage.estimatedSize}</p>
                                                ` : ''}
                                                ${damage.confidence !== undefined ? `
                                                    <p><strong>Confidence:</strong> ${Math.round(damage.confidence * 100)}%</p>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="background: var(--success-color); color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                     No visible damage or defects detected
                                </div>
                            `}

                            <div class="damage-disclosure">
                                <h4> Suggested Condition Disclosure</h4>
                                <div class="damage-disclosure-text">
                                    ${damageData.conditionDisclosure}
                                </div>
                                <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="app.addDamageDisclosure()">
                                    Add to Description
                                </button>
                            </div>

                            ${damageData.recommendations && damageData.recommendations.length > 0 ? `
                                <div class="damage-recommendations">
                                    <h4> Photo Recommendations</h4>
                                    <ul>
                                        ${damageData.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            ${damageData.honestyScore !== undefined ? `
                                <div class="honesty-score">
                                    <h4>Transparency Score</h4>
                                    <div class="honesty-score-bar">
                                        <div class="honesty-score-fill" style="width: ${damageData.honestyScore}%"></div>
                                    </div>
                                    <p>${damageData.honestyScore}/100 - ${this.getHonestyMessage(damageData.honestyScore)}</p>
                                </div>
                            ` : ''}

                            <div class="damage-actions">
                                <button class="btn btn-secondary" onclick="app.retakePhotosForDamage()">
                                    Take New Photos
                                </button>
                                <button class="btn btn-primary" onclick="this.closest('.modal').remove()">
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            },

            // Format damage type for display
            formatDamageType(type) {
                const typeMap = {
                    'stain': ' Stain',
                    'tear': ' Tear/Hole',
                    'scratch': ' Scratch',
                    'discoloration': ' Discoloration',
                    'missing_part': ' Missing Part',
                    'structural': ' Structural Damage',
                    'wear': ' Normal Wear'
                };
                return typeMap[type] || type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ');
            },

            // Get honesty message based on score
            getHonestyMessage(score) {
                if (score >= 90) return 'Excellent transparency - buyers will appreciate your honesty';
                if (score >= 70) return 'Good disclosure - consider adding more detail';
                if (score >= 50) return 'Fair - some defects may not be adequately disclosed';
                return 'Needs improvement - add more defect details to avoid returns';
            },

            // Add damage disclosure to description
            addDamageDisclosure() {
                if (!this.state.damageAnalysis || !this.state.damageAnalysis.conditionDisclosure) {
                    return;
                }

                const descField = document.getElementById('description');
                if (descField) {
                    const currentDesc = descField.value;
                    const disclosure = this.state.damageAnalysis.conditionDisclosure;

                    // Add disclosure as a separate section
                    const updatedDesc = currentDesc +
                        (currentDesc ? '\n\n' : '') +
                        '**Condition Notes:**\n' +
                        disclosure;

                    descField.value = updatedDesc;

                    // Update text area height
                    descField.style.height = 'auto';
                    descField.style.height = descField.scrollHeight + 'px';

                    this.showToast('Damage disclosure added to description', 'success');

                    // Close the modal
                    const modal = document.querySelector('.damage-modal');
                    if (modal) modal.remove();
                }
            },

            // Retake photos for damage documentation
            retakePhotosForDamage() {
                const modal = document.querySelector('.damage-modal');
                if (modal) modal.remove();

                this.showToast('Please take close-up photos of any damaged areas', 'info');

                const fileInput = document.querySelector('input[type="file"]');
                if (fileInput) fileInput.click();
            },

            // Update generate button state
            updateGenerateButton() {
                const generateBtn = document.getElementById('generateBtn');
                const analyzeDamageBtn = document.getElementById('analyzeDamageBtn');
                const hasImages = this.state.uploadedImages.length > 0;
                const allReady = this.state.uploadedImages.every(img => img.status !== 'checking');

                generateBtn.disabled = !hasImages || !allReady;

                // Show/hide damage analysis button
                if (hasImages && allReady && analyzeDamageBtn) {
                    analyzeDamageBtn.style.display = 'block';
                } else if (analyzeDamageBtn) {
                    analyzeDamageBtn.style.display = 'none';
                }
            },

            // Generate listing using Gemini API
            async generateListing() {
                // Check authentication first
                if (!this.state.isAuthenticated || !this.state.token) {
                    this.showToast('Please sign in to generate listings', 'warning');
                    this.showAuthModal();
                    return;
                }

                const btn = document.getElementById('generateBtn');
                const initialState = document.getElementById('initialState');
                const loadingState = document.getElementById('loadingState');
                const resultState = document.getElementById('resultState');
                const cancelBtn = document.getElementById('cancelGenerationBtn');

                // Show loading state
                initialState.classList.add('hidden');
                resultState.classList.add('hidden');
                loadingState.classList.remove('hidden');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Generating...';
                this.setWizardPhase('processing');
                
                // Show cancel button
                if (cancelBtn) {
                    cancelBtn.style.display = 'inline-flex';
                }

                // Track if generation was cancelled
                this.state.generationCancelled = false;
                this.state.generationAbortController = new AbortController();

                // Animate progress steps with realistic timing
                this.animateProgressSteps();

                try {
                    // Get ALL uploaded images
                    const platform = document.getElementById('platformSelect').value;
                    const hint = document.getElementById('itemHint').value;

                    // Save draft before starting generation
                    this.saveDraft(platform, hint);

                    // Convert all images to base64
                    const base64Images = await Promise.all(
                        this.state.uploadedImages.map(img => this.fileToBase64(img.file))
                    );

                    // Check if cancelled during image conversion
                    if (this.state.generationCancelled) {
                        this.showInitialState();
                        return;
                    }

                    // Call Gemini API with all images
                    const response = await this.callGeminiAPI(base64Images, platform, hint);
                    
                    // Check if cancelled during API call
                    if (this.state.generationCancelled) {
                        this.showInitialState();
                        return;
                    }

                    const listing = response.listing;
                    const pricingIntelligence = response.pricingIntelligence;
                    const stockImageData = response.stockImageData || null;
                    const requiresUserSelection = response.requiresUserSelection || false;

                    // If confidence is low/medium and alternatives exist, show selection modal
                    if (requiresUserSelection && listing.alternatives && listing.alternatives.length > 0) {
                        this.state.productAlternatives = [listing, ...listing.alternatives];
                        this.state.selectedProductIndex = 0; // Default to first (best match)
                        this.showProductSelectionModal(listing, listing.alternatives);
                        // Don't display yet - wait for user selection
                        loadingState.classList.add('hidden');
                        if (cancelBtn) {
                            cancelBtn.style.display = 'none';
                        }
                        return;
                    }

                    // Store the listing
                    this.state.currentListing = {
                        ...listing,
                        images: this.state.uploadedImages,
                        platform: platform,
                        id: Date.now(),
                        pricingIntelligence: pricingIntelligence,
                        stockImageData: stockImageData
                    };

                    // Clear draft on success
                    this.clearDraft();

                    // Display results with pricing intelligence and stock image
                    this.displayListing(listing, pricingIntelligence, stockImageData);

                    // Show result state
                    loadingState.classList.add('hidden');
                    resultState.classList.remove('hidden');
                    this.setWizardPhase('review');
                    if (cancelBtn) {
                        cancelBtn.style.display = 'none';
                    }

                    // Auto-download if enabled
                    if (this.state.settings.autoDownloadZip) {
                        setTimeout(() => this.downloadZip(), 500);
                    }

                } catch (error) {
                    console.error('Error generating listing:', error);

                    // Don't show error if user cancelled
                    if (this.state.generationCancelled) {
                        this.showInitialState();
                        return;
                    }

                    // Get user-friendly error message
                    const errorMessage = this.getErrorMessage(error);

                    // Show error state with retry and save draft options
                    loadingState.classList.add('hidden');
                    loadingState.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="width: 48px; height: 48px; display: inline-flex; margin-bottom: 1rem; color: var(--error);"><svg viewBox="0 0 24 24" fill="none"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9v4M12 17h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <h2 style="color: var(--error); margin-bottom: 1rem;">Generation Failed</h2>
                            <p style="color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 500;">
                                ${errorMessage.title}
                            </p>
                            <p style="color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem;">
                                ${errorMessage.details}
                            </p>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="app.generateListing()">
                                    <span style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><path d="M23 4v6h-6M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span> Retry
                                </button>
                                <button class="btn btn-secondary" onclick="app.saveDraftFromError()">
                                    <span style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M17 21v-8H7v8M7 3v5h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span> Save Draft
                                </button>
                                <button class="btn btn-secondary" onclick="app.showInitialState()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    `;
                    loadingState.classList.remove('hidden');
                    if (cancelBtn) {
                        cancelBtn.style.display = 'none';
                    }
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'Generate Listing';
                    this.state.generationAbortController = null;
                }
            },

            // Cancel generation
            cancelGeneration() {
                if (this.state.generationAbortController) {
                    this.state.generationCancelled = true;
                    this.state.generationAbortController.abort();
                }
                this.showInitialState();
            },

            // Get user-friendly error message
            getErrorMessage(error) {
                const message = error.message || 'An unknown error occurred';
                
                // Network errors
                if (message.includes('Failed to fetch') || message.includes('NetworkError') || message.includes('network')) {
                    return {
                        title: 'Network Error',
                        details: 'Unable to connect to the server. Please check your internet connection and try again.'
                    };
                }
                
                // API errors
                if (message.includes('API request failed') || message.includes('Gemini API')) {
                    if (message.includes('429') || message.includes('quota') || message.includes('rate limit')) {
                        return {
                            title: 'API Rate Limit Exceeded',
                            details: 'Too many requests. Please wait a moment and try again.'
                        };
                    }
                    if (message.includes('401') || message.includes('403') || message.includes('unauthorized')) {
                        return {
                            title: 'Authentication Error',
                            details: 'Your session may have expired. Please sign in again.'
                        };
                    }
                    if (message.includes('timeout') || message.includes('timed out')) {
                        return {
                            title: 'Request Timeout',
                            details: 'The request took too long. The server may be busy. Please try again.'
                        };
                    }
                    return {
                        title: 'API Error',
                        details: 'The AI service encountered an error. Please try again in a moment.'
                    };
                }
                
                // Validation errors
                if (message.includes('image') && (message.includes('required') || message.includes('invalid'))) {
                    return {
                        title: 'Invalid Images',
                        details: 'Please ensure you have uploaded at least one valid image.'
                    };
                }
                
                // Generic error
                return {
                    title: 'Generation Failed',
                    details: message.length > 100 ? message.substring(0, 100) + '...' : message
                };
            },

            // Show initial state (helper for error recovery)
            showInitialState() {
                const initialState = document.getElementById('initialState');
                const loadingState = document.getElementById('loadingState');
                const resultState = document.getElementById('resultState');
                const cancelBtn = document.getElementById('cancelGenerationBtn');

                loadingState.classList.add('hidden');
                resultState.classList.add('hidden');
                initialState.classList.remove('hidden');
                if (cancelBtn) {
                    cancelBtn.style.display = 'none';
                }

                // Clear progress timeouts
                if (this.state.progressTimeouts) {
                    this.state.progressTimeouts.forEach(timeout => clearTimeout(timeout));
                    this.state.progressTimeouts = [];
                }

                // Reset loading state HTML
                loadingState.innerHTML = `
                    <h2 class="mb-3">Generating your listing...</h2>
                    <div id="progressSteps" style="margin: 2rem 0; display: flex; flex-direction: column; gap: 1rem;">
                        <div class="progress-step" data-step="1" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                            <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                            <span class="progress-text" style="color: var(--text-primary);">Analyzing images...</span>
                        </div>
                        <div class="progress-step" data-step="2" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                            <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                            <span class="progress-text" style="color: var(--text-primary);">Identifying product...</span>
                        </div>
                        <div class="progress-step" data-step="3" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                            <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                            <span class="progress-text" style="color: var(--text-primary);">Researching prices...</span>
                        </div>
                        <div class="progress-step" data-step="4" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                            <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                            <span class="progress-text" style="color: var(--text-primary);">Generating description...</span>
                        </div>
                        <div class="progress-step" data-step="5" style="display: flex; align-items: center; gap: 0.75rem; opacity: 0.5;">
                            <span class="progress-icon" style="width: 20px; height: 20px; display: inline-flex;"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span>
                            <span class="progress-text" style="color: var(--text-primary);">Finalizing listing...</span>
                        </div>
                    </div>
                    <div style="margin-top: 2rem; display: flex; justify-content: center;">
                        <button id="cancelGenerationBtn" class="btn btn-secondary" onclick="app.cancelGeneration()" style="display: none;">
                            Cancel Generation
                        </button>
                    </div>
                    <div class="skeleton skeleton-text" style="width: 60%; margin-top: 1rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                    <div class="skeleton skeleton-text" style="width: 70%;"></div>
                `;

                this.state.damageAnalysis = null;
                this.updateDamageSummary();
                this.renderReviewImages();
                this.setWizardPhase('photos');
            },

            // Save draft to localStorage
            saveDraft(platform, hint) {
                try {
                    const draft = {
                        platform: platform || document.getElementById('platformSelect')?.value || 'vinted',
                        hint: hint || document.getElementById('itemHint')?.value || '',
                        imageCount: this.state.uploadedImages.length,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('quicklist-draft', JSON.stringify(draft));
                    this.renderRecentDrafts();
                } catch (error) {
                    console.warn('Failed to save draft:', error);
                }
            },

            // Auto-save edits (debounced)
            autoSaveTimeout: null,
            autoSaveEdits() {
                // Clear existing timeout
                if (this.autoSaveTimeout) {
                    clearTimeout(this.autoSaveTimeout);
                }

                // Only auto-save if we have a current listing
                if (!this.state.currentListing) return;

                // Debounce: save after 2 seconds of inactivity
                this.autoSaveTimeout = setTimeout(() => {
                    try {
                        const edits = {
                            title: document.getElementById('outputTitle')?.value || '',
                            brand: document.getElementById('outputBrand')?.value || '',
                            category: document.getElementById('outputCategory')?.value || '',
                            description: document.getElementById('outputDescription')?.value || '',
                            condition: document.getElementById('outputCondition')?.value || '',
                            rrp: document.getElementById('outputRRP')?.value || '',
                            price: document.getElementById('outputPrice')?.value || '',
                            timestamp: Date.now()
                        };
                        localStorage.setItem('quicklist-edits', JSON.stringify(edits));
                        
                        // Show subtle indicator (optional - can be removed if too noisy)
                        const indicator = document.getElementById('autoSaveIndicator');
                        if (indicator) {
                            indicator.textContent = 'Saved';
                            indicator.style.opacity = '1';
                            setTimeout(() => {
                                if (indicator) indicator.style.opacity = '0';
                            }, 1000);
                        }
                    } catch (error) {
                        console.warn('Failed to auto-save edits:', error);
                    }
                }, 2000);
            },

            // Load saved edits
            loadSavedEdits() {
                try {
                    const editsJson = localStorage.getItem('quicklist-edits');
                    if (!editsJson) return;

                    const edits = JSON.parse(editsJson);
                    const editAge = Date.now() - edits.timestamp;
                    const maxAge = 24 * 60 * 60 * 1000; // 24 hours

                    // Only load edits if they're less than 24 hours old
                    if (editAge > maxAge) {
                        localStorage.removeItem('quicklist-edits');
                        return;
                    }

                    // Restore form fields if they exist and are empty
                    const titleEl = document.getElementById('outputTitle');
                    const brandEl = document.getElementById('outputBrand');
                    const categoryEl = document.getElementById('outputCategory');
                    const descEl = document.getElementById('outputDescription');
                    const conditionEl = document.getElementById('outputCondition');
                    const rrpEl = document.getElementById('outputRRP');
                    const priceEl = document.getElementById('outputPrice');

                    if (titleEl && !titleEl.value && edits.title) titleEl.value = edits.title;
                    if (brandEl && !brandEl.value && edits.brand) brandEl.value = edits.brand;
                    if (categoryEl && !categoryEl.value && edits.category) categoryEl.value = edits.category;
                    if (descEl && !descEl.value && edits.description) descEl.value = edits.description;
                    if (conditionEl && !conditionEl.value && edits.condition) conditionEl.value = edits.condition;
                    if (rrpEl && !rrpEl.value && edits.rrp) rrpEl.value = edits.rrp;
                    if (priceEl && !priceEl.value && edits.price) priceEl.value = edits.price;

                    // Update character counts
                    if (titleEl) this.updateCharCount('title');
                    if (descEl) this.updateCharCount('description');
                } catch (error) {
                    console.warn('Failed to load saved edits:', error);
                }
            },

            // Clear saved edits (called when listing is saved or cleared)
            clearSavedEdits() {
                try {
                    localStorage.removeItem('quicklist-edits');
                } catch (error) {
                    console.warn('Failed to clear saved edits:', error);
                }
            },

            // Save draft from error state
            saveDraftFromError() {
                const platform = document.getElementById('platformSelect')?.value || 'vinted';
                const hint = document.getElementById('itemHint')?.value || '';
                this.saveDraft(platform, hint);
                this.showToast('Draft saved! Your images and settings have been saved.', 'success');
                this.showInitialState();
            },

            // Clear draft
            clearDraft() {
                try {
                    localStorage.removeItem('quicklist-draft');
                    this.renderRecentDrafts();
                } catch (error) {
                    console.warn('Failed to clear draft:', error);
                }
            },

            // Load draft on page load (only when in app view)
            loadDraft() {
                try {
                    // Only load draft if we're in the app view
                    const appView = document.getElementById('appView');
                    if (!appView || appView.classList.contains('hidden')) {
                        return null;
                    }
                    
                    const draftJson = localStorage.getItem('quicklist-draft');
                    if (!draftJson) return null;

                    const draft = JSON.parse(draftJson);
                    const draftAge = Date.now() - draft.timestamp;
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days

                    // Only load draft if it's less than 7 days old
                    if (draftAge > maxAge) {
                        localStorage.removeItem('quicklist-draft');
                        return null;
                    }

                    // Restore platform and hint (only if elements exist)
                    const platformSelect = document.getElementById('platformSelect');
                    const itemHint = document.getElementById('itemHint');
                    
                    if (draft.platform && platformSelect) {
                        platformSelect.value = draft.platform;
                    }
                    if (draft.hint && itemHint) {
                        itemHint.value = draft.hint;
                    }

                    // Show notification if draft exists
                    if (draft.imageCount > 0) {
                        this.showToast(`Draft restored: ${draft.imageCount} image(s) were saved. Upload images to continue.`);
                    }

                    this.renderRecentDrafts();
                    return draft;
                } catch (error) {
                    console.warn('Failed to load draft:', error);
                    return null;
                }
            },

            // Call backend API for generation
            async callGeminiAPI(base64Images, platform, hint) {
                try {
                    const response = await fetch(`${this.apiUrl}/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({
                            images: base64Images, // Send all images
                            platform,
                            hint
                        }),
                        signal: this.state.generationAbortController?.signal
                    });

                    if (!response.ok) {
                        // Handle authentication errors
                        if (response.status === 401 || response.status === 403) {
                            this.state.isAuthenticated = false;
                            this.state.token = null;
                            localStorage.removeItem('quicklist-token');
                            throw new Error('Authentication failed. Please sign in again.');
                        }
                        
                        const error = await response.json().catch(() => ({}));
                        const errorMessage = error.error || `API request failed (${response.status})`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    return {
                        listing: data.listing,
                        pricingIntelligence: data.pricingIntelligence
                    };
                } catch (error) {
                    // Handle network errors
                    if (error.name === 'AbortError') {
                        throw new Error('Generation cancelled');
                    }
                    if (error.message === 'Failed to fetch' || error.message === 'Load failed') {
                        throw new Error('Unable to connect to server. Please check your connection and try again.');
                    }
                    throw error;
                }
            },

            // Convert file to base64
            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },

            // Animate progress steps with realistic timing
            animateProgressSteps() {
                const steps = document.querySelectorAll('.progress-step');
                if (steps.length === 0) return;

                // Clear any existing timeouts
                if (this.state.progressTimeouts) {
                    this.state.progressTimeouts.forEach(timeout => clearTimeout(timeout));
                }
                this.state.progressTimeouts = [];

                // Realistic timing: steps get progressively slower as they represent longer operations
                const timings = [500, 1500, 2500, 4000, 5500]; // Total ~14 seconds
                
                steps.forEach((step, index) => {
                    // Reset step to initial state
                    step.style.opacity = '0.5';
                    step.querySelector('.progress-icon').innerHTML = '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
                    
                    // Animate step activation
                    const timeout = setTimeout(() => {
                        if (!this.state.generationCancelled) {
                            step.style.opacity = '1';
                            step.style.transition = 'opacity 0.3s ease-in-out';
                            step.querySelector('.progress-icon').innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="var(--success)" stroke-width="2" fill="var(--success)"/><path d="M9 12L11 14L15 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        }
                    }, timings[index] || (index * 1000));
                    
                    this.state.progressTimeouts.push(timeout);
                });
            },

            // Update character counts
            updateCharCounts() {
                const titleInput = document.getElementById('outputTitle');
                const descInput = document.getElementById('outputDescription');
                const titleCount = document.getElementById('titleCharCount');
                const descCount = document.getElementById('descCharCount');

                if (titleInput && titleCount) {
                    titleCount.textContent = titleInput.value.length;
                }
                if (descInput && descCount) {
                    descCount.textContent = descInput.value.length;
                }
            },

            // Display listing
            displayListing(listing, pricingIntelligence = null, stockImageData = null) {
                document.getElementById('outputTitle').value = listing.title || '';
                document.getElementById('outputBrand').value = listing.brand || '';
                document.getElementById('outputCategory').value = listing.category || '';

                // Handle description with optional damage analysis
                let description = listing.description || '';

                // If damage analysis exists and has a disclosure, append it
                if (this.state.damageAnalysis && this.state.damageAnalysis.conditionDisclosure && this.state.damageAnalysis.damageFound) {
                    // Check if damage disclosure is not already in description
                    if (!description.includes('**Condition Notes:**')) {
                        description += '\n\n**Condition Notes:**\n' + this.state.damageAnalysis.conditionDisclosure;
                    }

                    // Update condition field if damage analysis suggests a different condition
                    if (this.state.damageAnalysis.overallCondition) {
                        document.getElementById('outputCondition').value = this.state.damageAnalysis.overallCondition;
                    } else {
                        document.getElementById('outputCondition').value = listing.condition || '';
                    }
                } else {
                    document.getElementById('outputCondition').value = listing.condition || '';
                }

                document.getElementById('outputDescription').value = description;
                document.getElementById('outputRRP').value = listing.rrp || '';
                document.getElementById('outputPrice').value = listing.price || '';

                const reviewImages = listing.images && listing.images.length > 0
                    ? listing.images
                    : this.state.uploadedImages;
                this.renderReviewImages(reviewImages);
                this.updateDamageSummary();

                // Load saved edits (will only restore if fields are empty)
                this.loadSavedEdits();

                // Update character counts
                this.updateCharCounts();

                // Display pricing intelligence if available
                if (pricingIntelligence) {
                    this.displayPricingIntelligence(pricingIntelligence, listing);
                }

                // Add input listeners for live character count updates and auto-save
                const titleEl = document.getElementById('outputTitle');
                const descEl = document.getElementById('outputDescription');
                
                if (titleEl) {
                    titleEl.addEventListener('input', () => {
                        this.updateCharCounts();
                        this.autoSaveEdits();
                    });
                }
                
                if (descEl) {
                    descEl.addEventListener('input', () => {
                        this.updateCharCounts();
                        this.autoSaveEdits();
                    });
                }

                // Add auto-save listeners to all editable fields
                const fields = ['outputBrand', 'outputCategory', 'outputCondition', 'outputRRP', 'outputPrice'];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        // Remove existing listeners by cloning (clean slate)
                        const newField = field.cloneNode(true);
                        field.parentNode.replaceChild(newField, field);
                        // Add new listener
                        document.getElementById(fieldId).addEventListener('input', () => this.autoSaveEdits());
                    }
                });

                // Keywords
                const keywordsContainer = document.getElementById('keywordsTags');
                keywordsContainer.innerHTML = (listing.keywords || [])
                    .map(kw => `<span class="tag">${kw}</span>`)
                    .join('');

                // Sources
                const sourcesList = document.getElementById('sourcesList');
                sourcesList.innerHTML = (listing.sources || [])
                    .map(src => `<li><a href="${src.url}" target="_blank">${src.title || src.url}</a></li>`)
                    .join('');

                // Show pricing intelligence if available and platform is eBay
                const pricingSection = document.getElementById('pricingIntelligenceSection');
                const pricingCard = document.getElementById('pricingIntelligenceCard');
                const platform = document.getElementById('platformSelect').value;
                
                if (pricingIntelligence && platform === 'ebay') {
                    pricingSection.style.display = 'block';
                    
                    let html = '';
                    
                    if (pricingIntelligence.avgSoldPrice) {
                        html += `
                            <div class="pricing-stat">
                                <span class="pricing-stat-label">Average Sold Price</span>
                                <span class="pricing-stat-value">${pricingIntelligence.avgSoldPrice}</span>
                            </div>
                        `;
                    }
                    
                    if (pricingIntelligence.priceRange) {
                        html += `
                            <div class="pricing-stat">
                                <span class="pricing-stat-label">Price Range</span>
                                <span class="pricing-stat-value">${pricingIntelligence.priceRange.min} - ${pricingIntelligence.priceRange.max}</span>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="pricing-stat">
                            <span class="pricing-stat-label">Sold Listings Found</span>
                            <span class="pricing-stat-value">${pricingIntelligence.soldCount || 0}</span>
                        </div>
                        <div class="pricing-stat">
                            <span class="pricing-stat-label">Active Competitors</span>
                            <span class="pricing-stat-value">${pricingIntelligence.competitorCount || 0}</span>
                        </div>
                    `;
                    
                    if (pricingIntelligence.recommendations && pricingIntelligence.recommendations.length > 0) {
                        html += '<div style="margin-top: 1rem;"><strong>Recommendations:</strong></div>';
                        pricingIntelligence.recommendations.forEach((rec) => {
                            const priceMatch = rec.match(/(\d+)/);
                            const price = priceMatch ? priceMatch[1] : null;
                            
                            html += `
                                <div class="pricing-recommendation" onclick="app.useRecommendedPrice('${price}')">
                                    <div class="pricing-recommendation-title">${rec}</div>
                                    ${price ? '<div class="pricing-recommendation-desc">Click to use this price</div>' : ''}
                                </div>
                            `;
                        });
                    }
                    
                    pricingCard.innerHTML = html;
                } else {
                    pricingSection.style.display = 'none';
                }

                // Show Post to eBay button if platform is eBay
                const postBtn = document.getElementById('postToEbayBtn');
                if (platform === 'ebay') {
                    postBtn.style.display = 'block';
                } else {
                    postBtn.style.display = 'none';
                }

                // Show Vinted Autofill button if platform is Vinted
                const vintedBtn = document.getElementById('vintedAutofillBtn');
                if (platform === 'vinted') {
                    vintedBtn.style.display = 'block';
                } else {
                    vintedBtn.style.display = 'none';
                }

                // Display stock image if found
                this.displayStockImage(stockImageData || listing.stockImageData);

                // Calculate and display SEO score
                const seoScore = this.calculateSEOScore(listing);
                this.displaySEOScore(seoScore);
            },

            // Calculate SEO score for a listing
            calculateSEOScore(listing) {
                let score = 0;
                let feedback = [];
                const platform = document.getElementById('platformSelect')?.value || 'vinted';

                // Title checks (30 points)
                if (listing.title && listing.brand && listing.title.toLowerCase().includes(listing.brand.toLowerCase())) {
                    score += 10;
                } else {
                    feedback.push('Add brand name to title');
                }

                if (listing.title && listing.title.length >= 40) {
                    score += 10;
                } else {
                    feedback.push('Title too short - add more descriptive keywords (aim for 40+ chars)');
                }

                if (listing.title) {
                    const titleWords = listing.title.toLowerCase().split(' ');
                    const fillerWords = ['amazing', 'wow', 'look', 'rare', 'gorgeous', 'stunning'];
                    if (!titleWords.some(w => fillerWords.includes(w))) {
                        score += 10;
                    } else {
                        feedback.push('Remove filler words from title (amazing, wow, etc.)');
                    }
                }

                // Description checks (30 points)
                if (listing.description && listing.description.length >= 150) {
                    score += 10;
                } else {
                    feedback.push('Add more detail to description (min 150 characters)');
                }

                if (listing.description && (listing.description.includes('') || listing.description.includes('-') || listing.description.includes('**Key Features:**'))) {
                    score += 10; // Bullet points
                } else {
                    feedback.push('Use bullet points for better readability');
                }

                const keywordDensity = this.calculateKeywordDensity(listing.description || '', listing.keywords || []);
                if (keywordDensity >= 2 && keywordDensity <= 5) {
                    score += 10; // Natural keyword usage
                } else if (keywordDensity > 5) {
                    feedback.push('Too many keywords - looks like spam (aim for 2-5%)');
                } else {
                    feedback.push('Add more relevant keywords to description (aim for 2-5% density)');
                }

                // Keywords check (20 points)
                const keywords = listing.keywords || [];
                if (keywords.length >= 8) {
                    score += 10;
                } else {
                    feedback.push(`Add more keywords (currently ${keywords.length}, aim for 8-15)`);
                }

                if (keywords.length <= 20) {
                    score += 10;
                } else {
                    feedback.push('Too many keywords - keep it focused (max 20)');
                }

                // Category check (10 points)
                if (listing.category && (listing.category.includes('>') || listing.category.includes('/'))) {
                    score += 10; // Specific category
                } else {
                    feedback.push('Use more specific category path');
                }

                // Pricing check (10 points)
                if (listing.rrp && listing.price) {
                    const rrpNum = parseFloat(listing.rrp.replace(/[^\d.]/g, ''));
                    const priceNum = parseFloat(listing.price.replace(/[^\d.]/g, ''));
                    if (priceNum < rrpNum && priceNum > 0) {
                        score += 10;
                    }
                }

                return {
                    score: Math.min(score, 100),
                    grade: score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D',
                    feedback: feedback
                };
            },

            // Calculate keyword density in text
            calculateKeywordDensity(text, keywords) {
                if (!text || !keywords || keywords.length === 0) return 0;

                const textLower = text.toLowerCase();
                const words = textLower.split(/\s+/).filter(w => w.length > 0);
                let keywordCount = 0;

                keywords.forEach(kw => {
                    const regex = new RegExp(kw.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    const matches = textLower.match(regex);
                    if (matches) keywordCount += matches.length;
                });

                return words.length > 0 ? (keywordCount / words.length) * 100 : 0;
            },

            // Display SEO score
            displaySEOScore(seoScore) {
                let seoSection = document.getElementById('seoScoreSection');

                // Create section if it doesn't exist
                if (!seoSection) {
                    const resultState = document.getElementById('resultState');
                    if (resultState) {
                        seoSection = document.createElement('div');
                        seoSection.id = 'seoScoreSection';
                        seoSection.className = 'result-card';
                        seoSection.style.marginTop = '1.5rem';
                        resultState.insertBefore(seoSection, resultState.firstChild);
                    } else {
                        return; // Can't display if no result state
                    }
                }

                const gradeColors = {
                    'A': 'var(--success)',
                    'B': '#10b981',
                    'C': 'var(--warning)',
                    'D': 'var(--error)'
                };

                let html = `
                    <div class="seo-score-card">
                        <div class="seo-score-header">
                            <h3 style="margin: 0;">SEO Score</h3>
                            <div class="score-badge" style="background: ${gradeColors[seoScore.grade]}; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; font-size: 1.25rem;">
                                ${seoScore.score}/100 (${seoScore.grade})
                            </div>
                        </div>
                `;

                if (seoScore.feedback.length > 0) {
                    html += '<div class="seo-feedback" style="margin-top: 1rem;">';
                    html += '<h4 style="font-size: 1rem; margin-bottom: 0.5rem;">Suggestions for Improvement:</h4>';
                    seoScore.feedback.forEach(item => {
                        html += `
                            <div class="feedback-item" style="padding: 0.5rem; margin-bottom: 0.5rem; background: var(--bg-tertiary); border-radius: 6px; display: flex; gap: 0.5rem; align-items: start;">
                                <span style="color: var(--warning);"></span>
                                <span>${item}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--accent-indigo-light); border-radius: 8px; color: var(--success);">
                            <strong>Excellent!</strong> Your listing is well-optimized for search engines.
                        </div>
                    `;
                }

                html += '</div>';
                seoSection.innerHTML = html;
            },

            // Display stock image section
            displayStockImage(stockImageData) {
                // Find or create stock image section
                let stockImageSection = document.getElementById('stockImageSection');
                if (!stockImageSection) {
                    const resultState = document.getElementById('resultState');
                    if (resultState) {
                        stockImageSection = document.createElement('div');
                        stockImageSection.id = 'stockImageSection';
                        stockImageSection.className = 'result-card';
                        stockImageSection.style.marginTop = '1.5rem';
                        resultState.appendChild(stockImageSection);
                    } else {
                        return;
                    }
                }

                if (!stockImageData || !stockImageData.stockImageUrl) {
                    stockImageSection.style.display = 'none';
                    return;
                }

                stockImageSection.style.display = 'block';
                const confidenceBadge = stockImageData.confidence === 'HIGH' ? '<span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Verified</span>' : '';
                const sourceText = stockImageData.source ? ` from ${stockImageData.source}` : '';
                
                stockImageSection.innerHTML = `
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center;">
                        Official Stock Image Found${confidenceBadge}
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; margin-bottom: 1rem;">
                        <div>
                            <img src="${stockImageData.stockImageUrl}" 
                                 alt="Stock image" 
                                 style="width: 100%; border-radius: 8px; border: 1px solid var(--border-color);"
                                 onerror="this.style.display='none'; document.getElementById('stockImageError').style.display='block';">
                            <div id="stockImageError" style="display: none; padding: 2rem; text-align: center; color: var(--text-muted); border: 1px dashed var(--border-color); border-radius: 8px;">
                                Image failed to load
                            </div>
                        </div>
                        <div>
                            <p style="color: var(--text-secondary); margin-bottom: 0.75rem;">
                                <strong>Source:</strong> ${stockImageData.source || 'Unknown'}${sourceText}
                            </p>
                            <p style="color: var(--text-secondary); margin-bottom: 0.75rem;">
                                <strong>Confidence:</strong> ${stockImageData.confidence || 'LOW'}
                            </p>
                            ${stockImageData.alternatives && stockImageData.alternatives.length > 0 ? `
                                <p style="color: var(--text-secondary); margin-bottom: 0.75rem;">
                                    <strong>Alternatives:</strong> ${stockImageData.alternatives.length} found
                                </p>
                            ` : ''}
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">
                                <button class="btn btn-primary" onclick="app.openStockImage('${stockImageData.stockImageUrl}')">
                                    View Full Size
                                </button>
                                <button class="btn btn-secondary" onclick="app.downloadStockImage('${stockImageData.stockImageUrl}', '${(document.getElementById('outputTitle').value || 'product').replace(/[^a-z0-9]/gi, '_')}')">
                                    Download Image
                                </button>
                                ${stockImageData.alternatives && stockImageData.alternatives.length > 0 ? `
                                    <button class="btn btn-secondary" onclick="app.showStockImageAlternatives(${JSON.stringify(stockImageData.alternatives).replace(/"/g, '&quot;')})">
                                        View Alternatives
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            // Open stock image in new tab
            openStockImage(url) {
                window.open(url, '_blank');
            },

            // Download stock image
            async downloadStockImage(url, filename) {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = `${filename}_stock.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(downloadUrl);
                    this.showToast('Stock image downloaded!');
                } catch (error) {
                    console.error('Download error:', error);
                    this.showToast('Failed to download image', 'error');
                }
            },

            // Feature 4 & 5: Display pricing intelligence
            displayPricingIntelligence(pricingData, listing) {
                if (!pricingData) return;

                // Find or create pricing section
                let pricingSection = document.getElementById('pricingIntelligenceSection');
                if (!pricingSection) {
                    const resultState = document.getElementById('resultState');
                    if (resultState) {
                        pricingSection = document.createElement('div');
                        pricingSection.id = 'pricingIntelligenceSection';
                        pricingSection.className = 'result-card';
                        pricingSection.style.marginTop = '1.5rem';
                        // Insert after the main result card but before SEO score
                        const seoSection = document.getElementById('seoScoreSection');
                        if (seoSection) {
                            resultState.insertBefore(pricingSection, seoSection);
                        } else {
                            resultState.appendChild(pricingSection);
                        }
                    } else {
                        return;
                    }
                }

                const hasValidData = pricingData.soldCount > 0;
                const predictedPrice = listing.pricingConfidence ? {
                    recommendedPrice: parseFloat(listing.price.replace('', '')),
                    confidence: listing.pricingConfidence,
                    reasoning: listing.pricingReasoning,
                    marketInsights: listing.marketInsights
                } : null;

                pricingSection.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                             eBay Pricing Intelligence
                            ${hasValidData ? `<span style="font-size: 0.8rem; color: var(--text-muted);">(${pricingData.totalResults} listings analyzed)</span>` : ''}
                        </h3>
                    </div>

                    ${hasValidData ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Average Sold Price</div>
                                <div style="color: var(--text-primary); font-size: 1.5rem; font-weight: 600;">
                                    ${pricingData.soldPrices.average.toFixed(2)}
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Median Sold Price</div>
                                <div style="color: var(--text-primary); font-size: 1.5rem; font-weight: 600;">
                                    ${pricingData.soldPrices.median.toFixed(2)}
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Sell-Through Rate</div>
                                <div style="color: ${pricingData.sellThroughRate > 0.7 ? 'var(--success-color)' : pricingData.sellThroughRate > 0.4 ? 'var(--warning-color)' : 'var(--error-color)'}; font-size: 1.5rem; font-weight: 600;">
                                    ${(pricingData.sellThroughRate * 100).toFixed(0)}%
                                </div>
                            </div>
                            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Price Range</div>
                                <div style="color: var(--text-primary); font-size: 1.5rem; font-weight: 600;">
                                    ${pricingData.soldPrices.min.toFixed(0)}-${pricingData.soldPrices.max.toFixed(0)}
                                </div>
                            </div>
                        </div>

                        ${predictedPrice ? `
                            <div style="background: linear-gradient(135deg, var(--accent-indigo), var(--accent-purple)); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                                <h4 style="margin: 0 0 1rem 0; color: white;"> AI-Optimized Pricing</h4>
                                <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                                    <div>
                                        <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-bottom: 0.25rem;">Recommended Price</div>
                                        <div style="color: white; font-size: 2rem; font-weight: 700;">
                                            ${predictedPrice.recommendedPrice.toFixed(2)}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="color: rgba(255,255,255,0.8); font-size: 0.85rem; margin-bottom: 0.25rem;">Confidence</div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="background: rgba(255,255,255,0.2); height: 8px; width: 100px; border-radius: 4px; overflow: hidden;">
                                                <div style="background: white; height: 100%; width: ${predictedPrice.confidence}%; transition: width 0.3s;"></div>
                                            </div>
                                            <span style="color: white; font-weight: 600;">${predictedPrice.confidence}%</span>
                                        </div>
                                    </div>
                                </div>
                                ${predictedPrice.marketInsights ? `
                                    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                        <span style="background: rgba(255,255,255,0.2); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                                            Demand: ${predictedPrice.marketInsights.demand}
                                        </span>
                                        <span style="background: rgba(255,255,255,0.2); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                                            Competition: ${predictedPrice.marketInsights.competition}
                                        </span>
                                        <span style="background: rgba(255,255,255,0.2); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                                            ${predictedPrice.marketInsights.recommendedAction}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: var(--text-primary); margin-bottom: 1rem;">Pricing Strategy Options</h4>
                            <div style="display: grid; gap: 0.75rem;">
                                ${pricingData.pricePoints.map(pp => `
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; transition: background 0.2s;"
                                         onclick="document.getElementById('outputPrice').value = '${pp.price.toFixed(2)}'; app.showToast('Price updated to ${pp.price.toFixed(2)}', 'success');">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div>
                                                <div style="color: var(--text-primary); font-weight: 600;">${pp.price.toFixed(2)}</div>
                                                <div style="color: var(--text-muted); font-size: 0.85rem;">${pp.label}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: ${pp.sellProbability > 0.7 ? 'var(--success-color)' : pp.sellProbability > 0.5 ? 'var(--warning-color)' : 'var(--text-muted)'}; font-weight: 600;">
                                                ${(pp.sellProbability * 100).toFixed(0)}%
                                            </div>
                                            <div style="color: var(--text-muted); font-size: 0.75rem;">sell probability</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        ${pricingData.soldExamples && pricingData.soldExamples.length > 0 ? `
                            <div>
                                <h4 style="color: var(--text-primary); margin-bottom: 1rem;">Recently Sold Similar Items</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    ${pricingData.soldExamples.slice(0, 3).map(ex => `
                                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                                            <a href="${ex.url}" target="_blank" style="color: var(--accent-indigo); text-decoration: none; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                ${ex.title}
                                            </a>
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-left: 1rem;">
                                                <span style="color: var(--success-color); font-weight: 600;">${ex.price}</span>
                                                <span style="color: var(--text-muted); font-size: 0.85rem;">${new Date(ex.endDate).toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${predictedPrice && predictedPrice.reasoning ? `
                            <details style="margin-top: 1rem;">
                                <summary style="cursor: pointer; color: var(--accent-indigo); font-weight: 500;">
                                    How we calculated your price...
                                </summary>
                                <ul style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.9rem; padding-left: 1.5rem;">
                                    ${predictedPrice.reasoning.map(r => `<li>${r}</li>`).join('')}
                                </ul>
                            </details>
                        ` : ''}
                    ` : `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <p>No pricing data available for this item</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Try a more generic title or select eBay as the platform</p>
                        </div>
                    `}
                `;
            },

            // Show stock image alternatives
            showStockImageAlternatives(alternatives) {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Alternative Stock Images</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            ${alternatives.map((url, index) => `
                                <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                                    <img src="${url}" alt="Alternative ${index + 1}" 
                                         style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                         onclick="window.open('${url}', '_blank')"
                                         onerror="this.parentElement.style.display='none'">
                                    <div style="padding: 0.5rem; text-align: center;">
                                        <button class="btn btn-secondary" style="width: 100%; font-size: 0.875rem;" 
                                                onclick="app.downloadStockImage('${url}', 'alternative_${index + 1}')">
                                            Download
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            // Use recommended price
            useRecommendedPrice(price) {
                if (price) {
                    document.getElementById('outputPrice').value = `${price}`;
                    this.showToast('Price updated!');
                }
            },

            // Process batch
            // Batch processing removed - feature was non-functional with mock data
            // To implement properly, would need to:
            // 1. Process multiple images separately
            // 2. Generate listings for each
            // 3. Allow user to review/edit each before saving
            // This is a larger feature that should be planned separately

            // Show confirmation modal
            showConfirmationModal() {
                const modal = document.getElementById('confirmationModal');
                const grid = document.getElementById('confirmationGrid');

                grid.innerHTML = this.state.multipleItemsDetected.map(item => `
                    <div class="confirmation-item ${item.id === this.state.selectedConfirmationItem ? 'selected' : ''}"
                         onclick="app.selectConfirmationItem(${item.id})">
                        <img src="${item.image}" alt="${item.title}">
                        <div class="confirmation-item-title">${item.title}</div>
                        <div class="confirmation-item-price">${item.price}</div>
                    </div>
                `).join('');

                modal.classList.add('active');
            },

            // Close confirmation modal
            closeConfirmationModal() {
                document.getElementById('confirmationModal').classList.remove('active');
            },

            // Select confirmation item
            selectConfirmationItem(id) {
                this.state.selectedConfirmationItem = id;
                this.showConfirmationModal(); // Re-render
            },

            // Confirm selection
            confirmSelection() {
                if (!this.state.selectedConfirmationItem) {
                    this.showToast('Please select an item', 'warning');
                    return;
                }
                this.closeConfirmationModal();
                this.generateListing();
            },

            // Show product selection modal (for uncertain matches)
            showProductSelectionModal(primaryMatch, alternatives) {
                const modal = document.getElementById('productSelectionModal');
                const grid = document.getElementById('productAlternativesGrid');
                
                const allOptions = [primaryMatch, ...alternatives];
                
                grid.innerHTML = allOptions.map((option, index) => `
                    <div class="confirmation-item ${index === this.state.selectedProductIndex ? 'selected' : ''}"
                         onclick="app.selectProductAlternative(${index})"
                         style="border: 2px solid ${index === this.state.selectedProductIndex ? 'var(--primary)' : 'var(--border-color)'}; border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s;">
                        ${index === 0 ? '<div style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem; display: inline-block;">Best Match</div>' : ''}
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">${option.title || 'Unknown Product'}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">${option.brand || 'Unknown Brand'}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${option.category || 'Unknown Category'}</div>
                        ${option.matchReason ? `<div style="font-size: 0.75rem; color: var(--text-muted); font-style: italic; margin-top: 0.5rem;">${option.matchReason}</div>` : ''}
                        ${option.price ? `<div style="font-weight: 600; color: var(--primary); margin-top: 0.5rem;">${option.price}</div>` : ''}
                    </div>
                `).join('');
                
                modal.classList.add('active');
            },

            // Close product selection modal
            closeProductSelectionModal() {
                document.getElementById('productSelectionModal').classList.remove('active');
            },

            // Select product alternative
            selectProductAlternative(index) {
                this.state.selectedProductIndex = index;
                const primaryMatch = this.state.productAlternatives[0];
                const alternatives = this.state.productAlternatives.slice(1);
                this.showProductSelectionModal(primaryMatch, alternatives);
            },

            // Confirm product selection and display listing
            confirmProductSelection() {
                if (this.state.selectedProductIndex === undefined || !this.state.productAlternatives) {
                    this.showToast('Please select a product', 'warning');
                    return;
                }
                
                const selectedListing = this.state.productAlternatives[this.state.selectedProductIndex];
                const platform = document.getElementById('platformSelect').value;
                
                // Store the selected listing
                this.state.currentListing = {
                    ...selectedListing,
                    images: this.state.uploadedImages,
                    platform: platform,
                    id: Date.now(),
                    pricingIntelligence: null // Will need to fetch if needed
                };
                
                // Close modal
                this.closeProductSelectionModal();
                
                // Display the selected listing (with stock image if available)
                const stockImageData = selectedListing.stockImageData || null;
                this.displayListing(selectedListing, null, stockImageData);
                
                // Show result state
                const resultState = document.getElementById('resultState');
                const loadingState = document.getElementById('loadingState');
                loadingState.classList.add('hidden');
                resultState.classList.remove('hidden');
                
                // Clear alternatives
                this.state.productAlternatives = null;
                this.state.selectedProductIndex = undefined;
            },

            // Copy field
            async copyField(fieldName) {
                const fieldMap = {
                    title: 'outputTitle',
                    brand: 'outputBrand',
                    category: 'outputCategory',
                    description: 'outputDescription',
                    condition: 'outputCondition',
                    rrp: 'outputRRP',
                    price: 'outputPrice'
                };

                const element = document.getElementById(fieldMap[fieldName]);
                if (element) {
                    try {
                        await navigator.clipboard.writeText(element.value);
                        this.showToast('Copied!');
                    } catch (error) {
                        // Fallback to old method for older browsers
                        element.select();
                        document.execCommand('copy');
                        this.showToast('Copied!');
                    }
                }
            },

            // Copy all
            async copyAll() {
                const title = document.getElementById('outputTitle').value;
                const brand = document.getElementById('outputBrand').value;
                const category = document.getElementById('outputCategory').value;
                const description = document.getElementById('outputDescription').value;
                const condition = document.getElementById('outputCondition').value;
                const rrp = document.getElementById('outputRRP').value;
                const price = document.getElementById('outputPrice').value;

                const allText = `
Title: ${title}
Brand: ${brand}
Category: ${category}
Condition: ${condition}
RRP: ${rrp}
Price: ${price}

Description:
${description}
                `.trim();

                try {
                    await navigator.clipboard.writeText(allText);
                    this.showToast('All fields copied!');
                } catch (error) {
                    // Fallback to old method for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = allText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    this.showToast('All fields copied!');
                }
            },

            // Regenerate keywords
            async regenerateKeywords() {
                const container = document.getElementById('keywordsTags');
                container.innerHTML = '<span class="spinner"></span> Regenerating...';

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));

                const newKeywords = [
                    '#fashion', '#vintage', '#preloved', '#sustainable',
                    '#designer', '#bargain', '#quality', '#style',
                    '#trendy', '#musthave'
                ];

                container.innerHTML = newKeywords
                    .map(kw => `<span class="tag">${kw}</span>`)
                    .join('');
            },

            // Select best image for hero (simple heuristic: first non-blurry image)
            selectBestImage() {
                const nonBlurry = this.state.uploadedImages.filter(img => !img.isBlurry);
                return nonBlurry.length > 0 ? nonBlurry[0] : this.state.uploadedImages[0];
            },

            // Generate hero image with nanobanana or fallback
            async generateHeroImage(imageFile) {
                // Note: Add NANOBANANA_API_KEY to .env if using nanobanana service
                // For now, using fallback method
                return await this.createHeroImageFallback(imageFile);
            },

            // Fallback hero image creation
            async createHeroImageFallback(imageFile) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 1200;
                        canvas.height = 1200;
                        const ctx = canvas.getContext('2d');
                        
                        // Create neutral studio background
                        ctx.fillStyle = '#F5F5F5';
                        ctx.fillRect(0, 0, 1200, 1200);
                        
                        // Calculate image size to fit (80% of canvas)
                        const maxSize = 960;
                        let width = img.width;
                        let height = img.height;
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width *= ratio;
                        height *= ratio;
                        
                        // Center image
                        const x = (1200 - width) / 2;
                        const y = (1200 - height) / 2;
                        
                        // Draw image with shadow
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetY = 10;
                        ctx.drawImage(img, x, y, width, height);
                        
                        canvas.toBlob(resolve, 'image/jpeg', 0.95);
                    };
                    img.src = URL.createObjectURL(imageFile);
                });
            },

            // Fix blur in image using canvas sharpening
            async fixBlur(imageFile) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        ctx.drawImage(img, 0, 0);
                        
                        // Apply unsharp mask for sharpening
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        // Simple sharpening kernel
                        for (let i = 0; i < data.length; i += 4) {
                            // Apply slight sharpening
                            const r = data[i];
                            const g = data[i + 1];
                            const b = data[i + 2];
                            
                            // Increase contrast slightly
                            data[i] = Math.min(255, r * 1.1);
                            data[i + 1] = Math.min(255, g * 1.1);
                            data[i + 2] = Math.min(255, b * 1.1);
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        canvas.toBlob(resolve, 'image/jpeg', 0.92);
                    };
                    img.src = URL.createObjectURL(imageFile);
                });
            },

            // Auto-enhance image (brightness, contrast, color balance)
            async autoEnhanceImage(imageFile) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        ctx.drawImage(img, 0, 0);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        // Calculate average brightness
                        let totalBrightness = 0;
                        for (let i = 0; i < data.length; i += 4) {
                            totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
                        }
                        const avgBrightness = totalBrightness / (data.length / 4);
                        const brightnessAdjust = 128 - avgBrightness; // Target brightness
                        
                        // Apply enhancements
                        for (let i = 0; i < data.length; i += 4) {
                            // Brightness adjustment
                            data[i] = Math.min(255, Math.max(0, data[i] + brightnessAdjust * 0.3));
                            data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + brightnessAdjust * 0.3));
                            data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + brightnessAdjust * 0.3));
                            
                            // Contrast enhancement
                            const factor = 1.1;
                            data[i] = Math.min(255, Math.max(0, (data[i] - 128) * factor + 128));
                            data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * factor + 128));
                            data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * factor + 128));
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        canvas.toBlob(resolve, 'image/jpeg', 0.92);
                    };
                    img.src = URL.createObjectURL(imageFile);
                });
            },

            // Generate HTML replica of listing
            generateListingHTML() {
                // Safety check: ensure we're in the app view and form elements exist
                const titleEl = document.getElementById('outputTitle');
                const brandEl = document.getElementById('outputBrand');
                
                if (!titleEl || !brandEl) {
                    console.warn('generateListingHTML called but form elements not found');
                    return '<html><body><p>Listing data not available</p></body></html>';
                }
                
                const title = titleEl.value || '';
                const brand = brandEl.value || '';
                const category = document.getElementById('outputCategory')?.value || '';
                const description = document.getElementById('outputDescription')?.value || '';
                const condition = document.getElementById('outputCondition')?.value || '';
                const rrp = document.getElementById('outputRRP')?.value || '';
                const price = document.getElementById('outputPrice')?.value || '';
                const keywords = this.state.currentListing?.keywords || [];
                
                return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title} - QuickList AI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            padding: 2rem;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1e293b;
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid #334155;
        }
        h1 { color: #6366f1; margin-bottom: 1rem; font-size: 2rem; }
        .field {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #334155;
        }
        .field:last-child { border-bottom: none; }
        .field-label {
            font-weight: 600;
            color: #cbd5e1;
            margin-bottom: 0.5rem;
            display: block;
        }
        .field-value {
            color: #f1f5f9;
            font-size: 1.1rem;
        }
        .field-value.textarea {
            white-space: pre-wrap;
            background: #0f172a;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .copy-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 0.5rem;
            transition: background 0.2s;
        }
        .copy-btn:hover { background: #4f46e5; }
        .copy-btn.copied { background: #10b981; }
        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .keyword-tag {
            background: rgba(99, 102, 241, 0.2);
            color: #6366f1;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${title.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h1>
        
        <div class="field">
            <span class="field-label">Brand:</span>
            <span class="field-value">${brand.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
            <button class="copy-btn" onclick="copyToClipboard('${brand.replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;')}')">Copy</button>
        </div>
        
        <div class="field">
            <span class="field-label">Category:</span>
            <span class="field-value">${category.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
            <button class="copy-btn" onclick="copyToClipboard('${category.replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;')}')">Copy</button>
        </div>
        
        <div class="field">
            <span class="field-label">Condition:</span>
            <span class="field-value">${condition.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
            <button class="copy-btn" onclick="copyToClipboard('${condition.replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;')}')">Copy</button>
        </div>
        
        <div class="field">
            <span class="field-label">RRP:</span>
            <span class="field-value">${rrp.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
            <button class="copy-btn" onclick="copyToClipboard('${rrp.replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;')}')">Copy</button>
        </div>
        
        <div class="field">
            <span class="field-label">Price:</span>
            <span class="field-value">${price.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
            <button class="copy-btn" onclick="copyToClipboard('${price.replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;')}')">Copy</button>
        </div>
        
        <div class="field">
            <span class="field-label">Description:</span>
            <div class="field-value textarea">${description.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</div>
            <button class="copy-btn" onclick="copyToClipboard('${description.replace(/'/g, "\\'").replace(/\\/g, '\\\\').replace(/\n/g, '\\n')}')">Copy</button>
        </div>
        
        <div class="field">
            <span class="field-label">Keywords:</span>
            <div class="keywords">
                ${keywords.map(kw => `<span class="keyword-tag">${kw.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>`).join('')}
            </div>
            <button class="copy-btn" onclick="copyToClipboard('${keywords.join(', ').replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;')}')">Copy All</button>
        </div>
    </div>
    
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                event.target.textContent = 'Copied!';
                event.target.classList.add('copied');
                setTimeout(() => {
                    event.target.textContent = 'Copy';
                    event.target.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                event.target.textContent = 'Copied!';
                setTimeout(() => {
                    event.target.textContent = 'Copy';
                }, 2000);
            });
        }
    <\/script>
</body>
</html>`;
            },

            // Download ZIP
            async downloadZip() {
                const btn = document.getElementById('downloadBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Processing images...';

                try {
                    const zip = new JSZip();
                    const imagesFolder = zip.folder('images');
                    const generateHero = document.getElementById('toggleHero').checked;
                    const fixBlur = document.getElementById('toggleBlur').checked;
                    const autoEnhance = document.getElementById('toggleEnhance').checked;

                    // Add listing details as text file
                    const listingText = `
Title: ${document.getElementById('outputTitle').value}
Brand: ${document.getElementById('outputBrand').value}
Category: ${document.getElementById('outputCategory').value}
Condition: ${document.getElementById('outputCondition').value}
RRP: ${document.getElementById('outputRRP').value}
Price: ${document.getElementById('outputPrice').value}

Description:
${document.getElementById('outputDescription').value}

Keywords:
${this.state.currentListing?.keywords?.join(', ')}
                    `.trim();

                    zip.file('listing-details.txt', listingText);

                    // Generate HTML replica
                    zip.file('listing.html', this.generateListingHTML());

                    // Process and add images
                    btn.innerHTML = '<span class="spinner"></span> Processing images...';
                    
                    let bestImage = null;
                    for (let i = 0; i < this.state.uploadedImages.length; i++) {
                        const img = this.state.uploadedImages[i];
                        let processedBlob = await fetch(img.url).then(r => r.blob());
                        
                        // Fix blur if needed
                        if (fixBlur && img.isBlurry) {
                            processedBlob = await this.fixBlur(img.file);
                        }
                        
                        // Auto-enhance if enabled
                        if (autoEnhance) {
                            processedBlob = await this.autoEnhanceImage(img.file);
                        }
                        
                        imagesFolder.file(`image-${i + 1}.jpg`, processedBlob);
                        
                        // Track best image for hero
                        if (!bestImage && !img.isBlurry) {
                            bestImage = img.file;
                        }
                    }

                    // Generate hero image if enabled
                    if (generateHero) {
                        btn.innerHTML = '<span class="spinner"></span> Generating hero image...';
                        const heroImage = bestImage || this.state.uploadedImages[0].file;
                        const heroBlob = await this.generateHeroImage(heroImage);
                        zip.file('hero.jpg', heroBlob);
                    }

                    // Generate ZIP
                    btn.innerHTML = '<span class="spinner"></span> Creating ZIP...';
                    const content = await zip.generateAsync({ type: 'blob' });

                    // Generate filename from first three words of title
                    const title = document.getElementById('outputTitle').value || 'quicklist';
                    const titleWords = title.trim().split(/\s+/).slice(0, 3);
                    const filename = titleWords
                        .map(word => word.replace(/[^a-z0-9]/gi, '').toLowerCase())
                        .filter(word => word.length > 0)
                        .join('-') || 'quicklist';
                    
                    // Download
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${filename}.zip`;
                    a.click();
                    URL.revokeObjectURL(url);

                    this.showToast('ZIP downloaded successfully!');
                    this.setWizardPhase('publish');

                } catch (error) {
                    console.error('Error creating ZIP:', error);
                    this.showToast('Error creating ZIP file: ' + error.message, 'error');
                }

                btn.disabled = false;
                btn.innerHTML = 'Download ZIP';
            },

            // Post listing to eBay
            async postToEbay() {
                if (!this.state.currentListing || !this.state.currentListing.id) {
                    this.showToast('Please save the listing first');
                    return;
                }

                const btn = document.getElementById('postToEbayBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Posting to eBay...';

                try {
                    const response = await fetch(`${this.apiUrl}/listings/${this.state.currentListing.id}/post-to-ebay`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Posting failed');
                    }

                    const data = await response.json();
                    this.showToast('Successfully posted to eBay!');
                    
                    // Open eBay listing in new tab
                    if (data.url) {
                        window.open(data.url, '_blank');
                    }
                    
                    // Update button
                    btn.innerHTML = ' Posted to eBay';
                    btn.style.background = 'var(--success)';
                    btn.disabled = true;
                    this.setWizardPhase('publish');
                    
                } catch (error) {
                    console.error('Post to eBay error:', error);
                    this.showToast(`Failed to post to eBay: ${error.message}`, 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'Post to eBay';
                }
            },

            // Open Vinted and generate autofill script
            openVintedAutofill() {
                // Get all listing data
                const listingData = {
                    title: document.getElementById('outputTitle').value,
                    brand: document.getElementById('outputBrand').value,
                    category: document.getElementById('outputCategory').value,
                    description: document.getElementById('outputDescription').value,
                    condition: document.getElementById('outputCondition').value,
                    price: document.getElementById('outputPrice').value.replace('', '').replace(',', ''),
                    keywords: this.state.currentListing?.keywords || [],
                    images: this.state.uploadedImages || []
                };

                // Generate bookmarklet script with enhanced features
                const script = this.generateVintedBookmarklet(listingData);
                
                // Open Vinted in new tab
                window.open('https://www.vinted.co.uk/items/new', '_blank');
                
                // Show instructions modal
                this.showVintedAutofillInstructions(script, listingData.images.length);
                this.setWizardPhase('publish');
            },

            // Generate Vinted bookmarklet script - Enhanced version for Vinted's React form structure
            generateVintedBookmarklet(listingData) {
                // Escape data for JavaScript
                const escapeJS = (str) => str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/"/g, '\\"').replace(/\r/g, '');
                
                // Map condition to Vinted format
                const mapCondition = (condition) => {
                    const cond = condition.toLowerCase();
                    if (cond.includes('new with tags') || cond.includes('new')) return 'new_with_tags';
                    if (cond.includes('like new') || cond.includes('excellent')) return 'new_without_tags';
                    if (cond.includes('very good')) return 'very_good';
                    if (cond.includes('good')) return 'good';
                    if (cond.includes('satisfactory') || cond.includes('fair')) return 'satisfactory';
                    return 'good';
                };
                
                // Extract size from title/category if present
                const extractSize = (title, category) => {
                    const combined = (title + ' ' + category).toLowerCase();
                    const sizePatterns = [
                        /(?:size|sz)[:\s]*([0-9]+[a-z]?|[xsml]+|uk\s*[0-9]+|eu\s*[0-9]+)/i,
                        /(uk|eu|us)\s*([0-9]+)/i,
                        /([0-9]+)\s*(ml|fl\s*oz|oz)/i
                    ];
                    for (const pattern of sizePatterns) {
                        const match = combined.match(pattern);
                        if (match) {
                            // Return the original case from title/category
                            const originalMatch = (title + ' ' + category).match(new RegExp(pattern.source, 'i'));
                            if (originalMatch) return originalMatch[0].trim();
                        }
                    }
                    return null;
                };
                
                // Parse Vinted category path (e.g., "Women > Clothing > Dresses")
                const parseCategoryPath = (categoryPath) => {
                    if (!categoryPath) return null;
                    const parts = categoryPath.split('>').map(p => p.trim());
                    return {
                        main: parts[0] || null,
                        sub: parts[1] || null,
                        detail: parts[2] || null
                    };
                };
                
                // Pre-calculate values
                const conditionMapped = mapCondition(listingData.condition);
                const extractedSize = extractSize(listingData.title, listingData.category) || '';
                const categoryParts = parseCategoryPath(listingData.category);
                
                return `javascript:(function(){
                    const data = {
                        title: '${escapeJS(listingData.title)}',
                        brand: '${escapeJS(listingData.brand)}',
                        category: '${escapeJS(listingData.category)}',
                        categoryMain: '${categoryParts?.main ? escapeJS(categoryParts.main) : ''}',
                        categorySub: '${categoryParts?.sub ? escapeJS(categoryParts.sub) : ''}',
                        categoryDetail: '${categoryParts?.detail ? escapeJS(categoryParts.detail) : ''}',
                        description: '${escapeJS(listingData.description)}',
                        condition: '${escapeJS(listingData.condition)}',
                        price: '${listingData.price}',
                        conditionMapped: '${conditionMapped}',
                        size: '${escapeJS(extractedSize)}',
                        imageCount: ${listingData.images?.length || 0}
                    };
                    
                    let filledCount = 0;
                    const maxRetries = 10;
                    let retryCount = 0;
                    
                    // Show notification overlay
                    const showNotification = (message, type = 'info') => {
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: ' + (type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6') + '; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10000; font-family: system-ui; font-size: 14px; max-width: 300px;';
                        notification.textContent = message;
                        document.body.appendChild(notification);
                        setTimeout(() => notification.remove(), 3000);
                    };
                    
                    // Helper to trigger React events properly
                    const setReactValue = (element, value) => {
                        if (!element) return false;
                        const nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;
                        const nativeTextAreaValueSetter = Object.getOwnPropertyDescriptor(window.HTMLTextAreaElement.prototype, 'value').set;
                        
                        if (element.tagName === 'INPUT') {
                            nativeInputValueSetter.call(element, value);
                        } else if (element.tagName === 'TEXTAREA') {
                            nativeTextAreaValueSetter.call(element, value);
                        } else {
                            element.value = value;
                        }
                        
                        // Trigger React events
                        const inputEvent = new Event('input', { bubbles: true, cancelable: true });
                        const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                        element.dispatchEvent(inputEvent);
                        element.dispatchEvent(changeEvent);
                        
                        // Also try React's synthetic events
                        const reactInputEvent = new Event('input', { bubbles: true });
                        Object.defineProperty(reactInputEvent, 'target', { value: element, enumerable: true });
                        element.dispatchEvent(reactInputEvent);
                        
                        return true;
                    };
                    
                    // Fill field with retry logic
                    const fillField = (selectors, value, fieldName) => {
                        for (const selector of selectors) {
                            const element = document.querySelector(selector);
                            if (element && (!element.value || element.value.trim() === '')) {
                                if (setReactValue(element, value)) {
                                    filledCount++;
                                    console.log(' Filled ' + fieldName);
                                    return true;
                                }
                            }
                        }
                        return false;
                    };
                    
                    // Fill brand (Vinted uses searchable brand selector)
                    const fillBrand = () => {
                        // Try Vinted's brand input field
                        const brandSelectors = [
                            'input[data-testid*="brand"]',
                            'input[placeholder*="brand" i]',
                            'input[name*="brand" i]',
                            '[data-testid*="brand-search"] input',
                            'input[aria-label*="brand" i]'
                        ];
                        
                        for (const selector of brandSelectors) {
                            const brandInput = document.querySelector(selector);
                            if (brandInput) {
                                setReactValue(brandInput, data.brand);
                                
                                // Trigger input events to show suggestions
                                brandInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'a', bubbles: true }));
                                brandInput.dispatchEvent(new KeyboardEvent('keyup', { key: 'a', bubbles: true }));
                                brandInput.dispatchEvent(new KeyboardEvent('input', { bubbles: true }));
                                
                                // Wait and try to select matching brand from dropdown
                                setTimeout(() => {
                                    const brandOptions = document.querySelectorAll('[role="option"], [data-testid*="brand-item"], .brand-option, [class*="brand-option"]');
                                    for (const option of brandOptions) {
                                        const optionText = (option.textContent || option.getAttribute('aria-label') || '').toLowerCase();
                                        const brandLower = data.brand.toLowerCase();
                                        if (optionText.includes(brandLower) || brandLower.includes(optionText)) {
                                            option.click();
                                            console.log(' Selected brand from dropdown');
                                            return;
                                        }
                                    }
                                    // If no exact match, try first result
                                    if (brandOptions.length > 0) {
                                        brandOptions[0].click();
                                        console.log(' Selected first brand option');
                                    }
                                }, 800);
                                
                                filledCount++;
                                console.log(' Filled brand');
                                return true;
                            }
                        }
                        return false;
                    };
                    
                    // Fill condition
                    const fillCondition = () => {
                        const conditionSelectors = [
                            'button[data-testid*="condition"]',
                            'select[name*="condition" i]',
                            '[data-testid*="condition"]',
                            'button[aria-label*="condition" i]'
                        ];
                        
                        for (const selector of conditionSelectors) {
                            const conditionElement = document.querySelector(selector);
                            if (conditionElement) {
                                // Try to find and click the matching condition option
                                const conditionText = data.conditionMapped.replace('_', ' ');
                                const conditionButtons = document.querySelectorAll('button[data-testid*="condition"], [role="button"][aria-label*="condition" i]');
                                
                                for (const btn of conditionButtons) {
                                    const btnText = (btn.textContent || btn.getAttribute('aria-label') || '').toLowerCase();
                                    if (btnText.includes(conditionText) || btnText.includes(data.condition.toLowerCase())) {
                                        btn.click();
                                        filledCount++;
                                        console.log(' Filled condition');
                                        return true;
                                    }
                                }
                                
                                // Fallback: try select dropdown
                                if (conditionElement.tagName === 'SELECT') {
                                    const options = Array.from(conditionElement.options);
                                    for (const opt of options) {
                                        if (opt.text.toLowerCase().includes(data.condition.toLowerCase())) {
                                            conditionElement.value = opt.value;
                                            conditionElement.dispatchEvent(new Event('change', { bubbles: true }));
                                            filledCount++;
                                            console.log(' Filled condition');
                                            return true;
                                        }
                                    }
                                }
                            }
                        }
                        return false;
                    };
                    
                    // Fill size if available
                    const fillSize = () => {
                        if (!data.size) return false;
                        
                        const sizeSelectors = [
                            'select[name*="size" i]',
                            'button[data-testid*="size"]',
                            '[data-testid*="size"]',
                            'input[name*="size" i]',
                            'button[aria-label*="size" i]',
                            '[role="button"][aria-label*="size" i]'
                        ];
                        
                        for (const selector of sizeSelectors) {
                            const sizeElement = document.querySelector(selector);
                            if (sizeElement) {
                                if (sizeElement.tagName === 'SELECT') {
                                    const options = Array.from(sizeElement.options);
                                    for (const opt of options) {
                                        const optText = (opt.text || opt.value || '').toLowerCase();
                                        const sizeLower = data.size.toLowerCase();
                                        if (optText.includes(sizeLower) || sizeLower.includes(optText)) {
                                            sizeElement.value = opt.value;
                                            sizeElement.dispatchEvent(new Event('change', { bubbles: true }));
                                            filledCount++;
                                            console.log(' Filled size');
                                            return true;
                                        }
                                    }
                                } else if (sizeElement.tagName === 'BUTTON') {
                                    // Click button to open size selector
                                    sizeElement.click();
                                    setTimeout(() => {
                                        const sizeOptions = document.querySelectorAll('[role="option"], [data-testid*="size-option"], button[aria-label*="size" i]');
                                        for (const opt of sizeOptions) {
                                            const optText = (opt.textContent || opt.getAttribute('aria-label') || '').toLowerCase();
                                            const sizeLower = data.size.toLowerCase();
                                            if (optText.includes(sizeLower) || sizeLower.includes(optText)) {
                                                opt.click();
                                                filledCount++;
                                                console.log(' Filled size');
                                                return;
                                            }
                                        }
                                    }, 300);
                                    return true;
                                } else if (sizeElement.tagName === 'INPUT') {
                                    setReactValue(sizeElement, data.size);
                                    filledCount++;
                                    console.log(' Filled size');
                                    return true;
                                }
                            }
                        }
                        return false;
                    };
                    
                    // Fill category - Navigate Vinted's category tree
                    const fillCategory = () => {
                        if (!data.categoryMain) return false;
                        
                        // Try to find and click category buttons
                        const categorySelectors = [
                            'button[data-testid*="category"]',
                            'button[aria-label*="category" i]',
                            '[role="button"][aria-label*="category" i]',
                            'button:has-text("' + data.categoryMain + '")'
                        ];
                        
                        // First, try to find main category
                        const findAndClickCategory = (categoryText, level) => {
                            if (!categoryText) return false;
                            
                            const buttons = document.querySelectorAll('button, [role="button"]');
                            for (const btn of buttons) {
                                const btnText = (btn.textContent || btn.getAttribute('aria-label') || '').toLowerCase();
                                const catLower = categoryText.toLowerCase();
                                
                                // Check if button text matches category
                                if (btnText.includes(catLower) || catLower.includes(btnText)) {
                                    // Check if it's visible and clickable
                                    const rect = btn.getBoundingClientRect();
                                    if (rect.width > 0 && rect.height > 0) {
                                        btn.click();
                                        console.log(' Clicked category level ' + level + ': ' + categoryText);
                                        filledCount++;
                                        
                                        // Wait for next level to appear, then continue
                                        setTimeout(() => {
                                            if (level === 1 && data.categorySub) {
                                                setTimeout(() => findAndClickCategory(data.categorySub, 2), 500);
                                            } else if (level === 2 && data.categoryDetail) {
                                                setTimeout(() => findAndClickCategory(data.categoryDetail, 3), 500);
                                            }
                                        }, 500);
                                        
                                        return true;
                                    }
                                }
                            }
                            return false;
                        };
                        
                        // Start with main category
                        return findAndClickCategory(data.categoryMain, 1);
                    };
                    
                    // Main fill function with retry logic
                    const attemptFill = () => {
                        filledCount = 0;
                        
                        // Fill title - Vinted specific selectors
                        fillField([
                            'input[data-testid*="title"]',
                            'input[name="title"]',
                            'input[placeholder*="title" i]',
                            '#title',
                            '[data-testid*="item-title"] input',
                            'input[type="text"]:first-of-type'
                        ], data.title, 'title');
                        
                        // Fill description
                        fillField([
                            'textarea[data-testid*="description"]',
                            'textarea[name="description"]',
                            'textarea[placeholder*="description" i]',
                            '[data-testid*="item-description"] textarea',
                            'textarea:first-of-type'
                        ], data.description, 'description');
                        
                        // Fill price
                        fillField([
                            'input[data-testid*="price"]',
                            'input[name="price"]',
                            'input[type="number"][placeholder*="price" i]',
                            '[data-testid*="item-price"] input',
                            'input[type="number"]'
                        ], data.price, 'price');
                        
                        // Fill brand
                        fillBrand();
                        
                        // Fill category (try early, may need multiple clicks)
                        fillCategory();
                        
                        // Fill condition
                        fillCondition();
                        
                        // Fill size
                        fillSize();
                        
                        if (filledCount >= 4) {
                            // Toast notification handled by Vinted autofill script
                            // Note: This is in bookmarklet code, can't use showToast directly
                        } else if (retryCount < maxRetries) {
                            retryCount++;
                            setTimeout(attemptFill, 500);
                        } else {
                            // Toast notification handled by Vinted autofill script
                            // Note: This is in bookmarklet code, can't use showToast directly
                        }
                    };
                    
                    // Start filling after page loads
                    showNotification(' QuickList Autofill starting...', 'info');
                    
                    if (document.readyState === 'complete') {
                        setTimeout(() => {
                            attemptFill();
                            setTimeout(() => {
                                if (filledCount >= 4) {
                                    showNotification(' Autofill complete! ' + filledCount + ' fields filled.', 'success');
                                } else if (filledCount > 0) {
                                    showNotification(' Partially filled: ' + filledCount + ' fields. Check console for details.', 'info');
                                } else {
                                    showNotification(' Could not find form fields. Vinted may have updated their form structure.', 'error');
                                }
                            }, 3000);
                        }, 1000);
                    } else {
                        window.addEventListener('load', () => {
                            setTimeout(() => {
                                attemptFill();
                                setTimeout(() => {
                                    if (filledCount >= 4) {
                                        showNotification(' Autofill complete! ' + filledCount + ' fields filled.', 'success');
                                    } else if (filledCount > 0) {
                                        showNotification(' Partially filled: ' + filledCount + ' fields. Check console for details.', 'info');
                                    } else {
                                        showNotification(' Could not find form fields. Vinted may have updated their form structure.', 'error');
                                    }
                                }, 3000);
                            }, 1000);
                        });
                        setTimeout(() => {
                            attemptFill();
                            setTimeout(() => {
                                if (filledCount >= 4) {
                                    showNotification(' Autofill complete! ' + filledCount + ' fields filled.', 'success');
                                } else if (filledCount > 0) {
                                    showNotification(' Partially filled: ' + filledCount + ' fields. Check console for details.', 'info');
                                } else {
                                    showNotification(' Could not find form fields. Vinted may have updated their form structure.', 'error');
                                }
                            }, 3000);
                        }, 2000); // Fallback
                    }
                })();`;
            },

            // Show Vinted autofill instructions
            showVintedAutofillInstructions(script, imageCount = 0) {
                const modal = document.createElement('div');
                modal.className = 'modal active';
                
                // Escape script for HTML
                const escapedScript = script.replace(/`/g, '\\`').replace(/\${/g, '\\${');
                
                const photoInstructions = imageCount > 0 
                    ? `<div style="background: var(--accent-indigo-light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--accent-indigo);">
                        <strong style="color: var(--accent-indigo);"> Photo Upload:</strong>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                            After running the autofill script, you'll need to upload ${imageCount} photo${imageCount > 1 ? 's' : ''} manually. 
                            The script will fill all text fields, but photos must be uploaded through Vinted's photo uploader.
                        </p>
                    </div>`
                    : '';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Vinted Autofill Instructions</h2>
                            <button class="modal-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div style="padding: 1rem 0;">
                            <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                                Vinted opened in a new tab. To autofill the form:
                            </p>
                            <ol style="margin-left: 1.5rem; margin-bottom: 1.5rem; color: var(--text-secondary); line-height: 2;">
                                <li>Go to the Vinted tab that just opened</li>
                                <li>Wait for the page to fully load</li>
                                <li>Copy the script below</li>
                                <li>Paste it into your browser's address bar</li>
                                <li>Press Enter to run it</li>
                                <li>The form fields (title, description, price, brand, category, condition, size) will be filled automatically</li>
                            </ol>
                            ${photoInstructions}
                            <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <textarea 
                                    id="vintedScript" 
                                    readonly 
                                    style="width: 100%; min-height: 120px; padding: 0.75rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: monospace; font-size: 0.7rem; resize: vertical;"
                                ></textarea>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="navigator.clipboard.writeText(document.getElementById('vintedScript').value); app.showToast('Script copied! Paste into address bar on Vinted page.');">
                                    Copy Script
                                </button>
                                <a id="vintedScriptLink" class="btn btn-secondary" style="text-decoration: none; display: inline-block;" target="_blank">
                                    Open & Run Script
                                </a>
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                    Close
                                </button>
                            </div>
                            <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                                <p style="margin: 0 0 0.5rem 0; font-size: 0.875rem; color: var(--text-muted);">
                                    <strong> Tips:</strong>
                                </p>
                                <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.875rem; color: var(--text-muted); line-height: 1.8;">
                                    <li>The script will retry up to 10 times to find form fields</li>
                                    <li>If some fields aren't filled, Vinted's form structure may have changed - manually fill those fields</li>
                                    <li>Category selection may require multiple clicks - the script handles this automatically</li>
                                    <li>Check the browser console (F12) for autofill status messages</li>
                                </ul>
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                                <strong>Note:</strong> Due to browser security, we can't directly fill forms on other websites. This bookmarklet script runs on the Vinted page to fill the fields for you.
                            </p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Set script content after modal is created (avoid template literal issues)
                const textarea = document.getElementById('vintedScript');
                const link = document.getElementById('vintedScriptLink');
                if (textarea) {
                    textarea.value = script;
                }
                if (link) {
                    link.href = script;
                }
            },

            // Save listing
            async saveListing() {
                if (!this.state.currentListing) return;

                try {
                    // Get current field values
                    const listingData = {
                        title: document.getElementById('outputTitle').value,
                        brand: document.getElementById('outputBrand').value,
                        category: document.getElementById('outputCategory').value,
                        description: document.getElementById('outputDescription').value,
                        condition: document.getElementById('outputCondition').value,
                        rrp: document.getElementById('outputRRP').value,
                        price: document.getElementById('outputPrice').value,
                        keywords: this.state.currentListing.keywords,
                        sources: this.state.currentListing.sources,
                        platform: this.state.currentListing.platform,
                        images: await Promise.all(this.state.uploadedImages.map(async (img) => ({
                            data: await this.fileToBase64(img.file || img.url),
                            isBlurry: img.isBlurry
                        })))
                    };

                    const response = await fetch(`${this.apiUrl}/listings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify(listingData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save listing');
                    }

                    // Reload listings from database
                    await this.loadListingsFromDB();
                    // Clear saved edits since listing is now saved
                    this.clearSavedEdits();
                    this.showToast('Listing saved!');
                } catch (error) {
                    console.error('Save error:', error);
                    this.showToast('Failed to save listing. Please try again.', 'error');
                }
            },

            // Load listing
            loadListing(id) {
                const listing = this.state.savedListings.find(l => l.id === id);
                if (!listing) return;

                // Switch to new item view
                this.navigateToApp('newItem');

                // Load images
                this.state.uploadedImages = listing.images || [];
                this.renderImageGrid();
                this.updateGenerateButton();

                // Load platform
                document.getElementById('platformSelect').value = listing.platform || 'vinted';

                // Store as current listing
                this.state.currentListing = listing;

                // Display the listing
                this.displayListing(listing);

                // Show result state
                document.getElementById('initialState').classList.add('hidden');
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('resultState').classList.remove('hidden');
                this.setWizardPhase('review');

                this.showToast('Listing loaded!');
            },

            // Delete listing
            deleteListing(id) {
                this.state.selectedItemForDelete = id;
                document.getElementById('deleteModal').classList.add('active');
            },

            // Close delete modal
            closeDeleteModal() {
                document.getElementById('deleteModal').classList.remove('active');
                this.state.selectedItemForDelete = null;
            },

            // Confirm delete
            async confirmDelete() {
                if (!this.state.selectedItemForDelete) return;

                try {
                    const response = await fetch(`${this.apiUrl}/listings/${this.state.selectedItemForDelete}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        console.error('Delete failed:', response.status, errorData);
                        
                        if (response.status === 404) {
                            // Listing already deleted or doesn't exist - just refresh the list
                            await this.loadListingsFromDB();
                            this.renderSavedItems();
                            this.closeDeleteModal();
                            this.showToast('Listing not found - may have already been deleted');
                            return;
                        }
                        
                        if (response.status === 401) {
                            this.showToast('Session expired. Please sign in again.', 'warning');
                            this.signOut();
                            return;
                        }
                        
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }

                    // Reload listings from database
                    await this.loadListingsFromDB();
                    this.renderSavedItems();
                    this.closeDeleteModal();
                    this.showToast('Listing deleted');
                } catch (error) {
                    console.error('Delete error:', error);
                    const errorMessage = error.message || 'Failed to delete listing. Please try again.';
                    this.showToast(errorMessage, 'error');
                }
            },

            // Filter saved items
            filterSavedItems() {
                const searchTerm = (document.getElementById('savedItemsSearch')?.value || '').toLowerCase();
                const platformFilter = document.getElementById('savedItemsPlatformFilter')?.value || '';
                const sortBy = document.getElementById('savedItemsSort')?.value || 'newest';

                // Filter listings
                let filtered = this.state.savedListings.filter(listing => {
                    // Search filter
                    const matchesSearch = !searchTerm || 
                        listing.title?.toLowerCase().includes(searchTerm) ||
                        listing.brand?.toLowerCase().includes(searchTerm) ||
                        listing.category?.toLowerCase().includes(searchTerm);

                    // Platform filter
                    const matchesPlatform = !platformFilter || 
                        listing.platform?.toLowerCase() === platformFilter.toLowerCase();

                    return matchesSearch && matchesPlatform;
                });

                // Sort listings
                filtered = filtered.sort((a, b) => {
                    switch (sortBy) {
                        case 'oldest':
                            return new Date(a.created_at || 0) - new Date(b.created_at || 0);
                        case 'title':
                            return (a.title || '').localeCompare(b.title || '');
                        case 'brand':
                            return (a.brand || '').localeCompare(b.brand || '');
                        case 'newest':
                        default:
                            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                    }
                });

                this.state.filteredSavedListings = filtered;
                this.renderSavedItems();
            },

            // Clear all filters
            clearSavedItemsFilters() {
                const searchInput = document.getElementById('savedItemsSearch');
                const platformFilter = document.getElementById('savedItemsPlatformFilter');
                const sortSelect = document.getElementById('savedItemsSort');
                
                if (searchInput) searchInput.value = '';
                if (platformFilter) platformFilter.value = '';
                if (sortSelect) sortSelect.value = 'newest';
                
                this.filterSavedItems();
            },

            // Render saved items
            renderSavedItems() {
                const grid = document.getElementById('savedItemsGrid');
                const empty = document.getElementById('savedItemsEmpty');
                const noResults = document.getElementById('savedItemsNoResults');
                const countEl = document.getElementById('savedItemsCount');

                // Show loading state
                if (this.state.loadingSavedItems) {
                    grid.classList.remove('hidden');
                    empty.classList.add('hidden');
                    if (noResults) noResults.classList.add('hidden');
                    if (countEl) countEl.textContent = '';
                    grid.innerHTML = '<div class="skeleton skeleton-text-large"></div>'.repeat(3);
                    return;
                }

                // Use filtered listings if filters are active, otherwise use all listings
                const listingsToRender = this.state.filteredSavedListings.length > 0 || 
                    document.getElementById('savedItemsSearch')?.value ||
                    document.getElementById('savedItemsPlatformFilter')?.value
                    ? this.state.filteredSavedListings
                    : this.state.savedListings;

                // Update count
                if (countEl) {
                    const total = this.state.savedListings.length;
                    const showing = listingsToRender.length;
                    if (showing < total) {
                        countEl.textContent = `Showing ${showing} of ${total} items`;
                    } else {
                        countEl.textContent = total === 1 ? '1 item' : `${total} items`;
                    }
                }

                if (this.state.savedListings.length === 0) {
                    grid.classList.add('hidden');
                    empty.classList.remove('hidden');
                    if (noResults) noResults.classList.add('hidden');
                    return;
                }

                if (listingsToRender.length === 0) {
                    grid.classList.add('hidden');
                    empty.classList.add('hidden');
                    if (noResults) noResults.classList.remove('hidden');
                    return;
                }

                grid.classList.remove('hidden');
                empty.classList.add('hidden');
                if (noResults) noResults.classList.add('hidden');

                grid.innerHTML = listingsToRender.map(listing => `
                    <div class="saved-item-card">
                        <img src="${listing.images[0]?.url || ''}" alt="${listing.title || 'Listing'}" class="saved-item-image">
                        <div class="saved-item-content">
                            <div class="saved-item-title">${listing.title || 'Untitled'}</div>
                            <div class="saved-item-brand">${listing.brand || ''} ${listing.platform ? ' ' + listing.platform.charAt(0).toUpperCase() + listing.platform.slice(1) : ''}</div>
                            <div class="saved-item-actions">
                                <button class="btn btn-primary btn-small" style="flex: 1;" onclick="app.loadListing(${listing.id})" aria-label="Load listing">
                                    Load
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="app.deleteListing(${listing.id})" aria-label="Delete listing">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            renderDashboard() {
                const revenueEl = document.getElementById('statRevenue');
                const revenueTrendEl = document.getElementById('statRevenueTrend');
                const listingsEl = document.getElementById('statListings');
                const listingsTrendEl = document.getElementById('statListingsTrend');
                const messagesEl = document.getElementById('statMessages');
                const messagesTrendEl = document.getElementById('statMessagesTrend');
                const activityEl = document.getElementById('dashboardActivity');
                const tipsEl = document.getElementById('dashboardTips');

                if (!revenueEl) return;

                const activeListings = this.state.savedListings.length;
                const unreadMessages = this.state.messages.filter(m => m.unread).length;
                const estimatedRevenue = this.state.savedListings.reduce((total, listing) => {
                    const price = parseFloat((listing.price || '').replace(/[^0-9.]/g, ''));
                    return total + (isNaN(price) ? 0 : price);
                }, 0);

                revenueEl.textContent = `${estimatedRevenue.toFixed(2)}`;
                revenueTrendEl.textContent = activeListings > 0 ? `+${Math.min(99, activeListings * 4)}% vs last week` : 'Set goals for this week';
                listingsEl.textContent = activeListings;
                listingsTrendEl.textContent = activeListings > 0 ? `${activeListings} live drafts` : 'Add items to get started';
                messagesEl.textContent = unreadMessages;
                messagesTrendEl.textContent = unreadMessages === 0 ? 'Inbox clear' : `${unreadMessages} awaiting reply`;

                if (activityEl) {
                    const items = [
                        { icon: '', title: 'Queued Photos', detail: `${this.state.uploadedImages.length} items ready for AI` },
                        { icon: '', title: 'Buyer Chats', detail: `${unreadMessages} open conversations` },
                        { icon: '', title: 'Auto-download', detail: this.state.settings.autoDownloadZip ? 'ZIP auto-download enabled' : 'Enable auto-download for faster exports' }
                    ];
                    activityEl.innerHTML = items.map(item => `
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <div style="font-size: 1.5rem;">${item.icon}</div>
                            <div>
                                <strong>${item.title}</strong>
                                <p style="margin: 0; color: var(--text-muted);">${item.detail}</p>
                            </div>
                        </div>
                    `).join('');
                }

                if (tipsEl) {
                    tipsEl.innerHTML = this.state.dashboardTips.map(tip => `<li style="color: var(--text-secondary);"> ${tip}</li>`).join('');
                }
            },

            renderMessages() {
                const list = document.getElementById('messagesList');
                const empty = document.getElementById('messagesEmpty');
                if (!list) return;

                if (!this.state.messages.length) {
                    list.innerHTML = '';
                    if (empty) empty.classList.remove('hidden');
                    return;
                }

                if (empty) empty.classList.add('hidden');

                list.innerHTML = this.state.messages.map(message => {
                    const initials = message.buyer.split(' ').map(part => part[0]).join('').slice(0, 2).toUpperCase();
                    const badge = message.unread ? '<span class="badge" style="background: var(--accent-indigo);">Unread</span>' : '';
                    const quickReplies = (message.quickReplies || []).map(reply => {
                        const safeReply = reply.replace(/'/g, "\\'");
                        return `<button class="btn btn-secondary btn-small" type="button" onclick="app.sendQuickReply(${message.id}, '${safeReply}')">${reply}</button>`;
                    }).join('');
                    return `
                        <div class="message-card ${message.unread ? 'unread' : ''}">
                            <div class="message-header">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div class="message-avatar">${initials}</div>
                                    <div>
                                        <div style="font-weight: 600;">${message.buyer}</div>
                                        <div class="message-meta">${message.platform}  ${message.time}</div>
                                    </div>
                                </div>
                                ${badge}
                            </div>
                            <p style="margin: 0.75rem 0;">${message.snippet}</p>
                            <div class="message-actions">
                                ${quickReplies}
                                <button class="btn btn-secondary btn-small" type="button" onclick="app.markMessageRead(${message.id})">Mark read</button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            sendQuickReply(id, reply) {
                const message = this.state.messages.find(m => m.id === id);
                if (!message) return;
                message.unread = false;
                message.snippet = reply;
                message.time = 'Just now';
                this.vibrateDevice('success');
                this.renderMessages();
                this.updateBottomNavBadges();
                this.showToast('Reply sent!');
            },

            markMessageRead(id) {
                const message = this.state.messages.find(m => m.id === id);
                if (!message) return;
                message.unread = false;
                this.renderMessages();
                this.updateBottomNavBadges();
            },

            // Navigation
            navigateTo(view) {
                // Hide all marketing views
                document.getElementById('homeView').classList.add('hidden');
                document.getElementById('photoTipsView').classList.add('hidden');
                document.getElementById('checklistView').classList.add('hidden');
                document.getElementById('pricingView').classList.add('hidden');

                // Show selected view
                document.getElementById(view + 'View').classList.remove('hidden');

                this.state.currentView = view;
                window.scrollTo(0, 0);
            },

            navigateToApp(view) {
                this.switchAppView(view);
            },

            highlightBottomTab(view) {
                const tabs = document.querySelectorAll('.bottom-nav-tab');
                tabs.forEach(tab => {
                    const tabView = tab.getAttribute('data-view');
                    if (tabView === view) {
                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                    } else {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    }
                });
            },

            switchAppView(view) {
                const views = ['newItem', 'savedItems', 'dashboard', 'messages', 'settings'];
                views.forEach(v => {
                    const el = document.getElementById(`${v}View`);
                    if (el) {
                        el.classList.toggle('hidden', v !== view);
                    }
                });

                this.state.currentAppView = view;

                if (view === 'savedItems') {
                    this.renderSavedItems();
                } else if (view === 'dashboard') {
                    this.renderDashboard();
                } else if (view === 'messages') {
                    this.renderMessages();
                } else if (view === 'settings') {
                    this.loadSubscriptionData();
                }

                this.highlightBottomTab(view);
                window.scrollTo(0, 0);
            },

            // Authentication
            showAuthModal() {
                document.getElementById('authModal').classList.add('active');
            },

            closeAuthModal() {
                document.getElementById('authModal').classList.remove('active');
            },

            // Check Clerk authentication
            async checkClerkAuth() {
                if (!window.Clerk) return;

                try {
                    const user = window.Clerk.user;
                    if (user) {
                        // Get session token from the active session
                        const token = await window.Clerk.session?.getToken();
                        if (token) {
                            console.log('Got Clerk token, verifying with backend...');
                            // Verify with backend
                            const response = await fetch(`${this.apiUrl}/api/auth/verify`, {
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });

                            if (response.ok) {
                                const data = await response.json();
                                this.state.token = token;
                                this.state.user = data.user;
                                this.state.isAuthenticated = true;
                                localStorage.setItem('quicklist-token', token);
                                console.log('User authenticated:', this.state.user.email);
                                await this.loadListingsFromDB();
                                this.updateUI();
                            } else {
                                console.error('Backend verification failed:', response.status);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Clerk auth check error:', error);
                }
            },
            
            // Sign in with Clerk
            async signInWithClerk(provider = null) {
                if (!window.clerk) {
                    this.showToast('Clerk not initialized', 'error');
                    return;
                }
                
                try {
                    if (provider === 'google') {
                        await window.clerk.authenticateWithRedirect({
                            strategy: 'oauth_google',
                            redirectUrl: window.location.href,
                            redirectUrlComplete: window.location.href
                        });
                    } else {
                        // For email/password, Clerk handles it via modal
                        await window.clerk.openSignIn();
                    }
                } catch (error) {
                    console.error('Clerk sign in error:', error);
                    this.showToast('Failed to sign in', 'error');
                }
            },

            async signOut() {
                if (window.clerk) {
                    try {
                        await window.clerk.signOut();
                    } catch (error) {
                        console.error('Clerk sign out error:', error);
                    }
                }

                this.state.isAuthenticated = false;
                this.state.user = null;
                this.state.token = null;
                this.state.uploadedImages = [];
                this.state.currentListing = null;
                this.state.savedListings = [];
                localStorage.removeItem('quicklist-token');
                this.updateUI();
                this.showToast('Signed out successfully', 'success');
            },

            // Subscription Management
            async loadSubscriptionData() {
                if (!this.state.isAuthenticated || !this.state.token) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiUrl}/subscription/status`, {
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load subscription data');
                    }

                    const data = await response.json();

                    // Update user profile
                    const userNameEl = document.getElementById('userName');
                    const userEmailEl = document.getElementById('userEmail');
                    const userAvatarEl = document.getElementById('userAvatar');

                    if (userNameEl) userNameEl.textContent = data.user.name || 'User';
                    if (userEmailEl) userEmailEl.textContent = data.user.email;
                    if (userAvatarEl && data.user.avatarUrl) {
                        userAvatarEl.style.backgroundImage = `url(${data.user.avatarUrl})`;
                        userAvatarEl.style.backgroundSize = 'cover';
                        userAvatarEl.textContent = '';
                    } else if (userAvatarEl) {
                        userAvatarEl.textContent = (data.user.name || data.user.email)[0].toUpperCase();
                    }

                    // Update subscription info
                    const currentPlanEl = document.getElementById('currentPlan');
                    const planStatusEl = document.getElementById('planStatus');
                    const renewalDateEl = document.getElementById('renewalDate');
                    const subscriptionStatusEl = document.getElementById('subscriptionStatus');
                    const manageBillingBtn = document.getElementById('manageBillingBtn');

                    if (currentPlanEl) {
                        const planNames = {
                            free: 'Free',
                            starter: 'Starter',
                            pro: 'Pro',
                            business: 'Business'
                        };
                        currentPlanEl.textContent = planNames[data.subscription.planType] || 'Free';
                    }

                    if (planStatusEl) {
                        planStatusEl.textContent = data.subscription.status.charAt(0).toUpperCase() + data.subscription.status.slice(1);
                    }

                    if (renewalDateEl) {
                        if (data.subscription.currentPeriodEnd && data.subscription.planType !== 'free') {
                            const date = new Date(data.subscription.currentPeriodEnd);
                            renewalDateEl.textContent = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                        } else {
                            renewalDateEl.textContent = 'Never';
                        }
                    }

                    if (subscriptionStatusEl) {
                        const statusColors = {
                            active: 'var(--success)',
                            canceled: 'var(--text-muted)',
                            past_due: 'var(--warning)',
                            trialing: 'var(--accent-indigo)'
                        };
                        subscriptionStatusEl.style.background = statusColors[data.subscription.status] || 'var(--success)';
                        subscriptionStatusEl.textContent = data.subscription.status.charAt(0).toUpperCase() + data.subscription.status.slice(1);
                    }

                    // Show manage billing button if user has Stripe customer
                    if (manageBillingBtn && data.subscription.stripeCustomerId) {
                        manageBillingBtn.style.display = 'inline-block';
                    }

                    // Update usage
                    const usageCountEl = document.getElementById('usageCount');
                    const usageBarEl = document.getElementById('usageBar');
                    const usageLimitEl = document.getElementById('usageLimit');

                    if (usageCountEl) usageCountEl.textContent = data.usage.listingsCreated;
                    if (usageBarEl) usageBarEl.style.width = `${data.usage.percentage}%`;
                    if (usageLimitEl) usageLimitEl.textContent = `of ${data.usage.limit} listings used`;

                } catch (error) {
                    console.error('Error loading subscription data:', error);
                    this.showToast('Failed to load subscription data', 'error');
                }
            },

            async showUpgradeModal() {
                const modal = document.getElementById('upgradeModal');
                const plansContainer = document.getElementById('pricingPlans');

                if (!modal || !plansContainer) return;

                // Get current subscription plan
                let currentPlan = 'free';
                try {
                    const statusResponse = await fetch(`${this.apiUrl}/subscription/status`, {
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });
                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        currentPlan = statusData.subscription.planType || 'free';
                    }
                } catch (error) {
                    console.error('Error fetching current plan:', error);
                }

                // Define plans (price IDs should be set in your Stripe dashboard)
                // For now using placeholder IDs - you'll need to replace these with actual Stripe price IDs
                const plans = [
                    {
                        name: 'Starter',
                        price: '19',
                        period: 'month',
                        priceId: 'price_starter', // Replace with actual Stripe price ID
                        features: ['50 listings/month', 'All marketplaces', 'API posting', 'Cross-listing', 'Auto-delist', 'Basic analytics'],
                        current: currentPlan === 'starter'
                    },
                    {
                        name: 'Pro',
                        price: '39',
                        period: 'month',
                        priceId: 'price_pro', // Replace with actual Stripe price ID
                        features: ['200 listings/month', 'Bulk processing', 'Advanced analytics', 'Priority support', 'Export data'],
                        current: currentPlan === 'pro',
                        featured: true
                    },
                    {
                        name: 'Business',
                        price: '69',
                        period: 'month',
                        priceId: 'price_business', // Replace with actual Stripe price ID
                        features: ['1,000 listings/month', 'Cloud automation', 'Scheduled publishing', 'Template system', 'Priority support'],
                        current: currentPlan === 'business'
                    }
                ];

                plansContainer.innerHTML = plans.map(plan => `
                    <div class="card" style="${plan.featured ? 'border: 2px solid var(--accent-indigo);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0;">${plan.name}</h3>
                            ${plan.current ? '<span class="badge" style="background: var(--success);">Current</span>' : ''}
                        </div>
                        <div style="font-size: 2rem; font-weight: 600; margin-bottom: 1rem;">
                            ${plan.price}<span style="font-size: 1rem; color: var(--text-muted);">/${plan.period}</span>
                        </div>
                        <ul style="list-style: none; padding: 0; margin-bottom: 1.5rem;">
                            ${plan.features.map(f => `<li style="padding: 0.5rem 0; border-bottom: 1px solid var(--bg-secondary);"> ${f}</li>`).join('')}
                        </ul>
                        ${plan.current 
                            ? '<button class="btn btn-secondary" disabled>Current Plan</button>'
                            : `<button class="btn ${plan.featured ? 'btn-primary' : 'btn-secondary'}" onclick="app.startCheckout('${plan.priceId}', '${plan.name.toLowerCase()}')">Upgrade to ${plan.name}</button>`
                        }
                    </div>
                `).join('');

                modal.classList.remove('hidden');
            },

            closeUpgradeModal() {
                const modal = document.getElementById('upgradeModal');
                if (modal) modal.classList.add('hidden');
            },

            async startCheckout(priceId, planType) {
                if (!this.state.isAuthenticated || !this.state.token) {
                    this.showToast('Please sign in to upgrade', 'warning');
                    return;
                }

                try {
                    this.showToast('Redirecting to checkout...', 'info');

                    const response = await fetch(`${this.apiUrl}/stripe/create-checkout-session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.state.token}`
                        },
                        body: JSON.stringify({ priceId, planType })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to create checkout session');
                    }

                    const data = await response.json();
                    
                    // Redirect to Stripe Checkout
                    window.location.href = data.url;
                } catch (error) {
                    console.error('Checkout error:', error);
                    this.showToast(error.message || 'Failed to start checkout', 'error');
                }
            },

            async openBillingPortal() {
                if (!this.state.isAuthenticated || !this.state.token) {
                    this.showToast('Please sign in', 'warning');
                    return;
                }

                try {
                    const response = await fetch(`${this.apiUrl}/stripe/create-portal-session`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.state.token}`
                        }
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to create portal session');
                    }

                    const data = await response.json();
                    
                    // Redirect to Stripe Billing Portal
                    window.location.href = data.url;
                } catch (error) {
                    console.error('Billing portal error:', error);
                    this.showToast(error.message || 'Failed to open billing portal', 'error');
                }
            },

            // Update UI based on auth state
            updateUI() {
                const marketingView = document.getElementById('marketingView');
                const marketingHeader = document.getElementById('marketingHeader');
                const marketingFooter = document.getElementById('marketingFooter');
                const appView = document.getElementById('appView');
                const appHeader = document.getElementById('appHeader');

                if (!marketingView || !appView) {
                    console.warn('Required view elements not found');
                    return;
                }

                if (this.state.isAuthenticated) {
                    // Show app, hide marketing
                    marketingView.classList.add('hidden');
                    if (marketingHeader) marketingHeader.classList.add('hidden');
                    if (marketingFooter) marketingFooter.classList.add('hidden');
                    appView.classList.remove('hidden');
                    if (appHeader) appHeader.classList.remove('hidden');
                    this.navigateToApp('newItem');
                } else {
                    // Show marketing, hide app
                    marketingView.classList.remove('hidden');
                    if (marketingHeader) marketingHeader.classList.remove('hidden');
                    if (marketingFooter) marketingFooter.classList.remove('hidden');
                    appView.classList.add('hidden');
                    if (appHeader) appHeader.classList.add('hidden');
                    this.navigateTo('home');
                }

                // Update settings UI (only if element exists)
                const settingAutoDownload = document.getElementById('settingAutoDownload');
                if (settingAutoDownload) {
                    settingAutoDownload.checked = this.state.settings.autoDownloadZip;
                }
            },

            // Settings storage (local only)
            saveSettings() {
                try {
                    localStorage.setItem('quicklist-settings', JSON.stringify(this.state.settings));
                } catch (error) {
                    console.error('Error saving settings:', error);
                }
            },

            loadSettings() {
                try {
                    const data = localStorage.getItem('quicklist-settings');
                    if (data) {
                        this.state.settings = JSON.parse(data);
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            },

            // Toast notification
            showToast(message, type = 'info') {
                // Create toast element
                const toast = document.createElement('div');
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
                toast.textContent = message;
                
                // Type-based styling
                const typeStyles = {
                    success: {
                        background: 'var(--success)',
                        color: 'white',
                        icon: ''
                    },
                    error: {
                        background: 'var(--error)',
                        color: 'white',
                        icon: ''
                    },
                    warning: {
                        background: 'var(--warning)',
                        color: 'white',
                        icon: ''
                    },
                    info: {
                        background: 'var(--accent-indigo)',
                        color: 'white',
                        icon: ''
                    }
                };
                
                const style = typeStyles[type] || typeStyles.info;
                
                toast.style.cssText = `
                    position: fixed;
                    bottom: 2rem;
                    right: 2rem;
                    background: ${style.background};
                    color: ${style.color};
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    z-index: 3000;
                    animation: slideIn 0.3s ease;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    max-width: 400px;
                `;
                
                // Add icon
                const icon = document.createElement('span');
                icon.textContent = style.icon;
                icon.style.cssText = 'font-size: 1.2rem;';
                toast.insertBefore(icon, toast.firstChild);

                document.body.appendChild(toast);

                // Auto-remove after delay (longer for errors)
                const delay = type === 'error' ? 5000 : 3000;
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, delay);
            },

            // ============================================
            // MOBILE-FIRST FEATURES - PHASE 1
            // ============================================

            // Initialize bottom navigation
            initBottomNav() {
                const bottomNavTabs = document.querySelectorAll('.bottom-nav-tab');
                bottomNavTabs.forEach(tab => {
                    if (tab.dataset.bound === 'true') return;
                    tab.dataset.bound = 'true';
                    tab.addEventListener('click', (e) => {
                        const view = tab.getAttribute('data-view');
                        this.switchAppView(view);
                    });
                });

                this.updateBottomNavBadges();
                this.highlightBottomTab(this.state.currentAppView);
            },

            updateBottomNavBadges() {
                const listingsBadge = document.getElementById('listingsBadge');
                if (listingsBadge && this.state.savedListings) {
                    const count = this.state.savedListings.length;
                    if (count > 0) {
                        listingsBadge.textContent = count > 99 ? '99+' : count;
                        listingsBadge.style.display = 'flex';
                    } else {
                        listingsBadge.style.display = 'none';
                    }
                }

                const messagesBadge = document.getElementById('messagesBadge');
                if (messagesBadge && this.state.messages) {
                    const unread = this.state.messages.filter(msg => msg.unread).length;
                    if (unread > 0) {
                        messagesBadge.textContent = unread > 9 ? '9+' : unread;
                        messagesBadge.style.display = 'flex';
                    } else {
                        messagesBadge.style.display = 'none';
                    }
                }
            },

            cameraStream: null,
            currentCamera: 'environment',

            async openCamera() {
                const container = document.getElementById('cameraContainer');
                const video = document.getElementById('cameraVideo');

                try {
                    if (this.cameraStream) {
                        this.cameraStream.getTracks().forEach(track => track.stop());
                    }

                    const constraints = {
                        video: {
                            facingMode: this.currentCamera,
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    };

                    this.cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = this.cameraStream;
                    container.classList.add('active');

                    this.monitorImageQuality();
                } catch (error) {
                    console.error('Camera access error:', error);
                    this.showToast('Camera access denied', 'error');
                }
            },

            closeCamera() {
                const container = document.getElementById('cameraContainer');
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
                container.classList.remove('active');
            },

            async switchCamera() {
                this.currentCamera = this.currentCamera === 'environment' ? 'user' : 'environment';
                await this.openCamera();
            },

            capturePhoto() {
                const video = document.getElementById('cameraVideo');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                this.state.uploadedImages.push(imageData);
                this.displayImages();

                this.showMobileToast('Photo captured!', 'success');
                this.vibrateDevice('success');
                this.closeCamera();
            },

            monitorImageQuality() {
                const dots = document.querySelectorAll('.quality-dot');
                let quality = 3;

                const interval = setInterval(() => {
                    if (!this.cameraStream) {
                        clearInterval(interval);
                        return;
                    }

                    quality = Math.floor(Math.random() * 3) + 3;

                    dots.forEach((dot, index) => {
                        if (index < quality) {
                            dot.classList.add('active');
                        } else {
                            dot.classList.remove('active');
                        }
                    });

                    const hint = document.getElementById('cameraHint');
                    if (quality === 5) {
                        hint.textContent = 'Perfect! Ready to capture';
                    } else if (quality === 4) {
                        hint.textContent = 'Good lighting';
                    } else {
                        hint.textContent = 'Move to better lighting';
                    }
                }, 1000);
            },

            openGallery() {
                document.getElementById('imageUpload').click();
                this.closeCamera();
            },

            toggleFlash() {
                this.showMobileToast('Flash not supported', 'warning');
            },

            vibrateDevice(type = 'click') {
                if (!navigator.vibrate) return;

                const patterns = {
                    click: 10,
                    success: [50, 30, 50],
                    warning: [100, 50, 100, 50, 100],
                    error: 200
                };

                navigator.vibrate(patterns[type] || 10);
            },


            // Barcode Scanner Functions
            showBarcodeScanner() {
                const modal = document.getElementById('barcodeScannerModal');
                if (!modal) {
                    console.error('Barcode scanner modal not found');
                    return;
                }
            
                // Close camera if open
                this.closeCamera();
            
                // Show modal
                modal.classList.remove('hidden');
            
                // Initialize barcode scanner
                this.initBarcodeScanner();
            },
            
            closeBarcodeScanner() {
                const modal = document.getElementById('barcodeScannerModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            
                // Stop Quagga scanner
                if (typeof Quagga !== 'undefined' && Quagga.stop) {
                    Quagga.stop();
                }
            
                // Clear result display
                const resultDiv = document.getElementById('barcodeResult');
                if (resultDiv) {
                    resultDiv.textContent = '';
                }
            },
            
            initBarcodeScanner() {
                // Check if Quagga is loaded
                if (typeof Quagga === 'undefined') {
                    console.error('QuaggaJS library not loaded');
                    this.showToast('Barcode scanner not available', 'error');
                    return;
                }
            
                // Initialize QuaggaJS
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#barcodeScannerView'),
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment" // Use rear camera
                        },
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10,
                    decoder: {
                        readers: [
                            "ean_reader",        // EAN-13, EAN-8
                            "ean_8_reader",      // EAN-8
                            "upc_reader",        // UPC-A
                            "upc_e_reader",      // UPC-E
                            "code_128_reader",   // Code 128
                            "code_39_reader"     // Code 39
                        ]
                    },
                    locate: true
                }, (err) => {
                    if (err) {
                        console.error('Barcode scanner init error:', err);
                        this.showToast('Camera access denied or unavailable', 'error');
                        this.closeBarcodeScanner();
                        return;
                    }
                    console.log("Barcode scanner initialization complete");
                    Quagga.start();
                });
            
                // Handle detected barcodes
                Quagga.onDetected((data) => {
                    if (data && data.codeResult && data.codeResult.code) {
                        const barcode = data.codeResult.code;
                        console.log('Barcode detected:', barcode);
            
                        // Stop scanning
                        Quagga.stop();
            
                        // Display result
                        const resultDiv = document.getElementById('barcodeResult');
                        if (resultDiv) {
                            resultDiv.textContent = `Barcode: ${barcode} - Looking up product...`;
                        }
            
                        // Vibrate on success
                        this.vibrateDevice('success');
            
                        // Process barcode
                        this.processBarcodeResult(barcode);
                    }
                });
            
                // Optional: Draw boxes around detected barcodes
                Quagga.onProcessed((result) => {
                    const drawingCtx = Quagga.canvas.ctx.overlay;
                    const drawingCanvas = Quagga.canvas.dom.overlay;
            
                    if (result) {
                        if (result.boxes) {
                            drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                            result.boxes.filter((box) => {
                                return box !== result.box;
                            }).forEach((box) => {
                                Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
                            });
                        }
            
                        if (result.box) {
                            Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
                        }
            
                        if (result.codeResult && result.codeResult.code) {
                            Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: 'red', lineWidth: 3 });
                        }
                    }
                });
            },
            
            async processBarcodeResult(barcode) {
                console.log('Processing barcode:', barcode);
                this.showToast('Barcode detected! Looking up product...', 'info');
            
                try {
                    // Get the auth token
                    const token = await this.getAuthToken();
                    if (!token) {
                        throw new Error('Not authenticated');
                    }
            
                    const response = await fetch(`${this.apiUrl}/api/lookup-barcode`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ barcode })
                    });
            
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Barcode lookup failed');
                    }
            
                    const productData = await response.json();
                    console.log('Product data:', productData);
            
                    if (productData.found) {
                        this.showToast('Product found! Details pre-filled.', 'success');
                        this.prefillListingFromBarcode(productData);
                        this.closeBarcodeScanner();
                    } else {
                        this.showToast('Product not found in database. Try manual entry.', 'warning');
                        const resultDiv = document.getElementById('barcodeResult');
                        if (resultDiv) {
                            resultDiv.textContent = `Barcode: ${barcode} - Not found`;
                        }
                    }
                } catch (error) {
                    console.error('Barcode lookup error:', error);
                    this.showToast('Barcode lookup failed: ' + error.message, 'error');
                }
            },
            
            prefillListingFromBarcode(productData) {
                console.log('Pre-filling listing with:', productData);
            
                // Store product data for reference
                this.state.barcodeProductData = productData;
            
                // Create a generated listing object from barcode data
                const generatedListing = {
                    title: productData.title || '',
                    brand: productData.brand || '',
                    category: productData.category || '',
                    description: this.generateDescriptionFromProduct(productData),
                    condition: 'Good', // Default condition for used items
                    rrp: productData.rrp || productData.msrp || '',
                    price: this.calculateUsedPrice(productData.rrp || productData.msrp || ''),
                    keywords: this.extractKeywordsFromProduct(productData),
                    sources: productData.source ? [{ url: `Barcode: ${productData.barcode}`, title: `Source: ${productData.source}` }] : [],
                    fromBarcode: true
                };
            
                // Store in state
                this.state.generatedListing = generatedListing;
            
                // Display the listing
                this.displayListing(generatedListing);
            
                // Show a special indicator that this was from barcode
                const listingContainer = document.querySelector('.listing-container');
                if (listingContainer) {
                    // Add a badge or indicator
                    const badge = document.createElement('div');
                    badge.className = 'barcode-badge';
                    badge.style.cssText = 'background: var(--indigo-500); color: white; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; text-align: center;';
                    badge.textContent = ` Scanned from barcode: ${productData.barcode}`;
                    listingContainer.insertBefore(badge, listingContainer.firstChild);
                }
            },
            
            generateDescriptionFromProduct(product) {
                let desc = product.description || '';
            
                // Add specifications if available
                if (product.specifications) {
                    desc += '\n\nSpecifications:\n';
                    Object.entries(product.specifications).forEach(([key, value]) => {
                        if (value && value !== 'N/A') {
                            desc += ` ${key}: ${value}\n`;
                        }
                    });
                }
            
                // Add condition note
                if (!desc.includes('Condition:')) {
                    desc += '\n\nCondition: Please see photos for actual item condition.';
                }
            
                return desc.trim();
            },
            
            calculateUsedPrice(rrp) {
                if (!rrp) return '';
            
                // Extract numeric value from price string
                const rrpNum = parseFloat(rrp.replace(/[^0-9.]/g, ''));
                if (isNaN(rrpNum)) return '';
            
                // Used items typically sell for 40-70% of RRP
                const usedMultiplier = 0.55; // 55% of RRP as default
                const usedPrice = (rrpNum * usedMultiplier).toFixed(2);
            
                // Return with appropriate currency symbol
                if (rrp.includes('')) return `${usedPrice}`;
                if (rrp.includes('$')) return `$${usedPrice}`;
                if (rrp.includes('')) return `${usedPrice}`;
            
                return `${usedPrice}`; // Default to pounds
            },
            
            extractKeywordsFromProduct(product) {
                const keywords = [];
            
                // Add brand
                if (product.brand) {
                    keywords.push(product.brand.toLowerCase());
                }
            
                // Extract keywords from title
                if (product.title) {
                    const titleWords = product.title.toLowerCase().split(/\s+/);
                    titleWords.forEach(word => {
                        if (word.length > 3 && !keywords.includes(word)) {
                            keywords.push(word);
                        }
                    });
                }
            
                // Add category keywords
                if (product.category) {
                    const categoryWords = product.category.toLowerCase().split(/[\s,/]+/);
                    categoryWords.forEach(word => {
                        if (word.length > 3 && !keywords.includes(word)) {
                            keywords.push(word);
                        }
                    });
                }
            
                // Add barcode as keyword
                if (product.barcode) {
                    keywords.push(product.barcode);
                }
            
                // Limit to 15 keywords
                return keywords.slice(0, 15);
            },
            
            manualBarcodeEntry() {
                const barcode = prompt('Enter barcode number (UPC or EAN):');
                if (barcode && barcode.length >= 8) {
                    this.processBarcodeResult(barcode);
                } else if (barcode) {
                    this.showToast('Invalid barcode format. Must be at least 8 digits.', 'error');
                }
            },            showMobileToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const icon = document.getElementById('toastIcon');
                const msg = document.getElementById('toastMessage');

                msg.textContent = message;

                const icons = {
                    success: '',
                    error: '',
                    warning: '',
                    info: ''
                };

                icon.textContent = icons[type] || icons.info;

                toast.classList.remove('success', 'error', 'warning', 'info');
                toast.classList.add(type);
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, type === 'error' ? 5000 : 3000);
            },

            initSwipeableCards() {
                const cards = document.querySelectorAll('.swipeable-card');

                cards.forEach(card => {
                    let startX = 0;
                    let currentX = 0;
                    let isDragging = false;

                    const content = card.querySelector('.swipeable-card-content');

                    card.addEventListener('touchstart', (e) => {
                        startX = e.touches[0].clientX;
                        isDragging = true;
                        content.style.transition = 'none';
                    });

                    card.addEventListener('touchmove', (e) => {
                        if (!isDragging) return;

                        currentX = e.touches[0].clientX;
                        const diff = currentX - startX;
                        const maxSwipe = 100;
                        const limitedDiff = Math.max(-maxSwipe, Math.min(maxSwipe, diff));

                        content.style.transform = `translateX(${limitedDiff}px)`;
                    });

                    card.addEventListener('touchend', () => {
                        if (!isDragging) return;
                        isDragging = false;

                        const diff = currentX - startX;
                        content.style.transition = 'transform 0.3s ease-out';

                        if (diff > 80) {
                            this.handleSwipeAction(card, 'sold');
                        } else if (diff < -80) {
                            this.handleSwipeAction(card, 'edit');
                        }

                        content.style.transform = 'translateX(0)';
                    });
                });
            },

            handleSwipeAction(card, action) {
                const listingId = card.getAttribute('data-listing-id');

                if (action === 'edit') {
                    this.vibrateDevice('click');
                    this.loadListing(listingId);
                } else if (action === 'sold') {
                    this.vibrateDevice('success');
                    this.confirmDeleteListing(listingId);
                }
            },

            initCollapsibleSections() {
                const sections = document.querySelectorAll('.collapsible-section');

                sections.forEach(section => {
                    const header = section.querySelector('.collapsible-header');
                    if (!header) return;

                    const toggle = () => {
                        this.vibrateDevice('click');
                        const expanded = section.classList.toggle('expanded');
                        header.setAttribute('aria-expanded', expanded);
                    };

                    if (!header.hasAttribute('tabindex')) {
                        header.setAttribute('tabindex', '0');
                    }
                    header.setAttribute('aria-expanded', section.classList.contains('expanded'));

                    header.addEventListener('click', toggle);
                    header.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            toggle();
                        }
                    });
                });
            },

            isMobile() {
                return window.innerWidth < 768;
            },

            initMobileFeatures() {
                this.initCollapsibleSections();

                if (this.isMobile()) {
                    this.initBottomNav();
                    this.initSwipeableCards();

                    const appView = document.getElementById('appView');
                    if (appView) {
                        appView.classList.add('app-with-bottom-nav');
                    }
                }

                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        if (this.isMobile()) {
                            this.initBottomNav();
                        }
                    }, 250);
                });
            }
        };

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateY(100px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(100px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>

    <!-- Bottom Tab Navigation (Mobile Only) -->
    <nav class="bottom-nav" id="bottomNav" role="navigation" aria-label="Mobile navigation">
        <div class="bottom-nav-tabs">
            <button class="bottom-nav-tab active" data-view="newItem" role="tab" aria-selected="true" aria-label="Scan new item">
                <div class="bottom-nav-icon"></div>
                <div class="bottom-nav-label">Scan</div>
            </button>
            <button class="bottom-nav-tab" data-view="savedItems" role="tab" aria-selected="false" aria-label="View saved listings">
                <div class="bottom-nav-icon"></div>
                <div class="bottom-nav-label">Listings</div>
                <span class="bottom-nav-badge" id="listingsBadge" style="display: none;">0</span>
            </button>
            <button class="bottom-nav-tab" data-view="dashboard" role="tab" aria-selected="false" aria-label="View dashboard">
                <div class="bottom-nav-icon"></div>
                <div class="bottom-nav-label">Dashboard</div>
            </button>
            <button class="bottom-nav-tab" data-view="messages" role="tab" aria-selected="false" aria-label="View messages">
                <div class="bottom-nav-icon"></div>
                <div class="bottom-nav-label">Messages</div>
                <span class="bottom-nav-badge" id="messagesBadge" style="display: none;">0</span>
            </button>
            <button class="bottom-nav-tab" data-view="settings" role="tab" aria-selected="false" aria-label="View settings">
                <div class="bottom-nav-icon"></div>
                <div class="bottom-nav-label">Profile</div>
            </button>
        </div>
    </nav>

    <!-- Mobile Camera Interface -->
    <div class="camera-container" id="cameraContainer" role="dialog" aria-label="Camera interface">
        <div class="camera-controls-top">
            <button class="btn-secondary" onclick="app.closeCamera()" aria-label="Close camera"> Close</button>
            <button class="btn-secondary" onclick="app.switchCamera()" aria-label="Switch camera"> Flip</button>
        </div>
        <div class="camera-viewport">
            <video class="camera-video" id="cameraVideo" autoplay playsinline></video>
            <div class="camera-overlay"></div>
            <div class="camera-hint" id="cameraHint">Center your item in the frame</div>
            <div class="camera-quality-indicator" id="qualityIndicator">
                <div class="quality-dot"></div>
                <div class="quality-dot"></div>
                <div class="quality-dot"></div>
                <div class="quality-dot"></div>
                <div class="quality-dot"></div>
            </div>
        </div>
        <div class="camera-controls-bottom">
            <button class="btn-secondary" onclick="app.openGallery()" aria-label="Open gallery"> Gallery</button>
            <button class="btn-secondary" onclick="app.showBarcodeScanner()" aria-label="Scan barcode"> Scan</button>
            <button class="camera-capture-btn" onclick="app.capturePhoto()" aria-label="Capture photo"></button>
            <button class="btn-secondary" onclick="app.toggleFlash()" aria-label="Toggle flash"> Flash</button>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="barcodeScannerModal" class="modal hidden">
        <div class="modal-content scanner-modal" style="max-width: 500px;">
            <div class="scanner-header">
                <h3>Scan Product Barcode</h3>
                <button class="btn-close" onclick="app.closeBarcodeScanner()"></button>
            </div>

            <div id="barcodeScannerView" class="scanner-viewport" style="position: relative; width: 100%; height: 400px; background: #000;">
                <!-- Quagga will render the camera feed here -->
                <div class="scanner-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 100px; border: 2px solid var(--indigo-500); border-radius: 8px; opacity: 0.5;"></div>
                <div class="scanner-line" style="position: absolute; top: 50%; left: 10%; width: 80%; height: 2px; background: var(--indigo-500); animation: scan 2s infinite;"></div>
            </div>

            <div class="scanner-instructions" style="text-align: center; padding: 1rem;">
                <p>Position barcode within the frame</p>
                <p class="help-text" style="color: var(--text-secondary); font-size: 0.9rem;">Works with UPC, EAN, Code128, Code39</p>
                <div id="barcodeResult" style="margin-top: 1rem; font-weight: bold; color: var(--indigo-500);"></div>
            </div>

            <div class="scanner-actions" style="display: flex; gap: 1rem; padding: 1rem;">
                <button class="btn btn-secondary" onclick="app.manualBarcodeEntry()" style="flex: 1;">Enter Manually</button>
                <button class="btn btn-primary" onclick="app.closeBarcodeScanner()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast" role="alert" aria-live="polite">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-message" id="toastMessage">Success!</div>
    </div>

</body>
</html>
